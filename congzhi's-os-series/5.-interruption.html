<!DOCTYPE html> <html><head>
		<title>5. Interruption</title>
		<base href="../">
		<meta id="root-path" root-path="../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="Congzhi's Notes Vault - 5. Interruption">
		<meta property="og:title" content="5. Interruption">
		<meta property="og:description" content="Congzhi's Notes Vault - 5. Interruption">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://congzhi.wiki/congzhi's-os-series/5.-interruption.html">
		<meta property="og:image" content="https://congzhi.wiki/congzhi's-os-series/pics/pasted-image-20250127044801.png">
		<meta property="og:site_name" content="Congzhi's Notes Vault">
		<meta name="author" content="Congzhi"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://congzhi.wiki/lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="https://cdn.jsdelivr.net/npm/minisearch@6.3.0/dist/umd/index.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles">mjx-msqrt{display:inline-block;text-align:left}mjx-root{display:inline-block;white-space:nowrap}mjx-surd{display:inline-block;vertical-align:top}mjx-sqrt{display:inline-block;padding-top:.07em}mjx-sqrt>mjx-box{border-top:.07em solid}mjx-sqrt.mjx-tall>mjx-box{padding-left:.3em;margin-left:-.3em}mjx-c.mjx-c221A::before{padding:.8em .853em .2em 0;content:"√"}mjx-c.mjx-c2061::before{padding:0;content:""}mjx-c.mjx-c1D442.TEX-I::before{padding:.704em .763em .022em 0;content:"O"}mjx-c.mjx-c4B::before{padding:.683em .778em 0 0;content:"K"}mjx-c.mjx-c46::before{padding:.68em .653em 0 0;content:"F"}mjx-c.mjx-c7A::before{padding:.431em .444em 0 0;content:"z"}mjx-c.mjx-cD7::before{padding:.491em .778em 0 0;content:"×"}mjx-c.mjx-c4D::before{padding:.683em .917em 0 0;content:"M"}mjx-c.mjx-c1D43A.TEX-I::before{padding:.705em .786em .022em 0;content:"G"}mjx-c.mjx-c70::before{padding:.442em .556em .194em 0;content:"p"}mjx-c.mjx-cB1::before{padding:.666em .778em 0 0;content:"±"}mjx-c.mjx-c5F::before{padding:0 .5em .062em 0;content:"_"}mjx-mtable{display:inline-block;text-align:center;vertical-align:.25em;position:relative;box-sizing:border-box;border-spacing:0px;border-collapse:collapse}mjx-mstyle[size="s"] mjx-mtable{vertical-align:.354em}mjx-labels{position:absolute;left:0;top:0}mjx-table{display:inline-block;vertical-align:-.5ex;box-sizing:border-box}mjx-table>mjx-itable{vertical-align:middle;text-align:left;box-sizing:border-box}mjx-labels>mjx-itable{position:absolute;top:0}mjx-mtable[justify=left]{text-align:left}mjx-mtable[justify=right]{text-align:right}mjx-mtable[justify=left][side=left]{padding-right:0!important}mjx-mtable[justify=left][side=right]{padding-left:0!important}mjx-mtable[justify=right][side=left]{padding-right:0!important}mjx-mtable[justify=right][side=right]{padding-left:0!important}mjx-mtable[align]{vertical-align:baseline}mjx-mtable[align=top]>mjx-table{vertical-align:top}mjx-mtable[align=bottom]>mjx-table{vertical-align:bottom}mjx-mtable[side=right] mjx-labels{min-width:100%}mjx-mtr{display:table-row;text-align:left}mjx-mtr[rowalign=top]>mjx-mtd{vertical-align:top}mjx-mtr[rowalign=center]>mjx-mtd{vertical-align:middle}mjx-mtr[rowalign=bottom]>mjx-mtd{vertical-align:bottom}mjx-mtr[rowalign=baseline]>mjx-mtd{vertical-align:baseline}mjx-mtr[rowalign=axis]>mjx-mtd{vertical-align:.25em}mjx-mtd{display:table-cell;text-align:center;padding:.215em .4em}mjx-mtd:first-child{padding-left:0}mjx-mtd:last-child{padding-right:0}mjx-mtable>*>mjx-itable>:first-child>mjx-mtd{padding-top:0}mjx-mtable>*>mjx-itable>:last-child>mjx-mtd{padding-bottom:0}mjx-tstrut{display:inline-block;height:1em;vertical-align:-.25em}mjx-labels[align=left]>mjx-mtr>mjx-mtd{text-align:left}mjx-labels[align=right]>mjx-mtr>mjx-mtd{text-align:right}mjx-mtd[extra]{padding:0}mjx-mtd[rowalign=top]{vertical-align:top}mjx-mtd[rowalign=center]{vertical-align:middle}mjx-mtd[rowalign=bottom]{vertical-align:bottom}mjx-mtd[rowalign=baseline]{vertical-align:baseline}mjx-mtd[rowalign=axis]{vertical-align:.25em}mjx-stretchy-v.mjx-c5B mjx-beg mjx-c::before{content:"⎡";padding:1.154em .667em .645em 0}mjx-stretchy-v.mjx-c5B mjx-ext mjx-c::before{content:"⎢";width:.667em}mjx-stretchy-v.mjx-c5B mjx-end mjx-c::before{content:"⎣";padding:1.155em .667em .644em 0}mjx-stretchy-v.mjx-c5B>mjx-end{margin-top:-1.799em}mjx-stretchy-v.mjx-c5B>mjx-ext{border-top-width:1.769em;border-bottom-width:1.769em}mjx-stretchy-v.mjx-c5D mjx-beg mjx-c::before{content:"⎤";padding:1.154em .667em .645em 0}mjx-stretchy-v.mjx-c5D mjx-ext mjx-c::before{content:"⎥";width:.667em}mjx-stretchy-v.mjx-c5D mjx-end mjx-c::before{content:"⎦";padding:1.155em .667em .644em 0}mjx-stretchy-v.mjx-c5D>mjx-end{margin-top:-1.799em}mjx-stretchy-v.mjx-c5D>mjx-ext{border-top-width:1.769em;border-bottom-width:1.769em}mjx-c.mjx-c1D703.TEX-I::before{padding:.705em .469em .01em 0;content:"θ"}mjx-c.mjx-c1D434.TEX-I::before{padding:.716em .75em 0 0;content:"A"}mjx-c.mjx-c5B::before{padding:.75em .278em .25em 0;content:"["}mjx-c.mjx-c5D::before{padding:.75em .278em .25em 0;content:"]"}mjx-c.mjx-c22EF::before{padding:.31em 1.172em 0 0;content:"⋯"}mjx-c.mjx-c22EE::before{padding:1.3em .278em .03em 0;content:"⋮"}mjx-c.mjx-c22F1::before{padding:1.52em 1.282em 0 0;content:"⋱"}mjx-c.mjx-c1D44A.TEX-I::before{padding:.683em 1.048em .022em 0;content:"W"}mjx-c.mjx-c1D444.TEX-I::before{padding:.704em .791em .194em 0;content:"Q"}mjx-c.mjx-c3E::before{padding:.54em .778em .04em 0;content:">"}mjx-c.mjx-c1D70F.TEX-I::before{padding:.431em .517em .013em 0;content:"τ"}mjx-c.mjx-c1D458.TEX-I::before{padding:.694em .521em .011em 0;content:"k"}mjx-c.mjx-c2211.TEX-S2::before{padding:.95em 1.444em .45em 0;content:"∑"}mjx-c.mjx-c3C::before{padding:.54em .778em .04em 0;content:"<"}mjx-c.mjx-c44::before{padding:.683em .764em 0 0;content:"D"}mjx-c.mjx-c20::before{padding:0 .25em 0 0;content:" "}mjx-c.mjx-c6D::before{padding:.442em .833em 0 0;content:"m"}mjx-c.mjx-c2D::before{padding:.252em .333em 0 0;content:"-"}mjx-c.mjx-c75::before{padding:.442em .556em .011em 0;content:"u"}mjx-c.mjx-c6B::before{padding:.694em .528em 0 0;content:"k"}mjx-c.mjx-c52::before{padding:.683em .736em .022em 0;content:"R"}mjx-c.mjx-c67::before{padding:.453em .5em .206em 0;content:"g"}mjx-c.mjx-c45::before{padding:.68em .681em 0 0;content:"E"}mjx-c.mjx-c78::before{padding:.431em .528em 0 0;content:"x"}mjx-c.mjx-c220F.TEX-S2::before{padding:.95em 1.278em .45em 0;content:"∏"}mjx-c.mjx-c2264::before{padding:.636em .778em .138em 0;content:"≤"}mjx-c.mjx-c1D457.TEX-I::before{padding:.661em .412em .204em 0;content:"j"}mjx-c.mjx-c1D435.TEX-I::before{padding:.683em .759em 0 0;content:"B"}mjx-c.mjx-c47::before{padding:.705em .785em .022em 0;content:"G"}mjx-c.mjx-c4C::before{padding:.683em .625em 0 0;content:"L"}mjx-c.mjx-c42::before{padding:.683em .708em 0 0;content:"B"}mjx-c.mjx-c41::before{padding:.716em .75em 0 0;content:"A"}mjx-c.mjx-c43::before{padding:.705em .722em .021em 0;content:"C"}mjx-c.mjx-c79::before{padding:.431em .528em .204em 0;content:"y"}mjx-c.mjx-c6C::before{padding:.694em .278em 0 0;content:"l"}mjx-c.mjx-c69::before{padding:.669em .278em 0 0;content:"i"}mjx-c.mjx-c6E::before{padding:.442em .556em 0 0;content:"n"}mjx-c.mjx-c64::before{padding:.694em .556em .011em 0;content:"d"}mjx-c.mjx-c65::before{padding:.448em .444em .011em 0;content:"e"}mjx-c.mjx-c72::before{padding:.442em .392em 0 0;content:"r"}mjx-c.mjx-c4E::before{padding:.683em .75em 0 0;content:"N"}mjx-c.mjx-c68::before{padding:.694em .556em 0 0;content:"h"}mjx-c.mjx-c61::before{padding:.448em .5em .011em 0;content:"a"}mjx-c.mjx-c48::before{padding:.683em .75em 0 0;content:"H"}mjx-c.mjx-c63::before{padding:.448em .444em .011em 0;content:"c"}mjx-c.mjx-c74::before{padding:.615em .389em .01em 0;content:"t"}mjx-c.mjx-c6F::before{padding:.448em .5em .01em 0;content:"o"}mjx-c.mjx-c53::before{padding:.705em .556em .022em 0;content:"S"}mjx-c.mjx-c54::before{padding:.677em .722em 0 0;content:"T"}mjx-c.mjx-c5A::before{padding:.683em .611em 0 0;content:"Z"}mjx-msup{display:inline-block;text-align:left}mjx-c.mjx-c38::before{padding:.666em .5em .022em 0;content:"8"}mjx-c.mjx-c39::before{padding:.666em .5em .022em 0;content:"9"}mjx-c.mjx-c73::before{padding:.448em .394em .011em 0;content:"s"}mjx-c.mjx-c1D448.TEX-I::before{padding:.683em .767em .022em 0;content:"U"}mjx-c.mjx-c37::before{padding:.676em .5em .022em 0;content:"7"}mjx-c.mjx-c1D438.TEX-I::before{padding:.68em .764em 0 0;content:"E"}mjx-c.mjx-c1D6FC.TEX-I::before{padding:.442em .64em .011em 0;content:"α"}mjx-c.mjx-c1D463.TEX-I::before{padding:.443em .485em .011em 0;content:"v"}mjx-c.mjx-c1D6FD.TEX-I::before{padding:.705em .566em .194em 0;content:"β"}mjx-c.mjx-c7C::before{padding:.75em .278em .249em 0;content:"|"}mjx-c.mjx-c1D43C.TEX-I::before{padding:.683em .504em 0 0;content:"I"}mjx-mtext{display:inline-block;text-align:left}mjx-mfrac{display:inline-block;text-align:left}mjx-frac{display:inline-block;vertical-align:.17em;padding:0 .22em}mjx-frac[type="d"]{vertical-align:.04em}mjx-frac[delims]{padding:0 .1em}mjx-frac[atop]{padding:0 .12em}mjx-frac[atop][delims]{padding:0}mjx-dtable{display:inline-table;width:100%}mjx-dtable>*{font-size:2000%}mjx-dbox{display:block;font-size:5%}mjx-num{display:block;text-align:center}mjx-den{display:block;text-align:center}mjx-mfrac[bevelled]>mjx-num{display:inline-block}mjx-mfrac[bevelled]>mjx-den{display:inline-block}mjx-den[align=right],mjx-num[align=right]{text-align:right}mjx-den[align=left],mjx-num[align=left]{text-align:left}mjx-nstrut{display:inline-block;height:.054em;width:0;vertical-align:-.054em}mjx-nstrut[type="d"]{height:.217em;vertical-align:-.217em}mjx-dstrut{display:inline-block;height:.505em;width:0}mjx-dstrut[type="d"]{height:.726em}mjx-line{display:block;box-sizing:border-box;min-height:1px;height:.06em;border-top:.06em solid;margin:.06em -.1em;overflow:hidden}mjx-line[type="d"]{margin:.18em -.1em}mjx-mrow{display:inline-block;text-align:left}mjx-munderover{display:inline-block;text-align:left}mjx-munderover:not([limits=false]){padding-top:.1em}mjx-munderover:not([limits=false])>*{display:block}mjx-msubsup{display:inline-block;text-align:left}mjx-script{display:inline-block;padding-right:.05em;padding-left:.033em}mjx-script>mjx-spacer{display:block}mjx-c.mjx-c210E.TEX-I::before{padding:.694em .576em .011em 0;content:"h"}mjx-c.mjx-c3A::before{padding:.43em .278em 0 0;content:":"}mjx-c.mjx-c1D464.TEX-I::before{padding:.443em .716em .011em 0;content:"w"}mjx-c.mjx-c1D45A.TEX-I::before{padding:.442em .878em .011em 0;content:"m"}mjx-c.mjx-c1D446.TEX-I::before{padding:.705em .645em .022em 0;content:"S"}mjx-c.mjx-c1D454.TEX-I::before{padding:.442em .477em .205em 0;content:"g"}mjx-c.mjx-c1D453.TEX-I::before{padding:.705em .55em .205em 0;content:"f"}mjx-c.mjx-c1D465.TEX-I::before{padding:.442em .572em .011em 0;content:"x"}mjx-c.mjx-c2217::before{padding:.465em .5em 0 0;content:"∗"}mjx-c.mjx-c1D447.TEX-I::before{padding:.677em .704em 0 0;content:"T"}mjx-c.mjx-cA0::before{padding:0 .25em 0 0;content:" "}mjx-c.mjx-c34::before{padding:.677em .5em 0 0;content:"4"}mjx-c.mjx-c36::before{padding:.666em .5em .022em 0;content:"6"}mjx-c.mjx-c2248::before{padding:.483em .778em 0 0;content:"≈"}mjx-c.mjx-c1D449.TEX-I::before{padding:.683em .769em .022em 0;content:"V"}mjx-c.mjx-c1D43F.TEX-I::before{padding:.683em .681em 0 0;content:"L"}mjx-c.mjx-c1D436.TEX-I::before{padding:.705em .76em .022em 0;content:"C"}mjx-c.mjx-c2265::before{padding:.636em .778em .138em 0;content:"≥"}mjx-c.mjx-c7B::before{padding:.75em .5em .25em 0;content:"{"}mjx-c.mjx-c7D::before{padding:.75em .5em .25em 0;content:"}"}mjx-c.mjx-c1D443.TEX-I::before{padding:.683em .751em 0 0;content:"P"}mjx-c.mjx-c2211.TEX-S1::before{padding:.75em 1.056em .25em 0;content:"∑"}mjx-container[jax=CHTML]{line-height:0}mjx-container [space="1"]{margin-left:.111em}mjx-container [space="2"]{margin-left:.167em}mjx-container [space="3"]{margin-left:.222em}mjx-container [space="4"]{margin-left:.278em}mjx-container [space="5"]{margin-left:.333em}mjx-container [rspace="1"]{margin-right:.111em}mjx-container [rspace="2"]{margin-right:.167em}mjx-container [rspace="3"]{margin-right:.222em}mjx-container [rspace="4"]{margin-right:.278em}mjx-container [rspace="5"]{margin-right:.333em}mjx-container [size="s"]{font-size:70.7%}mjx-container [size=ss]{font-size:50%}mjx-container [size=Tn]{font-size:60%}mjx-container [size=sm]{font-size:85%}mjx-container [size=lg]{font-size:120%}mjx-container [size=Lg]{font-size:144%}mjx-container [size=LG]{font-size:173%}mjx-container [size=hg]{font-size:207%}mjx-container [size=HG]{font-size:249%}mjx-container [width=full]{width:100%}mjx-box{display:inline-block}mjx-block{display:block}mjx-itable{display:inline-table}mjx-row{display:table-row}mjx-row>*{display:table-cell}mjx-mtext{display:inline-block}mjx-mstyle{display:inline-block}mjx-merror{display:inline-block;color:red;background-color:#ff0}mjx-mphantom{visibility:hidden}mjx-assistive-mml{top:0;left:0;clip:rect(1px,1px,1px,1px);user-select:none;position:absolute!important;padding:1px 0 0!important;border:0!important;display:block!important;width:auto!important;overflow:hidden!important}mjx-assistive-mml[display=block]{width:100%!important}mjx-math{display:inline-block;text-align:left;line-height:0;text-indent:0;font-style:normal;font-weight:400;font-size:100%;letter-spacing:normal;border-collapse:collapse;overflow-wrap:normal;word-spacing:normal;white-space:nowrap;direction:ltr;padding:1px 0}mjx-container[jax=CHTML][display=true]{display:block;text-align:center;margin:1em 0}mjx-container[jax=CHTML][display=true][width=full]{display:flex}mjx-container[jax=CHTML][display=true] mjx-math{padding:0}mjx-container[jax=CHTML][justify=left]{text-align:left}mjx-container[jax=CHTML][justify=right]{text-align:right}mjx-mi{display:inline-block;text-align:left}mjx-c{display:inline-block}mjx-utext{display:inline-block;padding:.75em 0 .2em}mjx-msub{display:inline-block;text-align:left}mjx-texatom{display:inline-block;text-align:left}mjx-mo{display:inline-block;text-align:left}mjx-stretchy-h{display:inline-table;width:100%}mjx-stretchy-h>*{display:table-cell;width:0}mjx-stretchy-h>*>mjx-c{display:inline-block;transform:scaleX(1)}mjx-stretchy-h>*>mjx-c::before{display:inline-block;width:initial}mjx-stretchy-h>mjx-ext{overflow:clip visible;width:100%}mjx-stretchy-h>mjx-ext>mjx-c::before{transform:scaleX(500)}mjx-stretchy-h>mjx-ext>mjx-c{width:0}mjx-stretchy-h>mjx-beg>mjx-c{margin-right:-.1em}mjx-stretchy-h>mjx-end>mjx-c{margin-left:-.1em}mjx-stretchy-v{display:inline-block}mjx-stretchy-v>*{display:block}mjx-stretchy-v>mjx-beg{height:0}mjx-stretchy-v>mjx-end>mjx-c{display:block}mjx-stretchy-v>*>mjx-c{transform:scaleY(1);transform-origin:left center;overflow:hidden}mjx-stretchy-v>mjx-ext{display:block;height:100%;box-sizing:border-box;border:0 solid transparent;overflow:visible clip}mjx-stretchy-v>mjx-ext>mjx-c::before{width:initial;box-sizing:border-box}mjx-stretchy-v>mjx-ext>mjx-c{transform:scaleY(500) translateY(.075em);overflow:visible}mjx-mark{display:inline-block;height:0}mjx-mn{display:inline-block;text-align:left}mjx-c::before{display:block;width:0}.MJX-TEX{font-family:MJXZERO,MJXTEX}.TEX-B{font-family:MJXZERO,MJXTEX-B}.TEX-I{font-family:MJXZERO,MJXTEX-I}.TEX-MI{font-family:MJXZERO,MJXTEX-MI}.TEX-BI{font-family:MJXZERO,MJXTEX-BI}.TEX-S1{font-family:MJXZERO,MJXTEX-S1}.TEX-S2{font-family:MJXZERO,MJXTEX-S2}.TEX-S3{font-family:MJXZERO,MJXTEX-S3}.TEX-S4{font-family:MJXZERO,MJXTEX-S4}.TEX-A{font-family:MJXZERO,MJXTEX-A}.TEX-C{font-family:MJXZERO,MJXTEX-C}.TEX-CB{font-family:MJXZERO,MJXTEX-CB}.TEX-FR{font-family:MJXZERO,MJXTEX-FR}.TEX-FRB{font-family:MJXZERO,MJXTEX-FRB}.TEX-SS{font-family:MJXZERO,MJXTEX-SS}.TEX-SSB{font-family:MJXZERO,MJXTEX-SSB}.TEX-SSI{font-family:MJXZERO,MJXTEX-SSI}.TEX-SC{font-family:MJXZERO,MJXTEX-SC}.TEX-T{font-family:MJXZERO,MJXTEX-T}.TEX-V{font-family:MJXZERO,MJXTEX-V}.TEX-VB{font-family:MJXZERO,MJXTEX-VB}mjx-stretchy-h mjx-c,mjx-stretchy-v mjx-c{font-family:MJXZERO,MJXTEX-S1,MJXTEX-S4,MJXTEX,MJXTEX-A!important}@font-face{font-family:MJXZERO;src:url("lib/fonts/mathjax_zero.woff") format("woff")}@font-face{font-family:MJXTEX;src:url("lib/fonts/mathjax_main-regular.woff") format("woff")}@font-face{font-family:MJXTEX-B;src:url("lib/fonts/mathjax_main-bold.woff") format("woff")}@font-face{font-family:MJXTEX-I;src:url("lib/fonts/mathjax_math-italic.woff") format("woff")}@font-face{font-family:MJXTEX-MI;src:url("lib/fonts/mathjax_main-italic.woff") format("woff")}@font-face{font-family:MJXTEX-BI;src:url("lib/fonts/mathjax_math-bolditalic.woff") format("woff")}@font-face{font-family:MJXTEX-S1;src:url("lib/fonts/mathjax_size1-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S2;src:url("lib/fonts/mathjax_size2-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S3;src:url("lib/fonts/mathjax_size3-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S4;src:url("lib/fonts/mathjax_size4-regular.woff") format("woff")}@font-face{font-family:MJXTEX-A;src:url("lib/fonts/mathjax_ams-regular.woff") format("woff")}@font-face{font-family:MJXTEX-C;src:url("lib/fonts/mathjax_calligraphic-regular.woff") format("woff")}@font-face{font-family:MJXTEX-CB;src:url("lib/fonts/mathjax_calligraphic-bold.woff") format("woff")}@font-face{font-family:MJXTEX-FR;src:url("lib/fonts/mathjax_fraktur-regular.woff") format("woff")}@font-face{font-family:MJXTEX-FRB;src:url("lib/fonts/mathjax_fraktur-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SS;src:url("lib/fonts/mathjax_sansserif-regular.woff") format("woff")}@font-face{font-family:MJXTEX-SSB;src:url("lib/fonts/mathjax_sansserif-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SSI;src:url("lib/fonts/mathjax_sansserif-italic.woff") format("woff")}@font-face{font-family:MJXTEX-SC;src:url("lib/fonts/mathjax_script-regular.woff") format("woff")}@font-face{font-family:MJXTEX-T;src:url("lib/fonts/mathjax_typewriter-regular.woff") format("woff")}@font-face{font-family:MJXTEX-V;src:url("lib/fonts/mathjax_vector-regular.woff") format("woff")}@font-face{font-family:MJXTEX-VB;src:url("lib/fonts/mathjax_vector-bold.woff") format("woff")}mjx-c.mjx-c1D437.TEX-I::before{padding:.683em .828em 0 0;content:"D"}mjx-c.mjx-c1D452.TEX-I::before{padding:.442em .466em .011em 0;content:"e"}mjx-c.mjx-c1D459.TEX-I::before{padding:.694em .298em .011em 0;content:"l"}mjx-c.mjx-c1D44E.TEX-I::before{padding:.441em .529em .01em 0;content:"a"}mjx-c.mjx-c1D466.TEX-I::before{padding:.442em .49em .205em 0;content:"y"}mjx-c.mjx-c1D45B.TEX-I::before{padding:.442em .6em .011em 0;content:"n"}mjx-c.mjx-c1D45C.TEX-I::before{padding:.441em .485em .011em 0;content:"o"}mjx-c.mjx-c1D451.TEX-I::before{padding:.694em .52em .01em 0;content:"d"}mjx-c.mjx-c3D::before{padding:.583em .778em .082em 0;content:"="}mjx-c.mjx-c1D45D.TEX-I::before{padding:.442em .503em .194em 0;content:"p"}mjx-c.mjx-c1D45F.TEX-I::before{padding:.442em .451em .011em 0;content:"r"}mjx-c.mjx-c1D450.TEX-I::before{padding:.442em .433em .011em 0;content:"c"}mjx-c.mjx-c2B::before{padding:.583em .778em .082em 0;content:"+"}mjx-c.mjx-c1D45E.TEX-I::before{padding:.442em .46em .194em 0;content:"q"}mjx-c.mjx-c1D462.TEX-I::before{padding:.442em .572em .011em 0;content:"u"}mjx-c.mjx-c1D461.TEX-I::before{padding:.626em .361em .011em 0;content:"t"}mjx-c.mjx-c1D460.TEX-I::before{padding:.442em .469em .01em 0;content:"s"}mjx-c.mjx-c2212::before{padding:.583em .778em .082em 0;content:"−"}mjx-c.mjx-c1D441.TEX-I::before{padding:.683em .888em 0 0;content:"N"}mjx-c.mjx-c28::before{padding:.75em .389em .25em 0;content:"("}mjx-c.mjx-c29::before{padding:.75em .389em .25em 0;content:")"}mjx-c.mjx-c1D445.TEX-I::before{padding:.683em .759em .021em 0;content:"R"}mjx-c.mjx-c1D440.TEX-I::before{padding:.683em 1.051em 0 0;content:"M"}mjx-c.mjx-c1D456.TEX-I::before{padding:.661em .345em .011em 0;content:"i"}mjx-c.mjx-c31::before{padding:.666em .5em 0 0;content:"1"}mjx-c.mjx-c2C::before{padding:.121em .278em .194em 0;content:","}mjx-c.mjx-c32::before{padding:.666em .5em 0 0;content:"2"}mjx-c.mjx-c33::before{padding:.665em .5em .022em 0;content:"3"}mjx-c.mjx-c2E::before{padding:.12em .278em 0 0;content:"."}mjx-c.mjx-c1D439.TEX-I::before{padding:.68em .749em 0 0;content:"F"}mjx-c.mjx-c2F::before{padding:.75em .5em .25em 0;content:"/"}mjx-c.mjx-c1D44F.TEX-I::before{padding:.694em .429em .011em 0;content:"b"}mjx-c.mjx-c35::before{padding:.666em .5em .022em 0;content:"5"}mjx-c.mjx-c30::before{padding:.666em .5em .022em 0;content:"0"}mjx-c.mjx-c1D43E.TEX-I::before{padding:.683em .889em 0 0;content:"K"}mjx-c.mjx-c1D43B.TEX-I::before{padding:.683em .888em 0 0;content:"H"}</style><pre class="frontmatter language-yaml" tabindex="0" style="display: none;"><code class="language-yaml is-loaded"><span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> OS</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="5. Interruption"><ol start="5">
<li dir="auto">Interruption</li>
</ol></h1><div class="el-h2 heading-wrapper"><h2 data-heading="第一课 CPU Running Mode" dir="auto" class="heading" id="第一课_CPU_Running_Mode"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第一课 CPU Running Mode</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-h3 heading-wrapper"><h3 data-heading="1.1 Real Mode and Protected Mode" dir="auto" class="heading" id="1.1_Real_Mode_and_Protected_Mode"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.1 Real Mode and Protected Mode</h3><div class="heading-children"><div class="el-p"><p dir="auto">早期由于8086/8088 CPU最大只能寻址1MB且指令长度为16位。为了兼容性，x86系列的CPU在计算机启动后的最开始都以<a data-tooltip-position="top" aria-label="https://wiki.osdev.org/Real_Mode" rel="noopener nofollow" class="external-link" href="https://wiki.osdev.org/Real_Mode" target="_blank"><strong>实模式(Real Mode)</strong></a>运行。实模式下只能使用低1MB的RAM，而且默认的指令长度为16bits。</p></div><div class="el-p"><p dir="auto">在实模式下，地址线直接映射物理内存地址。处理器不执行任何形式的内存管理和保护，如BIOS阶段的指令，没有我们后面介绍的特权级别一说，也没有特权指令、非特权指令之分。在实模式下，处理器会执行BIOS阶段的指令，初始化硬件和系统设置。</p></div><div class="el-p"><p dir="auto">之后，Bootloader接管计算机并在适当时刻将处理器从<strong>实模式</strong>转变为 <a data-tooltip-position="top" aria-label="https://wiki.osdev.org/Protected_Mode" rel="noopener nofollow" class="external-link" href="https://wiki.osdev.org/Protected_Mode" target="_blank"><strong>保护模式(Protected Mode)</strong></a> 这一转变使得系统可以访问更大的内存空间和执行更复杂的指令，也可以使用例如虚拟内存管理和内存保护机制这样的高级功能。所有的现代操作系统都运行在保护模式。</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="1.2 User Mode and Supervisor Mode" dir="auto" class="heading" id="1.2_User_Mode_and_Supervisor_Mode"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2 User Mode and Supervisor Mode</h3><div class="heading-children"><div class="el-p"><p dir="auto">为了实现系统的安全性和稳定性，现代OS和处理器定义了两种处理器执行权限模式：用户模式和内核模式。 这种设计使得操作系统可以更好地管理硬件资源，防止用户程序对系统的核心部分进行未经授权的访问。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.2.1 User Mode" dir="auto" class="heading" id="1.2.1_User_Mode"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.1 User Mode</h4><div class="heading-children"><div class="el-p"><p dir="auto">在用户模式下，程序只能执行有限的指令，不能直接对硬件和内核中的数据结构进行访问，这种指令被称为<strong>非特权指令(non-privileged instructions)</strong>。用户模式的限制防止用户程序对系统资源的滥用，保护了系统的安全和稳定。常见的非特权指令有：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">算术和逻辑运算指令。</li>
<li data-line="1" dir="auto">数据传输指令，不涉及受保护资源的读写。</li>
<li data-line="2" dir="auto">简单的控制流指令(如条件跳转)</li>
<li data-line="3" dir="auto">某些系统调用指令，这些通过中断或异常机制，安全地请求操作系统提供服务。</li>
</ol></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.2.2 Supervisor Mode" dir="auto" class="heading" id="1.2.2_Supervisor_Mode"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.2 Supervisor Mode</h4><div class="heading-children"><div class="el-p"><p dir="auto">也叫Kernel mode。在内核模式下，操作系统内核对所有的硬件和软件资源具有完全的访问权限。内核可以执行任何指令，管理任何设备和系统资源。只能在内核模式下运行的指令就是<strong>特权指令(privileged instructions)</strong>，这些指令通常涉及对硬件资源的直接控制和管理。常见的特权指令有：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">修改控制寄存器(如分页控制、内存管理)</li>
<li data-line="1" dir="auto">更改处理器的运行模式(如从用户模式切换到内核模式)</li>
<li data-line="2" dir="auto">直接访问I/O设备，</li>
<li data-line="3" dir="auto">启用或禁用中断，</li>
<li data-line="4" dir="auto">控制时间片、任务切换等。</li>
</ol></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="1.3 Protection Ring" dir="auto" class="heading" id="1.3_Protection_Ring"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3 Protection Ring</h3><div class="heading-children"><div class="el-p"><p dir="auto">在保护模式下，内核和用户程序从此隔离。用户程序只能够执行一些特定的指令，称为非特权指令，而内核可以执行任何特权、非特权的指令。那系统（CPU）是如何知道谁是用户程序，谁是内核程序呢？</p></div><div class="el-p"><p dir="auto">现代操作系统实现了4种不同的程序执行等级（CPU模式），称为 hierarchical protection domains，也叫 protection rings。实际上这四种不同的 rings 只使用了两种。其中，用户程序只能执行在 Ring 3，而内核程序执行在 Ring 0。CPU 通过 CS 寄存器的前两位来识别当前程序的特权级别，称为 CPL (Current Privilege Level) 位。</p></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20250127044801.png" src="Pasted image 20250127044801.png" class="internal-embed media-embed image-embed is-loaded"><img alt="Pasted image 20250127044801.png" src="congzhi's-os-series/pics/pasted-image-20250127044801.png"></span><br>
在段描述符、门描述符中还有 DPL(Descriptor Privilege Level)用来表示描述符特权级。比如在中断门描述符每一项都有一个 DPL，用于控制中断请求的特权级别；系统调用所对应的门描述符也有一个 DPL，用于控制系统调用的特权级别。只有当 CPL ≤ DPL 时，才能访问该描述符。</p></div><div class="el-p"><p dir="auto">后面我们在学习进程<a data-href="6. Processing The Processes" href="congzhi's-os-series/6.-processing-the-processes.html" class="internal-link" target="_self" rel="noopener nofollow">6. Processing The Processes</a>阶段的时候，我们会了解到每个进程都会有内核区（在32位系统下虚拟内存为3GB-4GB），在内核区中的代码段描述符和数据段描述符等的DPL就会被设置为0，即只有CPL为0时才能访问这些代码和数据等。</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="1.4 System Integrity" dir="auto" class="heading" id="1.4_System_Integrity"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.4 System Integrity</h3><div class="heading-children"><div class="el-p"><p dir="auto">我们对用户模式和内核模式进行了简单的了解，我们知道用户程序都运行在用户模式下（Ring 3），权限受限。而操作系统核心组件（如内存管理、进程调度、文件系统等）运行在内核模式下（Ring 0），在用户态的用户程序是无法直接对系统的核心组件进行篡改的。</p></div><div class="el-p"><p dir="auto">为了确保系统的安全，我们需要保证<strong>系统的完整性</strong>。系统完整性即系统在运行过程中保持其预期的正确性和一致性，防止未经授权的修改和破坏。由于用户态和内核态的分离，对系统核心的操作都在内核态中进行，这种特性保护了系统的完整性和稳定性。</p></div><div class="el-p"><p dir="auto">比方来说，在用户程序下，如果出现程序错误，往往只会导致程序崩溃，而不会影响整个系统的稳定性。通过内核模式的错误处理机制，操作系统可以捕获和处理这些错误，防止它们扩散到系统的其他部分，维护系统的整体完整性。而且用户程序是无法直接篡改系统的核心部件的，这也维护了系统的完整性。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.4.1 Separation of Policy and Mechanism" dir="auto" class="heading" id="1.4.1_Separation_of_Policy_and_Mechanism"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.4.1 Separation of Policy and Mechanism</h4><div class="heading-children"><div class="el-p"><p dir="auto"><strong>策略(policy)</strong> 是指操作系统如何决定何时以及如何执行某些操作，例如进程调度、内存管理、资源分配等。策略规定了系统行为的高层规则，而<strong>机制(mechanism)</strong> 则是实现这些规则的具体方法。</p></div><div class="el-p"><p dir="auto">操作系统在内核模式下执行具体的机制（如进程调度、内存管理），而策略（如调度策略、资源分配策略）则由操作系统的高层组件或管理员来决定。这种分离有助于系统的灵活性和可维护性，同时确保系统的完整性。</p></div></div></div></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第二课 System Calls" dir="auto" class="heading" id="第二课_System_Calls"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第二课 System Calls</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-p"><p dir="auto">由于操作系统对底层硬件的保护和封装，用户程序是不能够直接操作计算机硬件的。如果用户程序想要使用系统资源怎么办呢？操作系统通过<strong>系统调用接口</strong>提供了一系列的机制，使得用户程序可以调用这些接口来请求操作系统执行特定的操作，操作系统完成后返回操作结果。</p></div><div class="el-p"><p dir="auto">系统调用是操作系统提供给应用程序的一组接口，允许应用程序请求操作系统执行一些不能在用户模式下完成的操作。系统调用是应用程序与操作系统内核之间的桥梁。对于用户而言，使用系统调用和调用函数非常类似，唯一的不同就是系统调用工作在内核模式。</p></div><div class="el-p"><p dir="auto"><strong>系统调用的作用</strong>就是提供了一种安全的方法，让用户空间的程序请求内核空间的服务。我们通常将执行文件操作、进程控制、网络通信等需要更高权限的操作进行封装，提供系统调用接口给用户程序去使用。</p></div><div class="el-p"><p dir="auto">当应用程序需要执行一个系统调用时，它会通过特定的机制（如软中断）通知操作系统。操作系统接收到通知后，会从用户模式切换到内核模式，执行相应的内核函数。完成操作后，操作系统将结果返回给应用程序，并切换回用户模式。这就是<strong>系统调用的过程</strong>。</p></div><div class="el-p"><p dir="auto">系统调用有什么好处呢？它可以让操作系统在满足请求之前检查请求的正确性，防止不安全的操作。同时，应用程序开发者不需要了解硬件的低级编程细节。此外，相同的系统调用通常上在相同的操作系统上的接口是一样的，使程序具有一定的可移植性。</p></div><div class="el-h3 heading-wrapper"><h3 data-heading="2.1 `open()` System Call" dir="auto" class="heading" id="2.1_`open()`_System_Call"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.1 <code>open()</code> System Call</h3><div class="heading-children"><div class="el-p"><p dir="auto">我们用打开文件<code>open()</code>函数举例，假设我们有以下 C 程序：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fctrl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">/*用户态*/</span>

	<span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">,</span> S_IRUSR <span class="token operator">|</span> S_IWUSR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Mode switching</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fail to open file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Mode switching</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fail to read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Mode switching</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Read form buf: %s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Mode switching</span>
	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Mode switching</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">虽然这段代码不长，但是发生了4次系统调用，状态转换了8次。</p></div></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第三课 Tracing System Calls using `strace`" dir="auto" class="heading" id="第三课_Tracing_System_Calls_using_`strace`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第三课 Tracing System Calls using <code>strace</code></h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-p"><p dir="auto"><strong>Question</strong>： Why <code>printf();</code> works in the user mode?<br>
<span alt="Pasted image 20240913230021.png" src="Pasted image 20240913230021.png" class="internal-embed media-embed image-embed is-loaded"><img alt="Pasted image 20240913230021.png" src="congzhi's-os-series/pics/pasted-image-20240913230021.png"></span><br>
<strong>Answer</strong>： <code>printf();</code>函数运行在用户态是因为 C standard library(libc) 运行在用户态，而 <code>printf();</code>是作为标准库的一部分。好了，现在的问题转为为什么标准库运行在用户态了，在我们调用 <code>printf();</code> 的时候首先 <code>printf();</code> 函数会根据函数里面的参数将打印的字符串序列排好序。之后字符串会被放到一个buffer中，然后调用系统调用<code>write()</code>将buffer传给内核处理。内核将buffer里面的内容交给特定的输出设备然后回到用户态，打印结束。</p></div><div class="el-h3 heading-wrapper"><h3 data-heading="3.1 Trace `printf` in Terminal" dir="auto" class="heading" id="3.1_Trace_`printf`_in_Terminal"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1 Trace <code>printf</code> in Terminal</h3><div class="heading-children"><div class="el-p"><p dir="auto">假设我们有如下的代码，我们对其进行编译并使用<code>strace</code>命令进行系统调用跟踪，会发生什么？</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">我们发现当我们执行程序的时候，我们调用了非常多的系统调用，但是在最后面有这么一行：<code>write(1, "hello", 5hello) = 5</code>。表示<code>printf</code>函数实际上是使用<code>write</code>系统调用来向屏幕上打印 "hello" 字符串的，返回值为5，即打印了5个字符。</p></div><div class="el-pre"><pre><code data-line="0">du@DVM:~/Desktop/DSA$ strace ./test 
execve("./test", ["./test"], 0x7ffdd5170160 /* 55 vars */) = 0
brk(NULL)                               = 0x570c55c3b000
arch_prctl(0x3001 /* ARCH_??? */, 0x7ffc25af5710) = -1 EINVAL (Invalid argument)
mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7cdffcdbc000
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3
newfstatat(3, "", {st_mode=S_IFREG|0644, st_size=59619, ...}, AT_EMPTY_PATH) = 0
mmap(NULL, 59619, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7cdffcdad000
close(3)                                = 0
openat(AT_FDCWD, "/lib/x86_64-linux-gnu/libc.so.6", O_RDONLY|O_CLOEXEC) = 3
read(3, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0P\237\2\0\0\0\0\0"..., 832) = 832
pread64(3, "\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0"..., 784, 64) = 784
pread64(3, "\4\0\0\0 \0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0"..., 48, 848) = 48
pread64(3, "\4\0\0\0\24\0\0\0\3\0\0\0GNU\0I\17\357\204\3$\f\221\2039x\324\224\323\236S"..., 68, 896) = 68
newfstatat(3, "", {st_mode=S_IFREG|0755, st_size=2220400, ...}, AT_EMPTY_PATH) = 0
pread64(3, "\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0"..., 784, 64) = 784
mmap(NULL, 2264656, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7cdffca00000
mprotect(0x7cdffca28000, 2023424, PROT_NONE) = 0
mmap(0x7cdffca28000, 1658880, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x28000) = 0x7cdffca28000
mmap(0x7cdffcbbd000, 360448, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1bd000) = 0x7cdffcbbd000
mmap(0x7cdffcc16000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x215000) = 0x7cdffcc16000
mmap(0x7cdffcc1c000, 52816, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7cdffcc1c000
close(3)                                = 0
mmap(NULL, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7cdffcdaa000
arch_prctl(ARCH_SET_FS, 0x7cdffcdaa740) = 0
set_tid_address(0x7cdffcdaaa10)         = 71252
set_robust_list(0x7cdffcdaaa20, 24)     = 0
rseq(0x7cdffcdab0e0, 0x20, 0, 0x53053053) = 0
mprotect(0x7cdffcc16000, 16384, PROT_READ) = 0
mprotect(0x570c55b39000, 4096, PROT_READ) = 0
mprotect(0x7cdffcdf6000, 8192, PROT_READ) = 0
prlimit64(0, RLIMIT_STACK, NULL, {rlim_cur=8192*1024, rlim_max=RLIM64_INFINITY}) = 0
munmap(0x7cdffcdad000, 59619)           = 0
newfstatat(1, "", {st_mode=S_IFCHR|0620, st_rdev=makedev(0x88, 0), ...}, AT_EMPTY_PATH) = 0
getrandom("\x81\x42\x61\xea\x7a\xbb\x01\x45", 8, GRND_NONBLOCK) = 8
brk(NULL)                               = 0x570c55c3b000
brk(0x570c55c5c000)                     = 0x570c55c5c000
write(1, "hello", 5hello)                    = 5
exit_group(0)                           = ?
+++ exited with 0 +++
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">我们对上面的系统调用重新看一遍，为什么只是打印一个字符串确需要如此多的系统调用？这是因为操作系统需要处理许多底层任务来支持程序的运行，我们执行<code>printf</code>之前的加载并执行程序都需要操作系统的介入。</p></div></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第四课 System Call Mechanism(trap)\*" dir="auto" class="heading" id="第四课_System_Call_Mechanism(trap)\*"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第四课 System Call Mechanism(trap)*</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-h3 heading-wrapper"><h3 data-heading="4.1 System Call Interface" dir="auto" class="heading" id="4.1_System_Call_Interface"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.1 System Call Interface</h3><div class="heading-children"><div class="el-h4 heading-wrapper"><h4 data-heading="4.1.1 Syscall" dir="auto" class="heading" id="4.1.1_Syscall"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.1.1 Syscall</h4><div class="heading-children"><div class="el-p"><p dir="auto"><strong>系统调用</strong>是一种特殊类型的软件中断，通过系统调用，用户空间的程序可以请求操作系统的服务。系统调用是现代操作系统的基础功能，它为用户程序可以安全地使用内核模式下才能执行的文件操作、进程控制、通讯等操作。</p></div><div class="el-p"><p dir="auto">系统调用有多种的实现方式:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><strong>传统x86</strong>：在传统x86使用 <code>int 0x80</code> 的软件中断方式，其中 <code>0x80</code> 就是系统调用的中断向量号。</li>
<li data-line="1" dir="auto"><strong>现代x86</strong>：在现代的x86系统上，我们常用 <code>syscall</code> 指令来使用系统调用。 <code>syscall</code> 并不使用传统的中断向量表，而直接通过特定的 MSR(模型特定寄存器) 跳转到内核系统调用实现的入口点。</li>
</ul></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="4.1.2 Syscall Table" dir="auto" class="heading" id="4.1.2_Syscall_Table"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.1.2 Syscall Table</h4><div class="heading-children"><div class="el-p"><p dir="auto">当使用传统x86系统上的系统调用时，每个系统调用都会有唯一一个标识符，也就是<strong>系统调用号</strong>。系统调用号用于区分不同的系统调用。用户程序通常将系统调用号放在一个特定的寄存器（比如 <code>eax</code> 寄存器）中来指示希望执行哪个系统调用。随后内核通过查看这个寄存器来决定执行具体的ISR。</p></div><div class="el-p"><p dir="auto">当使用现代64位的x86系统时，保存系统调用号和系统调用入口关系的数据结构就是<strong>系统调用表(syscall table)</strong>。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="4.1.3 Function Wrapper" dir="auto" class="heading" id="4.1.3_Function_Wrapper"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.1.3 Function Wrapper</h4><div class="heading-children"><div class="el-p"><p dir="auto">向<code>openat</code>这样的函数实际上是系统调用号的包装器。这些包装函数简化了系统调用的使用，允许程序员通过高级和更易使用的接口方式与操作系统交互。</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="4.2 Different Architecture, Different System Calls" dir="auto" class="heading" id="4.2_Different_Architecture,_Different_System_Calls"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2 Different Architecture, Different System Calls</h3><div class="heading-children"><div class="el-p"><p dir="auto">我们用 <code>open("filename", MODE)</code> 库函数为例，我们在用户代码中被调用时只传入两个参数：文件名和打开文件的模式。在该函数执行时会触发模式切换并调用<strong>openat系统调用</strong>，不同的CPU架构实现方法不太一样，下面我们对比3种架构。</p></div><div class="el-p"><p dir="auto">我们会看到，虽然实现的细节不同，但是它们系统调用指令和传递参数的方式都是类似的。</p></div><div class="el-h5 heading-wrapper"><h5 data-heading="4.2.1 x86-32" dir="auto" class="heading" id="4.2.1_x86-32"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.1 x86-32</h5><div class="heading-children"><div class="el-p"><p dir="auto">x86-32属于传统的x86系统，使用 <code>int 0x80</code> 来调用 Linux 内核。如下：</p></div><div class="el-pre"><pre class="language-asm" tabindex="0"><code data-line="0" class="language-asm is-loaded">section .data
	filename db 'example.txt', 0	; 要打开的文件名，末尾有一个null字符
	filemode dw 0x0002		; O_RDONLY模式
section .text
	mov eax, 5				; open系统调用的编号是5
	mov ebx, filename		; 第一个参数
	mov ecx, filemode		; 第二个参数
	xor edx, edx			; 第三个参数
	int 0x80				; 执行系统调用
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="4.2.2 x86-64" dir="auto" class="heading" id="4.2.2_x86-64"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.2 x86-64</h5><div class="heading-children"><div class="el-p"><p dir="auto">到了x86-64位系统上，用<strong>系统调用表(syscall table)</strong> 来保存记录系统调用号和系统调用入口的关系。我们使用 <code>syscall</code> 来执行系统调用。我们忽略一些细节，相关调用实现如下：</p></div><div class="el-pre"><pre class="language-asm" tabindex="0"><code data-line="0" class="language-asm is-loaded">section .data
	filename db 'example.txt', 0	; 要打开的文件名，末尾有一个null字符
section .text
	mov rax, 257			; openat的系统调用的编号
	mov rdi, -100			; AT_FDCWD，当前 工作目录
	mov rsi, filename		; 第一个参数
	mov rdx, O_RDONLY		; 第二个参数
	xor r10, r10			; 第三个参数
	syscall					; 执行系统调用
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="4.2.3 arm64" dir="auto" class="heading" id="4.2.3_arm64"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.3 arm64</h5><div class="heading-children"><div class="el-pre"><pre class="language-asm" tabindex="0"><code data-line="0" class="language-asm is-loaded">.section .data
filename:
	.ascii "example.txt\0"
.text
	mov x0, -100
	ldr x1, =filename
	mov	x2, 0
	mov x3, 0
	mov x8, 56
	svc 0
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第五课 Syscall Do It Yourself" dir="auto" class="heading" id="第五课_Syscall_Do_It_Yourself"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第五课 Syscall Do It Yourself</h2><div class="heading-children"><div class="el-hr"><hr></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第六课 Interrupts" dir="auto" class="heading" id="第六课_Interrupts"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第六课 Interrupts</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-h3 heading-wrapper"><h3 data-heading="6 .1 Preview" dir="auto" class="heading" id="6_.1_Preview"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>6 .1 Preview</h3><div class="heading-children"><div class="el-blockquote"><blockquote dir="auto">
<p><em>Interrupts are interruption to CPU.</em></p>
</blockquote></div><div class="el-p"><p dir="auto">系统调用是一种特殊的中断。所有中断的处理流程和系统调用的处理流程有很多相似的地方。现代计算机是中断驱动的，中断机制的存在使得计算机(OS)能够及时响应外部事件并作出反应，极大地提升了系统的效率和响应性。</p></div><div class="el-p"><p dir="auto">如果没有中断机制，CPU将不得不采用轮询(Polling)方式逐个地检查每个设备的状态以确定其是否需要服务。这是一种主动响应机制，相比于被动响应的中断机制，轮询浪费了很大一部分计算资源。</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="6.2 Interrupts" dir="auto" class="heading" id="6.2_Interrupts"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>6.2 Interrupts</h3><div class="heading-children"><div class="el-p"><p dir="auto"><strong>中断(Interrupts)</strong> 是一个由硬件或软件发出的信号，当某个过程或事件需要立即处理时会使用中断来通知处理器。中断的目的是让处理器注意到更高优先级的任务并打断当前正在进行的指令流保存当前的状态，然后转而去执行特定的中断处理程序，最后再返回原指令流中继续执行，这就是 <strong>中断机制</strong> 。</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="6.3 Interrupt Classified" dir="auto" class="heading" id="6.3_Interrupt_Classified"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>6.3 Interrupt Classified</h3><div class="heading-children"><div class="el-h5 heading-wrapper"><h5 data-heading="6.3.1 Events Classified(ref: [Y4NGY操作系统课程](https://space.bilibili.com/286191426/channel/collectiondetail?sid=2293786))" dir="auto" class="heading" id="6.3.1_Events_Classified(ref:_[Y4NGY操作系统课程](https://space.bilibili.com/286191426/channel/collectiondetail?sid=2293786))"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>6.3.1 Events Classified(ref: <a data-tooltip-position="top" aria-label="https://space.bilibili.com/286191426/channel/collectiondetail?sid=2293786" rel="noopener nofollow" class="external-link" href="https://space.bilibili.com/286191426/channel/collectiondetail?sid=2293786" target="_blank">Y4NGY操作系统课程</a>)</h5><div class="heading-children"><div class="el-p"><p dir="auto">根据中断信号的产生源可将中断分为硬件中断和软件中断两大类：</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>Hardware Interrupt</strong>：</p>
<ol>
<li data-line="2" dir="auto">
<p><strong>外部中断（External Interrupt）</strong>：来自CPU外部硬件或I/O设备的中断。</p>
</li>
<li data-line="3" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>内部中断（Internal Interrupt）</strong>：CPU内部自已产生的中断，也称为<strong>异常(exception)</strong>。</p>
<ul>
<li data-line="5" dir="auto"><strong>trap</strong>：程序执行时故意产生的中断 (syscall)，是一种自愿中断</li>
<li data-line="6" dir="auto"><strong>fault</strong>：执行指令引起的异常事件，是可恢复的错误而触发的中断 (page fault)</li>
<li data-line="7" dir="auto"><strong>abort</strong>：硬故障事件，是不可恢复的严重错误下触发的中断 </li>
</ul>
</li>
</ol>
</li>
<li data-line="9" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>Software Interrupt</strong>：</p>
<ul>
<li data-line="11" dir="auto">通常由程序通过调用中断指令(如int xxx)主动发出的中断。(int 0x80)</li>
</ul>
</li>
</ul></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="6.3.2 Events Classified(ref: *Art of Assembly Language Programming*)" dir="auto" class="heading" id="6.3.2_Events_Classified(ref:_*Art_of_Assembly_Language_Programming*)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>6.3.2 Events Classified(ref: <em>Art of Assembly Language Programming</em>)</h5><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>Hardware Interrupts :</strong></p>
<ul>
<li data-line="2" dir="auto">或直接称为中断，是由硬件设备唤起的中断类型。</li>
<li data-line="3" dir="auto">硬件中断是异步的，任何时刻都可能发生。</li>
</ul>
</li>
<li data-line="5" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>Traps :</strong></p>
<ul>
<li data-line="7" dir="auto">有时也称作软件中断(Software Interrupts)。</li>
<li data-line="8" dir="auto">由用户程序唤起，用来请求操作系统的帮助。</li>
</ul>
</li>
<li data-line="10" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>
<p><strong>Exceptions :</strong></p>
<ul>
<li data-line="12" dir="auto">处理器内部自动生成，由于某些非法指令的执行。</li>
<li data-line="13" dir="auto"><strong>Faults :</strong> 可恢复的错误。（page fault）</li>
<li data-line="14" dir="auto"><strong>Aborts :</strong> 通常是不可恢复的错误。（divide by 0 exception）</li>
</ul>
</li>
</ul></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="6.4 Interrupt Controller" dir="auto" class="heading" id="6.4_Interrupt_Controller"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>6.4 Interrupt Controller</h3><div class="heading-children"><div class="el-h5 heading-wrapper"><h5 data-heading="6.4.1 Interrupts in Legacy CPU" dir="auto" class="heading" id="6.4.1_Interrupts_in_Legacy_CPU"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>6.4.1 Interrupts in Legacy CPU</h5><div class="heading-children"></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="6.4.2 Advanced Programmable Interrupt Controller(APIC)" dir="auto" class="heading" id="6.4.2_Advanced_Programmable_Interrupt_Controller(APIC)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>6.4.2 Advanced Programmable Interrupt Controller(APIC)</h5><div class="heading-children"><div class="el-h6 heading-wrapper"><h6 data-heading="6.4.2.1 LAPIC" dir="auto" class="heading" id="6.4.2.1_LAPIC"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>6.4.2.1 LAPIC</h6><div class="heading-children"></div></div><div class="el-h6 heading-wrapper"><h6 data-heading="6.4.2.2 I/OAPIC" dir="auto" class="heading" id="6.4.2.2_I/OAPIC"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>6.4.2.2 I/OAPIC</h6><div class="heading-children"></div></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="6.5 Interrupt Vectors" dir="auto" class="heading" id="6.5_Interrupt_Vectors"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>6.5 Interrupt Vectors</h3><div class="heading-children"><div class="el-p"><p dir="auto">操作系统是如何区分处理各种中断信号的。每种中断信号都被赋予一个特定的编号，称为中断向量号。这个向量号是一个整数，它起到了关键的角色，让系统能够识别并对应到具体的中断处理程序(也叫“中断服务例程”)。</p></div><div class="el-p"><p dir="auto">中断向量号的分配方式取决于中断的类型:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><strong>外部中断</strong>，如来自硬件设备的中断，其向量号通常是由设备驱动在运行时动态申请的。这确保了不同设备能够根据当前系统状态获得适当的中断处理。</li>
<li data-line="1" dir="auto"><strong>异常</strong>，如程序错误或非法操作，其向量号则是由CPU的架构标准所固定规定。这样做的目的是为了确保异常能够以一致的方式被处理，无论系统在什么状态下。</li>
<li data-line="2" dir="auto"><strong>软件中断</strong>，通常是由操作系统内核中的程序触发的，其向量号是由内核预设。软件中断允许操作系统内部组件或运行在用户模式下的程序请求内核提供服务。</li>
</ul></div><div class="el-p"><p dir="auto">在32位的x86架构中，有<strong>256个中断号，从0到255</strong>，也就是<code>int</code>指令后面的数字最大是255。中断向量号的划分如下：</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><strong>预定义的中断(0-31)</strong>：<strong>0-19号</strong>是由Intel定义的用于处理各种标准异常的中断号，比如除零错误(0)，通用保护故障(13)，页故障(14)等。<strong>20-31号</strong>保留给 Intel 未来使用。</li>
<li data-line="1" dir="auto"><strong>用户自定义的中断(32-255)</strong>：<strong>32-47号</strong>通常被用于外部硬件中断，这是基于IBM PC架构的8259可编程中断控制器的标准设置。这个范围被称为主片和从片的IRQs(中断请求)。<strong>48-255号</strong>可以由操作系统自定义使用，通常用于实现软件中断、系统调用(128号中断向量)等。</li>
</ul></div><div class="el-p"><p dir="auto">我们在前面看到过，在下x86架构下的系统调用编号是<code>0x80</code>。我们可以说，系统调用是软件中断的特定形式，而软件中断又是中断的子集。</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="6.6 IVT and IDT" dir="auto" class="heading" id="6.6_IVT_and_IDT"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>6.6 IVT and IDT</h3><div class="heading-children"><div class="el-p"><p dir="auto"><strong>中断向量表(Interrupt Vector Table，IVT)</strong> 存储了每个中断向量号与其对应的 <strong>中断服务例程(Interrupt Service Routine, ISR)</strong> 的地址。当系统检测到一个中断信号时，它会通过这个信号的向量号在IVT中查找相应的服务例程地址，然后跳转到该地址执行中断处理程序。</p></div><div class="el-p"><p dir="auto">在计算机的实模式中，像键盘输入和屏幕显示等BIOS服务都是通过预设的中断方式实现的，它使用了中断向量表来查询BIOS中断号对应的ISR地址。</p></div><div class="el-p"><p dir="auto">当计算机转入保护模式， <strong>中断描述符表(Interrupt Descriptor Table, IDT)</strong> 取代了IVT，成为新的中断管理核心。IDT 相较于 IVT，有以下优点(不完整)：</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><strong>安全性</strong>:  IDT不仅包含ISR的地址，还包含了必要的权限和状态信息，如特权级(DPL)。这允许操作系统设计者实施更精细的控制，例如防止用户模式代码直接触发某些特权中断。</li>
<li data-line="1" dir="auto"><strong>灵活性</strong> : IDT支持在运行时动态修改，它们可能根据运行时的需要动态地添加、修改或移除中断处理程序。</li>
<li data-line="2" dir="auto"><strong>性能</strong>：IDT结构为现代操作系统提供了执行中断处理的更高效方式。例如，通过中断门触发的中断处理可以自动关闭中断，这避免了在处理一个中断时被其他中断干扰的问题，增强了处理的效率和系统的稳定性。</li>
</ul></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="6.7 ISR" dir="auto" class="heading" id="6.7_ISR"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>6.7 ISR</h3><div class="heading-children"><div class="el-p"><p dir="auto"><strong>中断服务例程(Interrupt Service Routine, ISR)</strong> 是响应硬件或软件中断信号的一段特定程序代码。当某个事件(如输入/输出操作、时钟信号、硬件故障或其他外部事件)触发中断时，处理器会暂停当前正在执行的任务，转而执行与该中断关联的ISR。<br>
<span alt="Pasted image 20240423213215.png" src="Pasted image 20240423213215.png" class="internal-embed media-embed image-embed is-loaded"><img alt="Pasted image 20240423213215.png" src="congzhi's-os-series/pics/pasted-image-20240423213215.png"></span></p></div></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第七课 Interrupt Context" dir="auto" class="heading" id="第七课_Interrupt_Context"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第七课 Interrupt Context</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-p"><p dir="auto">当系统在执行指令流的过程中，在完成第 i 条指令后，如果突然接收到一个中断信号或主动发起系统调用，此时系统需要暂停当前的任务去响应这个中断/调用请求。为了确保中断处理完毕后，程序能够无缝地返回到被中断的位置继续执行后续指令，系统必须在执行中断处理程序之前，保存必要的一些信息，即<strong>现场信息</strong>。</p></div><div class="el-h3 heading-wrapper"><h3 data-heading="7.1 Context Saving" dir="auto" class="heading" id="7.1_Context_Saving"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>7.1 Context Saving</h3><div class="heading-children"><div class="el-p"><p dir="auto"><em>以x86-32位架构为例。</em>（<code>arch/x86/kernel/entry_32.S</code>）</p></div><div class="el-p"><p dir="auto"><strong>现场信息</strong>是指CPU中的一些寄存器的值，通过保存恢复这些寄存器的数值，程序就能够回到被中断位置继续执行指令。这其中有几个核心寄存器：</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><strong>SS</strong>：栈段寄存器，指向当前栈所在的栈段地址。</li>
<li data-line="1" dir="auto"><strong>ESP</strong>：栈指针寄存器，指向栈顶。</li>
<li data-line="2" dir="auto"><strong>EFLAGS</strong>：包含了影响程序执行的多种状态标志，如零标志、符号标志、溢出标志等。</li>
<li data-line="3" dir="auto"><strong>CS</strong>：包含当前代码段的选择子(Selector)，即指定了代码段在内存中的位置。</li>
<li data-line="4" dir="auto"><strong>EIP</strong>：即PC寄存器，指向将要执行的下一条指令。</li>
</ul></div><div class="el-p"><p dir="auto">那这些现场信息存放在哪里呢？只要程序暂停执行并在未来需要恢复，那么程序就需要把现场信息先存放到一个位置，这个位置就是内核栈。这些现场信息会被 <code>push</code> 到内核栈中。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="7.1.1 User Mode Interruption" dir="auto" class="heading" id="7.1.1_User_Mode_Interruption"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>7.1.1 User Mode Interruption</h4><div class="heading-children"><div class="el-p"><p dir="auto">一旦程序在用户态被中断，上面提到的五个最重要的寄存器由硬件 CPU 自动完成（这个操作是当即完成的），无需操作系统或中断处理程序进行任何干预。而进程的中断上下文不仅仅只有这五个寄存器。操作系统负责保存一些额外的现场信息内容（执行 ISR 时保存）。如：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">通用寄存器(<code>EAX</code>, <code>EBX</code>, <code>ECX</code>, <code>EDX</code>, <code>ESI</code>, <code>EDI</code>, <code>EBP</code>)</li>
<li data-line="1" dir="auto">段寄存器选择子（<code>DS</code>, <code>ES</code>, <code>ES</code>, <code>GS</code>）</li>
</ol></div><div class="el-p"><p dir="auto">如果有错误发生，硬件还会压入错误码。待操作系统处理。</p></div><div class="el-p"><p dir="auto">此外，在 CPU 执行 ISR 时，还牵扯到 <strong>CPL 的变化</strong>。即在中断发生时 CPU 特权级别 CPL 是"user mode"， CPU 需要负责将 CPL 切换至 0，即"kernel mode"，才能接着执行 ISR。（中断门描述符检查 DPL ≥ CPL ）</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="7.1.2 Kernel Mode Interruption" dir="auto" class="heading" id="7.1.2_Kernel_Mode_Interruption"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>7.1.2 Kernel Mode Interruption</h4><div class="heading-children"><div class="el-p"><p dir="auto">如果程序在内核态中断，那么将不再需要保存 <code>SS</code> 寄存器和 <code>ESP</code> 寄存器。因为中断时指向的就是内核栈。另外的，内核态下的段寄存器（如DS、ES）一般也不需要保存。因为它们已经指向内核数据段。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="7.1.x Kernel Stack Ownership" dir="auto" class="heading" id="7.1.x_Kernel_Stack_Ownership"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>7.1.x Kernel Stack Ownership</h4><div class="heading-children"><div class="el-p"><p dir="auto">每个线程都有自己的内核栈。当线程被中断时，CPU 就会转换到其内核栈将线程的上下文进行压栈保存。一般而言，内核栈大小为 8KB/16KB 。</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="7.2 Context Recovering" dir="auto" class="heading" id="7.2_Context_Recovering"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>7.2 Context Recovering</h3><div class="heading-children"><div class="el-p"><p dir="auto"><em>以x86-32架构为例。</em></p></div><div class="el-p"><p dir="auto">在&nbsp;<code>iret</code>&nbsp;指令执行前，中断服务例程（ISR）需手动恢复操作系统保存的寄存器。恢复顺序需与保存顺序严格相反（后进先出，LIFO）。</p></div><div class="el-p"><p dir="auto">ISR的指令逻辑流程：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">保存通用寄存器</li>
<li data-line="1" dir="auto">执行中断处理代码</li>
<li data-line="2" dir="auto">恢复通用寄存器</li>
<li data-line="3" dir="auto">使用iret返回（弹出硬件保存寄存器）</li>
</ol></div><div class="el-h4 heading-wrapper"><h4 data-heading="7.2.1 Return to User Mode" dir="auto" class="heading" id="7.2.1_Return_to_User_Mode"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>7.2.1 Return to User Mode</h4><div class="heading-children"><div class="el-p"><p dir="auto">中断服务例程的执行完成后，系统需要通过执行 <code>iret</code> 指令来从 ISR 返回到原来的程序执行流。<code>iret</code> 指令的作用不仅是精确和有序的，它还负责恢复之前由 CPU 自动保存到栈中的处理器状态，并实现特权级的适当切换。</p></div><div class="el-p"><p dir="auto">如果返回到用户态（CPL 0-&gt;3），那么执行 <code>iret</code> 时寄存器会依次弹出 <strong>EIP、CS、EFLAGS、用户态 ESP、用户态 SS</strong>。然后恢复 CS 中 CPL 的特权级别为 3，CPU 自动换回用户态。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="7.2.2 Return to Kernel Mode" dir="auto" class="heading" id="7.2.2_Return_to_Kernel_Mode"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>7.2.2 Return to Kernel Mode</h4><div class="heading-children"><div class="el-p"><p dir="auto">仅仅弹出 <strong>EIP、CS、EFLAGS</strong>。而且由于特权级别不变，不切换栈指针。</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="7.3 PSW(16 bits) and EFLAGS(32 bits)/RFLAGS(64 bits)" dir="auto" class="heading" id="7.3_PSW(16_bits)_and_EFLAGS(32_bits)/RFLAGS(64_bits)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>7.3 PSW(16 bits) and EFLAGS(32 bits)/RFLAGS(64 bits)</h3><div class="heading-children"></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第Q课 信号、软件中断和软中断" dir="auto" class="heading" id="第Q课_信号、软件中断和软中断"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第Q课 信号、软件中断和软中断</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-p"><p dir="auto">信号将在<a data-tooltip-position="top" aria-label="6.5 Inter-Process Communications" data-href="6.5 Inter-Process Communications" href="congzhi's-os-series/6.5-inter-process-communications.html" class="internal-link" target="_self" rel="noopener nofollow">IPC</a>阶段中介绍。</p></div><div class="el-p"><p dir="auto">学习Linux的信号机制(signaling mechanism)时，一时间将我的思绪拉回了<strong>中断</strong>。信号是什么？软中断是什么？软件中断又是什么？它们有何相同点？又有哪些是不同的？</p></div><div class="el-h3 heading-wrapper"><h3 data-heading="1. 信号(Signaling)" dir="auto" class="heading" id="1._信号(Signaling)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1. 信号(Signaling)</h3><div class="heading-children"><div class="el-blockquote"><blockquote dir="auto">
<p><em>The signaling mechanism in the Linux kernel allows running applications to asynchronously notify the system when a new event occurs. Because of its nature, this signaling mechanism is generally known as software interrupts.</em></p>
</blockquote></div><div class="el-p"><p dir="auto">信号在Linux操作系统中非常重要。<strong>信号是进程间通信的一种方式</strong>。对于内核而言，信号就是一个事件，操作系统内核将中断的处理结果以信号的方式传递给进程。随后进程根据处理的结果做出相应的动作。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.1 信号的来源" dir="auto" class="heading" id="1.1_信号的来源"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.1 信号的来源</h4><div class="heading-children"><div class="el-p"><p dir="auto">我们常常用<strong>信号</strong>作为<strong>进程间通信IPC</strong>和<strong>异常处理</strong>的一种手段。虽然操作系统内核通常是大多数信号的来源，但下面我们仍列举一些其他的信号来源：</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">进程执行时产生的异常，如<strong>段错误(segmentation faults)</strong></li>
<li data-line="1" dir="auto"><strong>硬件</strong>产生的信号，比如定时器产生的信号</li>
<li data-line="2" dir="auto">其他进程使用<code>kill</code><strong>系统调用</strong>产生的信号</li>
</ul></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.2 信号的产生" dir="auto" class="heading" id="1.2_信号的产生"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2 信号的产生</h4><div class="heading-children"><div class="el-p"><p dir="auto">我们下面简单介绍硬件中断和异常是如何产生信号的。之后小节我们用例子说明<code>kill</code>系统调用是怎么产生信号并终止特定进程的。</p></div><div class="el-h5 heading-wrapper"><h5 data-heading="1.2.1 硬件产生的信号" dir="auto" class="heading" id="1.2.1_硬件产生的信号"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.1 硬件产生的信号</h5><div class="heading-children"><div class="el-p"><p dir="auto">信号的本质就是软件层次对中断的模拟，是一种异步通信机制。每个信号都对应着不同的功能。举个例子（按下Ctrl + C）：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><strong>硬件中断</strong>：
<ul>
<li data-line="1" dir="auto">键盘控制器检测到&nbsp;<code>Ctrl+C</code>&nbsp;按键组合，并发送硬件中断信号给 CPU。</li>
<li data-line="2" dir="auto">CPU暂停当前正在执行的用户空间代码，保存现场并切换到内核态。</li>
</ul>
</li>
<li data-line="3" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><strong>中断处理</strong>：
<ul>
<li data-line="4" dir="auto"><strong>进入内核态</strong>：CPU开始执行与键盘中断相关的中断服务例程（ISR）。</li>
<li data-line="5" dir="auto"><strong>执行ISR</strong>：内核中的键盘ISR处理这个中断事件，识别出这是一个Ctrl+C按键事件。</li>
</ul>
</li>
<li data-line="6" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><strong>生成信号</strong>：
<ul>
<li data-line="7" dir="auto"><strong>生成SIGINT信号</strong>：内核生成一个SIGINT信号。（用于终止进程）</li>
<li data-line="8" dir="auto"><strong>给进程发送信号</strong>：内核将SIGINT信号发送到目标进程，并将信号记录在<mark>PCB的信号位图上</mark>。</li>
</ul>
</li>
<li data-line="9" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><strong>信号处理</strong>：
<ul>
<li data-line="10" dir="auto"><strong>检测信号</strong>：当进程恢复执行时，内核会检查该进程PCB的信号队列（信号位图）。</li>
<li data-line="11" dir="auto"><strong>处理信号</strong>：根据进程的信号处理设置，内核会执行相应的操作。默认SIGINT会终止进程。</li>
<li data-line="12" dir="auto"><strong>调用信号处理函数</strong>：如果进程有自定义的信号处理函数，内核会调用该函数来处理信号。</li>
</ul>
</li>
</ol></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="1.2.2 异常产生的信号" dir="auto" class="heading" id="1.2.2_异常产生的信号"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.2.2 异常产生的信号</h5><div class="heading-children"><div class="el-p"><p dir="auto">假如我们有一个<code>signal.c</code>文件如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token keyword">void</span> <span class="token function">divideByZeroHandler</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Divide by zero exception occurred!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGFPE<span class="token punctuation">,</span> divideByZeroHandler<span class="token punctuation">)</span> <span class="token operator">==</span> SIG_ERR<span class="token punctuation">)</span><span class="token punctuation">{</span>
	    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Cannot register the handler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> dividend <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> divisor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> result<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Attempting to divide %d by %d...\n"</span><span class="token punctuation">,</span> dividend<span class="token punctuation">,</span> divisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> dividend <span class="token operator">/</span> divisor<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Result: %d\n"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">我们知道，当除数为0时，结果会是一个异常。当这个异常发生时，进程就会中断。这时操作系统内核会把 SIGFPE（浮点异常） 发给进程。又由于我们设置了信号的服务程序<code>signal(SIGFPE, divideByZeroHandler);</code>，所以当进程收到信号，他就会打印输出信息并退出程序 error(1)。</p></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.3 信号的传递和处理" dir="auto" class="heading" id="1.3_信号的传递和处理"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3 信号的传递和处理</h4><div class="heading-children"><div class="el-h5 heading-wrapper"><h5 data-heading="1.3.1 信号的传递" dir="auto" class="heading" id="1.3.1_信号的传递"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.1 信号的传递</h5><div class="heading-children"><div class="el-p"><p dir="auto">信号由操作系统负责传递给指定进程，传递时机是：</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">从内核态返回用户态运行时：内核会检查待处理信号集合，如果有未阻塞的待处理信号操作系统会在返回用户态前递送信号，调用相应的信号处理函数。</li>
<li data-line="1" dir="auto">被调度运行时：在进程真正开始运行用户代码之前，递送未阻塞的信号。</li>
<li data-line="2" dir="auto">就绪态时：信号会被添加到进程的待处理信号集合中，但不会立即递送。</li>
<li data-line="3" dir="auto">等待态时：如果进程正在阻塞于某个系统调用(如read、sleep等)，信号的发生可能会导致系统调用被中断，提前返回用户态处理信号。</li>
</ul></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="1.3.2 信号的处理" dir="auto" class="heading" id="1.3.2_信号的处理"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.2 信号的处理</h5><div class="heading-children"><div class="el-p"><p dir="auto">进程收到信号后的处理方式有:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">默认处理:操作系统定义的默认行为(终止、忽略等)</li>
<li data-line="1" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>忽略信号:进程选择不处理某些信号(部分信号不可忽略)自定义处理:进程注册信号处理函数，定义自己的处理方式。
<ul>
<li data-line="2" dir="auto">定义信号处理函数</li>
<li data-line="3" dir="auto">注册信号处理函数</li>
</ul>
</li>
</ul></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.4 信号的类型" dir="auto" class="heading" id="1.4_信号的类型"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.4 信号的类型</h4><div class="heading-children"><div class="el-p"><p dir="auto">我们可以通过下面的命令来查看Linux中的所有类型的信号：</p></div><div class="el-pre"><pre class="language-sh" tabindex="0"><code data-line="0" class="language-sh is-loaded"><span class="token function">kill</span> <span class="token parameter variable">-l</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Linux系统中有62种信号，分为两类：非实时信号（1-31）和实时信号（34-64）。非实时信号包括常见的SIGINT（中断信号）、SIGTERM（终止信号）等，而实时信号用于更高精度的事件处理。</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="2. 软件中断(Software Interrupt)" dir="auto" class="heading" id="2._软件中断(Software_Interrupt)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2. 软件中断(Software Interrupt)</h3><div class="heading-children"><div class="el-p"><p dir="auto">从上述信号的了解中，我们能够感受到，中断可以是信号的产生源。我们已经学过中断了，我们可以将中断定义为一种<strong>CPU</strong>和<strong>操作系统内核</strong>的<strong>交流方式</strong>。中断一旦发生，CPU 暂停当前任务并触发内核中的中断服务程序（ISR）。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.1 信号 vs. 中断" dir="auto" class="heading" id="2.1_信号_vs._中断"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.1 信号 vs. 中断</h4><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">
<p><strong>处理程序(Handler)</strong>：信号处理程序在用户空间代码中执行，而中断服务程序在内核空间中执行。信号处理程序用于处理进程接收到的特定信号，而中断服务程序用于处理硬件中断。</p>
</li>
<li data-line="2" dir="auto">
<p><strong>屏蔽(Mask)</strong>：信号屏蔽和中断屏蔽分别用于暂时阻止进程接收信号和处理硬件中断，以保护关键代码段的原子性执行</p>
</li>
</ul></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.2 软件中断和信号" dir="auto" class="heading" id="2.2_软件中断和信号"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2 软件中断和信号</h4><div class="heading-children"><div class="el-p"><p dir="auto">系统调用(syscall)是一种软件中断，我们可以用系统调用来给特定的进程发送信号。如：</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><strong><code>kill</code>&nbsp;系统调用</strong>：用于向指定进程发送信号，可以通过进程ID（<code>kill(PID)</code>）来指定目标进程。</li>
<li data-line="1" dir="auto"><strong><code>raise</code>&nbsp;系统调用</strong>：用于向自身进程发送信号，相当于调用&nbsp;<code>kill(getpid(), sig)</code>。</li>
<li data-line="2" dir="auto"><strong><code>alarm</code>&nbsp;系统调用</strong>：设置一个定时器，当定时器到期时，会向进程发送&nbsp;<code>SIGALRM</code>&nbsp;信号。</li>
<li data-line="3" dir="auto"><strong><code>sigqueue</code>&nbsp;系统调用</strong>：用于向指定进程发送信号，并可以附带一个值。</li>
</ul></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.1 `kill`系统调用" dir="auto" class="heading" id="2.2.1_`kill`系统调用"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.1 <code>kill</code>系统调用</h5><div class="heading-children"><div class="el-p"><p dir="auto">提供<code>kill</code>系统调用，我们可以给特定的进程发送<code>SIGINT</code>信号来终止某个进程。如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span> <span class="token comment">// An abstraction to raw syscall</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this is child process\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this is parent process\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"terminating child process now!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">在这个例子中，父进程先是使用&nbsp;<code>fork()</code>&nbsp;创建一个子进程。子进程每秒打印一次 “this is child process”。父进程等待2秒后，使用&nbsp;<code>kill(pid, SIGINT)</code>&nbsp;向子进程发送&nbsp;<code>SIGINT</code>&nbsp;信号，终止子进程。我们还可以自己编写信号处理函数来处理输出我们想要的结果。</p></div><div class="el-pre"><pre class="language-sh" tabindex="0"><code data-line="0" class="language-sh is-loaded">du@DVM:~/Desktop/CppCode$ ./kill 
this is child process
this is parent process
this is child process
this is child process
terminating child process now<span class="token operator">!</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="3. SoftIRQ" dir="auto" class="heading" id="3._SoftIRQ"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3. SoftIRQ</h3><div class="heading-children"><div class="el-p"><p dir="auto">中断的来源很多，softirq的种类也不少。内核的限制是不能超过32个，目前实际用到的有10个。包括高优先级tasklet、定时器、网络收发、块设备、普通tasklet、高精度定时器和RCU等。softIRQ主要用于处理高频率、低延迟的任务，如网络包处理和定时器等。</p></div><div class="el-p"><p dir="auto">其中两个用来实现tasklet(HI_SOFTIRQ和TASKLET_SOFTIRQ)，两个用于网络的发送和接收操作(NET_TX_SOFTIRQ和NET_RX_SOFTIRQ)，一个用于调度器(SCHED_SOFTIRQ)，实现SMP系统上周期性的负载均衡。在启用高分辨率定时器时，还需要一个HRTIMER_SOFTIRQ。</p></div><div class="el-p"><p dir="auto">为了有效地管理不同的softirq中断源，Linux采用的是一个名为<strong>softirq_vec[]</strong> 的数组，数组的大小由<em>NR_SOFTIRQS</em>&nbsp;表示，这是在编译时就确定了的，不能在系统运行过程中动态添加。每个数组元素代表一种softirq的种类，而数组里存放的内容则是其各自对应的执行函数。</p></div><div class="mod-footer mod-ui"></div></div></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#5. Interruption"><div class="tree-item-contents heading-link" heading-name="
Interruption
"><span class="tree-item-title">Interruption</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#第一课_CPU_Running_Mode"><div class="tree-item-contents heading-link" heading-name="第一课 CPU Running Mode"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第一课 CPU Running Mode</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.1_Real_Mode_and_Protected_Mode"><div class="tree-item-contents heading-link" heading-name="1.1 Real Mode and Protected Mode"><span class="tree-item-title">1.1 Real Mode and Protected Mode</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.2_User_Mode_and_Supervisor_Mode"><div class="tree-item-contents heading-link" heading-name="1.2 User Mode and Supervisor Mode"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.2 User Mode and Supervisor Mode</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.2.1_User_Mode"><div class="tree-item-contents heading-link" heading-name="1.2.1 User Mode"><span class="tree-item-title">1.2.1 User Mode</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.2.2_Supervisor_Mode"><div class="tree-item-contents heading-link" heading-name="1.2.2 Supervisor Mode"><span class="tree-item-title">1.2.2 Supervisor Mode</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.3_Protection_Ring"><div class="tree-item-contents heading-link" heading-name="1.3 Protection Ring"><span class="tree-item-title">1.3 Protection Ring</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.4_System_Integrity"><div class="tree-item-contents heading-link" heading-name="1.4 System Integrity"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.4 System Integrity</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.4.1_Separation_of_Policy_and_Mechanism"><div class="tree-item-contents heading-link" heading-name="1.4.1 Separation of Policy and Mechanism"><span class="tree-item-title">1.4.1 Separation of Policy and Mechanism</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#第二课_System_Calls"><div class="tree-item-contents heading-link" heading-name="第二课 System Calls"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第二课 System Calls</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#2.1_`open()`_System_Call"><div class="tree-item-contents heading-link" heading-name="2.1 `open()` System Call"><span class="tree-item-title">2.1 <code>open()</code> System Call</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#第三课_Tracing_System_Calls_using_`strace`"><div class="tree-item-contents heading-link" heading-name="第三课 Tracing System Calls using `strace`"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第三课 Tracing System Calls using <code>strace</code></span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#3.1_Trace_`printf`_in_Terminal"><div class="tree-item-contents heading-link" heading-name="3.1 Trace `printf` in Terminal"><span class="tree-item-title">3.1 Trace <code>printf</code> in Terminal</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#第四课_System_Call_Mechanism(trap)\*"><div class="tree-item-contents heading-link" heading-name="第四课 System Call Mechanism(trap)\*"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第四课 System Call Mechanism(trap)*</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#4.1_System_Call_Interface"><div class="tree-item-contents heading-link" heading-name="4.1 System Call Interface"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">4.1 System Call Interface</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#4.1.1_Syscall"><div class="tree-item-contents heading-link" heading-name="4.1.1 Syscall"><span class="tree-item-title">4.1.1 Syscall</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#4.1.2_Syscall_Table"><div class="tree-item-contents heading-link" heading-name="4.1.2 Syscall Table"><span class="tree-item-title">4.1.2 Syscall Table</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#4.1.3_Function_Wrapper"><div class="tree-item-contents heading-link" heading-name="4.1.3 Function Wrapper"><span class="tree-item-title">4.1.3 Function Wrapper</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#4.2_Different_Architecture,_Different_System_Calls"><div class="tree-item-contents heading-link" heading-name="4.2 Different Architecture, Different System Calls"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">4.2 Different Architecture, Different System Calls</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#4.2.1_x86-32"><div class="tree-item-contents heading-link" heading-name="4.2.1 x86-32"><span class="tree-item-title">4.2.1 x86-32</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#4.2.2_x86-64"><div class="tree-item-contents heading-link" heading-name="4.2.2 x86-64"><span class="tree-item-title">4.2.2 x86-64</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#4.2.3_arm64"><div class="tree-item-contents heading-link" heading-name="4.2.3 arm64"><span class="tree-item-title">4.2.3 arm64</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#第五课_Syscall_Do_It_Yourself"><div class="tree-item-contents heading-link" heading-name="第五课 Syscall Do It Yourself"><span class="tree-item-title">第五课 Syscall Do It Yourself</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#第六课_Interrupts"><div class="tree-item-contents heading-link" heading-name="第六课 Interrupts"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第六课 Interrupts</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#6_.1_Preview"><div class="tree-item-contents heading-link" heading-name="6 .1 Preview"><span class="tree-item-title">6 .1 Preview</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#6.2_Interrupts"><div class="tree-item-contents heading-link" heading-name="6.2 Interrupts"><span class="tree-item-title">6.2 Interrupts</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#6.3_Interrupt_Classified"><div class="tree-item-contents heading-link" heading-name="6.3 Interrupt Classified"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">6.3 Interrupt Classified</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#6.3.1_Events_Classified(ref:_[Y4NGY操作系统课程](https://space.bilibili.com/286191426/channel/collectiondetail?sid=2293786))"><div class="tree-item-contents heading-link" heading-name="6.3.1 Events Classified(ref: [Y4NGY操作系统课程](https://space.bilibili.com/286191426/channel/collectiondetail?sid=2293786))"><span class="tree-item-title">6.3.1 Events Classified(ref: <a data-tooltip-position="top" aria-label="https://space.bilibili.com/286191426/channel/collectiondetail?sid=2293786" rel="noopener nofollow" class="external-link" href="https://space.bilibili.com/286191426/channel/collectiondetail?sid=2293786" target="_blank">Y4NGY操作系统课程</a>)</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#6.3.2_Events_Classified(ref:_*Art_of_Assembly_Language_Programming*)"><div class="tree-item-contents heading-link" heading-name="6.3.2 Events Classified(ref: *Art of Assembly Language Programming*)"><span class="tree-item-title">6.3.2 Events Classified(ref: <em>Art of Assembly Language Programming</em>)</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#6.4_Interrupt_Controller"><div class="tree-item-contents heading-link" heading-name="6.4 Interrupt Controller"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">6.4 Interrupt Controller</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#6.4.1_Interrupts_in_Legacy_CPU"><div class="tree-item-contents heading-link" heading-name="6.4.1 Interrupts in Legacy CPU"><span class="tree-item-title">6.4.1 Interrupts in Legacy CPU</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#6.4.2_Advanced_Programmable_Interrupt_Controller(APIC)"><div class="tree-item-contents heading-link" heading-name="6.4.2 Advanced Programmable Interrupt Controller(APIC)"><span class="tree-item-title">6.4.2 Advanced Programmable Interrupt Controller(APIC)</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="6"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#6.4.2.1_LAPIC"><div class="tree-item-contents heading-link" heading-name="6.4.2.1 LAPIC"><span class="tree-item-title">6.4.2.1 LAPIC</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="6"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#6.4.2.2_I/OAPIC"><div class="tree-item-contents heading-link" heading-name="6.4.2.2 I/OAPIC"><span class="tree-item-title">6.4.2.2 I/OAPIC</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#6.5_Interrupt_Vectors"><div class="tree-item-contents heading-link" heading-name="6.5 Interrupt Vectors"><span class="tree-item-title">6.5 Interrupt Vectors</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#6.6_IVT_and_IDT"><div class="tree-item-contents heading-link" heading-name="6.6 IVT and IDT"><span class="tree-item-title">6.6 IVT and IDT</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#6.7_ISR"><div class="tree-item-contents heading-link" heading-name="6.7 ISR"><span class="tree-item-title">6.7 ISR</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#第七课_Interrupt_Context"><div class="tree-item-contents heading-link" heading-name="第七课 Interrupt Context"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第七课 Interrupt Context</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#7.1_Context_Saving"><div class="tree-item-contents heading-link" heading-name="7.1 Context Saving"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">7.1 Context Saving</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#7.1.1_User_Mode_Interruption"><div class="tree-item-contents heading-link" heading-name="7.1.1 User Mode Interruption"><span class="tree-item-title">7.1.1 User Mode Interruption</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#7.1.2_Kernel_Mode_Interruption"><div class="tree-item-contents heading-link" heading-name="7.1.2 Kernel Mode Interruption"><span class="tree-item-title">7.1.2 Kernel Mode Interruption</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#7.1.x_Kernel_Stack_Ownership"><div class="tree-item-contents heading-link" heading-name="7.1.x Kernel Stack Ownership"><span class="tree-item-title">7.1.x Kernel Stack Ownership</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#7.2_Context_Recovering"><div class="tree-item-contents heading-link" heading-name="7.2 Context Recovering"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">7.2 Context Recovering</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#7.2.1_Return_to_User_Mode"><div class="tree-item-contents heading-link" heading-name="7.2.1 Return to User Mode"><span class="tree-item-title">7.2.1 Return to User Mode</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#7.2.2_Return_to_Kernel_Mode"><div class="tree-item-contents heading-link" heading-name="7.2.2 Return to Kernel Mode"><span class="tree-item-title">7.2.2 Return to Kernel Mode</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#7.3_PSW(16_bits)_and_EFLAGS(32_bits)/RFLAGS(64_bits)"><div class="tree-item-contents heading-link" heading-name="7.3 PSW(16 bits) and EFLAGS(32 bits)/RFLAGS(64 bits)"><span class="tree-item-title">7.3 PSW(16 bits) and EFLAGS(32 bits)/RFLAGS(64 bits)</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#第Q课_信号、软件中断和软中断"><div class="tree-item-contents heading-link" heading-name="第Q课 信号、软件中断和软中断"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第Q课 信号、软件中断和软中断</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1._信号(Signaling)"><div class="tree-item-contents heading-link" heading-name="1. 信号(Signaling)"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1. 
信号(Signaling)
</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.1_信号的来源"><div class="tree-item-contents heading-link" heading-name="1.1 信号的来源"><span class="tree-item-title">1.1 信号的来源</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.2_信号的产生"><div class="tree-item-contents heading-link" heading-name="1.2 信号的产生"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.2 信号的产生</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.2.1_硬件产生的信号"><div class="tree-item-contents heading-link" heading-name="1.2.1 硬件产生的信号"><span class="tree-item-title">1.2.1 硬件产生的信号</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.2.2_异常产生的信号"><div class="tree-item-contents heading-link" heading-name="1.2.2 异常产生的信号"><span class="tree-item-title">1.2.2 异常产生的信号</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.3_信号的传递和处理"><div class="tree-item-contents heading-link" heading-name="1.3 信号的传递和处理"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.3 信号的传递和处理</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.3.1_信号的传递"><div class="tree-item-contents heading-link" heading-name="1.3.1 信号的传递"><span class="tree-item-title">1.3.1 信号的传递</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.3.2_信号的处理"><div class="tree-item-contents heading-link" heading-name="1.3.2 信号的处理"><span class="tree-item-title">1.3.2 信号的处理</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#1.4_信号的类型"><div class="tree-item-contents heading-link" heading-name="1.4 信号的类型"><span class="tree-item-title">1.4 信号的类型</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#2._软件中断(Software_Interrupt)"><div class="tree-item-contents heading-link" heading-name="2. 软件中断(Software Interrupt)"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2. 
软件中断(Software Interrupt)
</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#2.1_信号_vs._中断"><div class="tree-item-contents heading-link" heading-name="2.1 信号 vs. 中断"><span class="tree-item-title">2.1 信号 vs. 中断</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#2.2_软件中断和信号"><div class="tree-item-contents heading-link" heading-name="2.2 软件中断和信号"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.2 软件中断和信号</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#2.2.1_`kill`系统调用"><div class="tree-item-contents heading-link" heading-name="2.2.1 `kill`系统调用"><span class="tree-item-title">2.2.1 <code>kill</code>系统调用</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\5.-interruption.html#3._SoftIRQ"><div class="tree-item-contents heading-link" heading-name="3. SoftIRQ"><span class="tree-item-title">3. 
SoftIRQ
</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>