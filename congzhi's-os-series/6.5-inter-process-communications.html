<!DOCTYPE html> <html><head>
		<title>6.5 Inter-Process Communications</title>
		<base href="../">
		<meta id="root-path" root-path="../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="Congzhi's Notes Vault - 6.5 Inter-Process Communications">
		<meta property="og:title" content="6.5 Inter-Process Communications">
		<meta property="og:description" content="Congzhi's Notes Vault - 6.5 Inter-Process Communications">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://congzhi.wiki/congzhi's-os-series/6.5-inter-process-communications.html">
		<meta property="og:image" content="https://congzhi.wiki/congzhi's-os-series/pics/pasted-image-20241130023253.jpg">
		<meta property="og:site_name" content="Congzhi's Notes Vault">
		<meta name="author" content="Congzhi"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://congzhi.wiki/lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="https://cdn.jsdelivr.net/npm/minisearch@6.3.0/dist/umd/index.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles">mjx-munder{display:inline-block;text-align:left}mjx-over{text-align:left}mjx-munder:not([limits=false]){display:inline-table}mjx-munder>mjx-row{text-align:left}mjx-under{padding-bottom:.1em}mjx-c.mjx-c5C::before{padding:.75em .5em .25em 0;content:"\\"}mjx-msqrt{display:inline-block;text-align:left}mjx-root{display:inline-block;white-space:nowrap}mjx-surd{display:inline-block;vertical-align:top}mjx-sqrt{display:inline-block;padding-top:.07em}mjx-sqrt>mjx-box{border-top:.07em solid}mjx-sqrt.mjx-tall>mjx-box{padding-left:.3em;margin-left:-.3em}mjx-c.mjx-c221A::before{padding:.8em .853em .2em 0;content:"√"}mjx-c.mjx-c2061::before{padding:0;content:""}mjx-c.mjx-c1D442.TEX-I::before{padding:.704em .763em .022em 0;content:"O"}mjx-c.mjx-c4B::before{padding:.683em .778em 0 0;content:"K"}mjx-c.mjx-c46::before{padding:.68em .653em 0 0;content:"F"}mjx-c.mjx-c7A::before{padding:.431em .444em 0 0;content:"z"}mjx-c.mjx-cD7::before{padding:.491em .778em 0 0;content:"×"}mjx-c.mjx-c4D::before{padding:.683em .917em 0 0;content:"M"}mjx-c.mjx-c1D43A.TEX-I::before{padding:.705em .786em .022em 0;content:"G"}mjx-c.mjx-c70::before{padding:.442em .556em .194em 0;content:"p"}mjx-c.mjx-cB1::before{padding:.666em .778em 0 0;content:"±"}mjx-c.mjx-c5F::before{padding:0 .5em .062em 0;content:"_"}mjx-mtable{display:inline-block;text-align:center;vertical-align:.25em;position:relative;box-sizing:border-box;border-spacing:0px;border-collapse:collapse}mjx-mstyle[size="s"] mjx-mtable{vertical-align:.354em}mjx-labels{position:absolute;left:0;top:0}mjx-table{display:inline-block;vertical-align:-.5ex;box-sizing:border-box}mjx-table>mjx-itable{vertical-align:middle;text-align:left;box-sizing:border-box}mjx-labels>mjx-itable{position:absolute;top:0}mjx-mtable[justify=left]{text-align:left}mjx-mtable[justify=right]{text-align:right}mjx-mtable[justify=left][side=left]{padding-right:0!important}mjx-mtable[justify=left][side=right]{padding-left:0!important}mjx-mtable[justify=right][side=left]{padding-right:0!important}mjx-mtable[justify=right][side=right]{padding-left:0!important}mjx-mtable[align]{vertical-align:baseline}mjx-mtable[align=top]>mjx-table{vertical-align:top}mjx-mtable[align=bottom]>mjx-table{vertical-align:bottom}mjx-mtable[side=right] mjx-labels{min-width:100%}mjx-mtr{display:table-row;text-align:left}mjx-mtr[rowalign=top]>mjx-mtd{vertical-align:top}mjx-mtr[rowalign=center]>mjx-mtd{vertical-align:middle}mjx-mtr[rowalign=bottom]>mjx-mtd{vertical-align:bottom}mjx-mtr[rowalign=baseline]>mjx-mtd{vertical-align:baseline}mjx-mtr[rowalign=axis]>mjx-mtd{vertical-align:.25em}mjx-mtd{display:table-cell;text-align:center;padding:.215em .4em}mjx-mtd:first-child{padding-left:0}mjx-mtd:last-child{padding-right:0}mjx-mtable>*>mjx-itable>:first-child>mjx-mtd{padding-top:0}mjx-mtable>*>mjx-itable>:last-child>mjx-mtd{padding-bottom:0}mjx-tstrut{display:inline-block;height:1em;vertical-align:-.25em}mjx-labels[align=left]>mjx-mtr>mjx-mtd{text-align:left}mjx-labels[align=right]>mjx-mtr>mjx-mtd{text-align:right}mjx-mtd[extra]{padding:0}mjx-mtd[rowalign=top]{vertical-align:top}mjx-mtd[rowalign=center]{vertical-align:middle}mjx-mtd[rowalign=bottom]{vertical-align:bottom}mjx-mtd[rowalign=baseline]{vertical-align:baseline}mjx-mtd[rowalign=axis]{vertical-align:.25em}mjx-stretchy-v.mjx-c5B mjx-beg mjx-c::before{content:"⎡";padding:1.154em .667em .645em 0}mjx-stretchy-v.mjx-c5B mjx-ext mjx-c::before{content:"⎢";width:.667em}mjx-stretchy-v.mjx-c5B mjx-end mjx-c::before{content:"⎣";padding:1.155em .667em .644em 0}mjx-stretchy-v.mjx-c5B>mjx-end{margin-top:-1.799em}mjx-stretchy-v.mjx-c5B>mjx-ext{border-top-width:1.769em;border-bottom-width:1.769em}mjx-stretchy-v.mjx-c5D mjx-beg mjx-c::before{content:"⎤";padding:1.154em .667em .645em 0}mjx-stretchy-v.mjx-c5D mjx-ext mjx-c::before{content:"⎥";width:.667em}mjx-stretchy-v.mjx-c5D mjx-end mjx-c::before{content:"⎦";padding:1.155em .667em .644em 0}mjx-stretchy-v.mjx-c5D>mjx-end{margin-top:-1.799em}mjx-stretchy-v.mjx-c5D>mjx-ext{border-top-width:1.769em;border-bottom-width:1.769em}mjx-c.mjx-c1D703.TEX-I::before{padding:.705em .469em .01em 0;content:"θ"}mjx-c.mjx-c1D434.TEX-I::before{padding:.716em .75em 0 0;content:"A"}mjx-c.mjx-c5B::before{padding:.75em .278em .25em 0;content:"["}mjx-c.mjx-c5D::before{padding:.75em .278em .25em 0;content:"]"}mjx-c.mjx-c22EF::before{padding:.31em 1.172em 0 0;content:"⋯"}mjx-c.mjx-c22EE::before{padding:1.3em .278em .03em 0;content:"⋮"}mjx-c.mjx-c22F1::before{padding:1.52em 1.282em 0 0;content:"⋱"}mjx-c.mjx-c1D44A.TEX-I::before{padding:.683em 1.048em .022em 0;content:"W"}mjx-c.mjx-c1D444.TEX-I::before{padding:.704em .791em .194em 0;content:"Q"}mjx-c.mjx-c3E::before{padding:.54em .778em .04em 0;content:">"}mjx-c.mjx-c1D70F.TEX-I::before{padding:.431em .517em .013em 0;content:"τ"}mjx-c.mjx-c1D458.TEX-I::before{padding:.694em .521em .011em 0;content:"k"}mjx-c.mjx-c2211.TEX-S2::before{padding:.95em 1.444em .45em 0;content:"∑"}mjx-c.mjx-c3C::before{padding:.54em .778em .04em 0;content:"<"}mjx-c.mjx-c44::before{padding:.683em .764em 0 0;content:"D"}mjx-c.mjx-c20::before{padding:0 .25em 0 0;content:" "}mjx-c.mjx-c6D::before{padding:.442em .833em 0 0;content:"m"}mjx-c.mjx-c2D::before{padding:.252em .333em 0 0;content:"-"}mjx-c.mjx-c75::before{padding:.442em .556em .011em 0;content:"u"}mjx-c.mjx-c6B::before{padding:.694em .528em 0 0;content:"k"}mjx-c.mjx-c52::before{padding:.683em .736em .022em 0;content:"R"}mjx-c.mjx-c67::before{padding:.453em .5em .206em 0;content:"g"}mjx-c.mjx-c45::before{padding:.68em .681em 0 0;content:"E"}mjx-c.mjx-c78::before{padding:.431em .528em 0 0;content:"x"}mjx-c.mjx-c220F.TEX-S2::before{padding:.95em 1.278em .45em 0;content:"∏"}mjx-c.mjx-c2264::before{padding:.636em .778em .138em 0;content:"≤"}mjx-c.mjx-c1D457.TEX-I::before{padding:.661em .412em .204em 0;content:"j"}mjx-c.mjx-c1D435.TEX-I::before{padding:.683em .759em 0 0;content:"B"}mjx-c.mjx-c47::before{padding:.705em .785em .022em 0;content:"G"}mjx-c.mjx-c4C::before{padding:.683em .625em 0 0;content:"L"}mjx-c.mjx-c42::before{padding:.683em .708em 0 0;content:"B"}mjx-c.mjx-c41::before{padding:.716em .75em 0 0;content:"A"}mjx-c.mjx-c43::before{padding:.705em .722em .021em 0;content:"C"}mjx-c.mjx-c79::before{padding:.431em .528em .204em 0;content:"y"}mjx-c.mjx-c6C::before{padding:.694em .278em 0 0;content:"l"}mjx-c.mjx-c69::before{padding:.669em .278em 0 0;content:"i"}mjx-c.mjx-c6E::before{padding:.442em .556em 0 0;content:"n"}mjx-c.mjx-c64::before{padding:.694em .556em .011em 0;content:"d"}mjx-c.mjx-c65::before{padding:.448em .444em .011em 0;content:"e"}mjx-c.mjx-c72::before{padding:.442em .392em 0 0;content:"r"}mjx-c.mjx-c4E::before{padding:.683em .75em 0 0;content:"N"}mjx-c.mjx-c68::before{padding:.694em .556em 0 0;content:"h"}mjx-c.mjx-c61::before{padding:.448em .5em .011em 0;content:"a"}mjx-c.mjx-c48::before{padding:.683em .75em 0 0;content:"H"}mjx-c.mjx-c63::before{padding:.448em .444em .011em 0;content:"c"}mjx-c.mjx-c74::before{padding:.615em .389em .01em 0;content:"t"}mjx-c.mjx-c6F::before{padding:.448em .5em .01em 0;content:"o"}mjx-c.mjx-c53::before{padding:.705em .556em .022em 0;content:"S"}mjx-c.mjx-c54::before{padding:.677em .722em 0 0;content:"T"}mjx-c.mjx-c5A::before{padding:.683em .611em 0 0;content:"Z"}mjx-msup{display:inline-block;text-align:left}mjx-c.mjx-c38::before{padding:.666em .5em .022em 0;content:"8"}mjx-c.mjx-c39::before{padding:.666em .5em .022em 0;content:"9"}mjx-c.mjx-c73::before{padding:.448em .394em .011em 0;content:"s"}mjx-c.mjx-c1D448.TEX-I::before{padding:.683em .767em .022em 0;content:"U"}mjx-c.mjx-c37::before{padding:.676em .5em .022em 0;content:"7"}mjx-c.mjx-c1D438.TEX-I::before{padding:.68em .764em 0 0;content:"E"}mjx-c.mjx-c1D6FC.TEX-I::before{padding:.442em .64em .011em 0;content:"α"}mjx-c.mjx-c1D463.TEX-I::before{padding:.443em .485em .011em 0;content:"v"}mjx-c.mjx-c1D6FD.TEX-I::before{padding:.705em .566em .194em 0;content:"β"}mjx-c.mjx-c7C::before{padding:.75em .278em .249em 0;content:"|"}mjx-c.mjx-c1D43C.TEX-I::before{padding:.683em .504em 0 0;content:"I"}mjx-mtext{display:inline-block;text-align:left}mjx-mfrac{display:inline-block;text-align:left}mjx-frac{display:inline-block;vertical-align:.17em;padding:0 .22em}mjx-frac[type="d"]{vertical-align:.04em}mjx-frac[delims]{padding:0 .1em}mjx-frac[atop]{padding:0 .12em}mjx-frac[atop][delims]{padding:0}mjx-dtable{display:inline-table;width:100%}mjx-dtable>*{font-size:2000%}mjx-dbox{display:block;font-size:5%}mjx-num{display:block;text-align:center}mjx-den{display:block;text-align:center}mjx-mfrac[bevelled]>mjx-num{display:inline-block}mjx-mfrac[bevelled]>mjx-den{display:inline-block}mjx-den[align=right],mjx-num[align=right]{text-align:right}mjx-den[align=left],mjx-num[align=left]{text-align:left}mjx-nstrut{display:inline-block;height:.054em;width:0;vertical-align:-.054em}mjx-nstrut[type="d"]{height:.217em;vertical-align:-.217em}mjx-dstrut{display:inline-block;height:.505em;width:0}mjx-dstrut[type="d"]{height:.726em}mjx-line{display:block;box-sizing:border-box;min-height:1px;height:.06em;border-top:.06em solid;margin:.06em -.1em;overflow:hidden}mjx-line[type="d"]{margin:.18em -.1em}mjx-mrow{display:inline-block;text-align:left}mjx-munderover{display:inline-block;text-align:left}mjx-munderover:not([limits=false]){padding-top:.1em}mjx-munderover:not([limits=false])>*{display:block}mjx-msubsup{display:inline-block;text-align:left}mjx-script{display:inline-block;padding-right:.05em;padding-left:.033em}mjx-script>mjx-spacer{display:block}mjx-c.mjx-c210E.TEX-I::before{padding:.694em .576em .011em 0;content:"h"}mjx-c.mjx-c3A::before{padding:.43em .278em 0 0;content:":"}mjx-c.mjx-c1D464.TEX-I::before{padding:.443em .716em .011em 0;content:"w"}mjx-c.mjx-c1D45A.TEX-I::before{padding:.442em .878em .011em 0;content:"m"}mjx-c.mjx-c1D446.TEX-I::before{padding:.705em .645em .022em 0;content:"S"}mjx-c.mjx-c1D454.TEX-I::before{padding:.442em .477em .205em 0;content:"g"}mjx-c.mjx-c1D453.TEX-I::before{padding:.705em .55em .205em 0;content:"f"}mjx-c.mjx-c1D465.TEX-I::before{padding:.442em .572em .011em 0;content:"x"}mjx-c.mjx-c2217::before{padding:.465em .5em 0 0;content:"∗"}mjx-c.mjx-c1D447.TEX-I::before{padding:.677em .704em 0 0;content:"T"}mjx-c.mjx-cA0::before{padding:0 .25em 0 0;content:" "}mjx-c.mjx-c34::before{padding:.677em .5em 0 0;content:"4"}mjx-c.mjx-c36::before{padding:.666em .5em .022em 0;content:"6"}mjx-c.mjx-c2248::before{padding:.483em .778em 0 0;content:"≈"}mjx-c.mjx-c1D449.TEX-I::before{padding:.683em .769em .022em 0;content:"V"}mjx-c.mjx-c1D43F.TEX-I::before{padding:.683em .681em 0 0;content:"L"}mjx-c.mjx-c1D436.TEX-I::before{padding:.705em .76em .022em 0;content:"C"}mjx-c.mjx-c2265::before{padding:.636em .778em .138em 0;content:"≥"}mjx-c.mjx-c7B::before{padding:.75em .5em .25em 0;content:"{"}mjx-c.mjx-c7D::before{padding:.75em .5em .25em 0;content:"}"}mjx-c.mjx-c1D443.TEX-I::before{padding:.683em .751em 0 0;content:"P"}mjx-c.mjx-c2211.TEX-S1::before{padding:.75em 1.056em .25em 0;content:"∑"}mjx-container[jax=CHTML]{line-height:0}mjx-container [space="1"]{margin-left:.111em}mjx-container [space="2"]{margin-left:.167em}mjx-container [space="3"]{margin-left:.222em}mjx-container [space="4"]{margin-left:.278em}mjx-container [space="5"]{margin-left:.333em}mjx-container [rspace="1"]{margin-right:.111em}mjx-container [rspace="2"]{margin-right:.167em}mjx-container [rspace="3"]{margin-right:.222em}mjx-container [rspace="4"]{margin-right:.278em}mjx-container [rspace="5"]{margin-right:.333em}mjx-container [size="s"]{font-size:70.7%}mjx-container [size=ss]{font-size:50%}mjx-container [size=Tn]{font-size:60%}mjx-container [size=sm]{font-size:85%}mjx-container [size=lg]{font-size:120%}mjx-container [size=Lg]{font-size:144%}mjx-container [size=LG]{font-size:173%}mjx-container [size=hg]{font-size:207%}mjx-container [size=HG]{font-size:249%}mjx-container [width=full]{width:100%}mjx-box{display:inline-block}mjx-block{display:block}mjx-itable{display:inline-table}mjx-row{display:table-row}mjx-row>*{display:table-cell}mjx-mtext{display:inline-block}mjx-mstyle{display:inline-block}mjx-merror{display:inline-block;color:red;background-color:#ff0}mjx-mphantom{visibility:hidden}mjx-assistive-mml{top:0;left:0;clip:rect(1px,1px,1px,1px);user-select:none;position:absolute!important;padding:1px 0 0!important;border:0!important;display:block!important;width:auto!important;overflow:hidden!important}mjx-assistive-mml[display=block]{width:100%!important}mjx-math{display:inline-block;text-align:left;line-height:0;text-indent:0;font-style:normal;font-weight:400;font-size:100%;letter-spacing:normal;border-collapse:collapse;overflow-wrap:normal;word-spacing:normal;white-space:nowrap;direction:ltr;padding:1px 0}mjx-container[jax=CHTML][display=true]{display:block;text-align:center;margin:1em 0}mjx-container[jax=CHTML][display=true][width=full]{display:flex}mjx-container[jax=CHTML][display=true] mjx-math{padding:0}mjx-container[jax=CHTML][justify=left]{text-align:left}mjx-container[jax=CHTML][justify=right]{text-align:right}mjx-mi{display:inline-block;text-align:left}mjx-c{display:inline-block}mjx-utext{display:inline-block;padding:.75em 0 .2em}mjx-msub{display:inline-block;text-align:left}mjx-texatom{display:inline-block;text-align:left}mjx-mo{display:inline-block;text-align:left}mjx-stretchy-h{display:inline-table;width:100%}mjx-stretchy-h>*{display:table-cell;width:0}mjx-stretchy-h>*>mjx-c{display:inline-block;transform:scaleX(1)}mjx-stretchy-h>*>mjx-c::before{display:inline-block;width:initial}mjx-stretchy-h>mjx-ext{overflow:clip visible;width:100%}mjx-stretchy-h>mjx-ext>mjx-c::before{transform:scaleX(500)}mjx-stretchy-h>mjx-ext>mjx-c{width:0}mjx-stretchy-h>mjx-beg>mjx-c{margin-right:-.1em}mjx-stretchy-h>mjx-end>mjx-c{margin-left:-.1em}mjx-stretchy-v{display:inline-block}mjx-stretchy-v>*{display:block}mjx-stretchy-v>mjx-beg{height:0}mjx-stretchy-v>mjx-end>mjx-c{display:block}mjx-stretchy-v>*>mjx-c{transform:scaleY(1);transform-origin:left center;overflow:hidden}mjx-stretchy-v>mjx-ext{display:block;height:100%;box-sizing:border-box;border:0 solid transparent;overflow:visible clip}mjx-stretchy-v>mjx-ext>mjx-c::before{width:initial;box-sizing:border-box}mjx-stretchy-v>mjx-ext>mjx-c{transform:scaleY(500) translateY(.075em);overflow:visible}mjx-mark{display:inline-block;height:0}mjx-mn{display:inline-block;text-align:left}mjx-c::before{display:block;width:0}.MJX-TEX{font-family:MJXZERO,MJXTEX}.TEX-B{font-family:MJXZERO,MJXTEX-B}.TEX-I{font-family:MJXZERO,MJXTEX-I}.TEX-MI{font-family:MJXZERO,MJXTEX-MI}.TEX-BI{font-family:MJXZERO,MJXTEX-BI}.TEX-S1{font-family:MJXZERO,MJXTEX-S1}.TEX-S2{font-family:MJXZERO,MJXTEX-S2}.TEX-S3{font-family:MJXZERO,MJXTEX-S3}.TEX-S4{font-family:MJXZERO,MJXTEX-S4}.TEX-A{font-family:MJXZERO,MJXTEX-A}.TEX-C{font-family:MJXZERO,MJXTEX-C}.TEX-CB{font-family:MJXZERO,MJXTEX-CB}.TEX-FR{font-family:MJXZERO,MJXTEX-FR}.TEX-FRB{font-family:MJXZERO,MJXTEX-FRB}.TEX-SS{font-family:MJXZERO,MJXTEX-SS}.TEX-SSB{font-family:MJXZERO,MJXTEX-SSB}.TEX-SSI{font-family:MJXZERO,MJXTEX-SSI}.TEX-SC{font-family:MJXZERO,MJXTEX-SC}.TEX-T{font-family:MJXZERO,MJXTEX-T}.TEX-V{font-family:MJXZERO,MJXTEX-V}.TEX-VB{font-family:MJXZERO,MJXTEX-VB}mjx-stretchy-h mjx-c,mjx-stretchy-v mjx-c{font-family:MJXZERO,MJXTEX-S1,MJXTEX-S4,MJXTEX,MJXTEX-A!important}@font-face{font-family:MJXZERO;src:url("lib/fonts/mathjax_zero.woff") format("woff")}@font-face{font-family:MJXTEX;src:url("lib/fonts/mathjax_main-regular.woff") format("woff")}@font-face{font-family:MJXTEX-B;src:url("lib/fonts/mathjax_main-bold.woff") format("woff")}@font-face{font-family:MJXTEX-I;src:url("lib/fonts/mathjax_math-italic.woff") format("woff")}@font-face{font-family:MJXTEX-MI;src:url("lib/fonts/mathjax_main-italic.woff") format("woff")}@font-face{font-family:MJXTEX-BI;src:url("lib/fonts/mathjax_math-bolditalic.woff") format("woff")}@font-face{font-family:MJXTEX-S1;src:url("lib/fonts/mathjax_size1-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S2;src:url("lib/fonts/mathjax_size2-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S3;src:url("lib/fonts/mathjax_size3-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S4;src:url("lib/fonts/mathjax_size4-regular.woff") format("woff")}@font-face{font-family:MJXTEX-A;src:url("lib/fonts/mathjax_ams-regular.woff") format("woff")}@font-face{font-family:MJXTEX-C;src:url("lib/fonts/mathjax_calligraphic-regular.woff") format("woff")}@font-face{font-family:MJXTEX-CB;src:url("lib/fonts/mathjax_calligraphic-bold.woff") format("woff")}@font-face{font-family:MJXTEX-FR;src:url("lib/fonts/mathjax_fraktur-regular.woff") format("woff")}@font-face{font-family:MJXTEX-FRB;src:url("lib/fonts/mathjax_fraktur-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SS;src:url("lib/fonts/mathjax_sansserif-regular.woff") format("woff")}@font-face{font-family:MJXTEX-SSB;src:url("lib/fonts/mathjax_sansserif-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SSI;src:url("lib/fonts/mathjax_sansserif-italic.woff") format("woff")}@font-face{font-family:MJXTEX-SC;src:url("lib/fonts/mathjax_script-regular.woff") format("woff")}@font-face{font-family:MJXTEX-T;src:url("lib/fonts/mathjax_typewriter-regular.woff") format("woff")}@font-face{font-family:MJXTEX-V;src:url("lib/fonts/mathjax_vector-regular.woff") format("woff")}@font-face{font-family:MJXTEX-VB;src:url("lib/fonts/mathjax_vector-bold.woff") format("woff")}mjx-c.mjx-c1D437.TEX-I::before{padding:.683em .828em 0 0;content:"D"}mjx-c.mjx-c1D452.TEX-I::before{padding:.442em .466em .011em 0;content:"e"}mjx-c.mjx-c1D459.TEX-I::before{padding:.694em .298em .011em 0;content:"l"}mjx-c.mjx-c1D44E.TEX-I::before{padding:.441em .529em .01em 0;content:"a"}mjx-c.mjx-c1D466.TEX-I::before{padding:.442em .49em .205em 0;content:"y"}mjx-c.mjx-c1D45B.TEX-I::before{padding:.442em .6em .011em 0;content:"n"}mjx-c.mjx-c1D45C.TEX-I::before{padding:.441em .485em .011em 0;content:"o"}mjx-c.mjx-c1D451.TEX-I::before{padding:.694em .52em .01em 0;content:"d"}mjx-c.mjx-c3D::before{padding:.583em .778em .082em 0;content:"="}mjx-c.mjx-c1D45D.TEX-I::before{padding:.442em .503em .194em 0;content:"p"}mjx-c.mjx-c1D45F.TEX-I::before{padding:.442em .451em .011em 0;content:"r"}mjx-c.mjx-c1D450.TEX-I::before{padding:.442em .433em .011em 0;content:"c"}mjx-c.mjx-c2B::before{padding:.583em .778em .082em 0;content:"+"}mjx-c.mjx-c1D45E.TEX-I::before{padding:.442em .46em .194em 0;content:"q"}mjx-c.mjx-c1D462.TEX-I::before{padding:.442em .572em .011em 0;content:"u"}mjx-c.mjx-c1D461.TEX-I::before{padding:.626em .361em .011em 0;content:"t"}mjx-c.mjx-c1D460.TEX-I::before{padding:.442em .469em .01em 0;content:"s"}mjx-c.mjx-c2212::before{padding:.583em .778em .082em 0;content:"−"}mjx-c.mjx-c1D441.TEX-I::before{padding:.683em .888em 0 0;content:"N"}mjx-c.mjx-c28::before{padding:.75em .389em .25em 0;content:"("}mjx-c.mjx-c29::before{padding:.75em .389em .25em 0;content:")"}mjx-c.mjx-c1D445.TEX-I::before{padding:.683em .759em .021em 0;content:"R"}mjx-c.mjx-c1D440.TEX-I::before{padding:.683em 1.051em 0 0;content:"M"}mjx-c.mjx-c1D456.TEX-I::before{padding:.661em .345em .011em 0;content:"i"}mjx-c.mjx-c31::before{padding:.666em .5em 0 0;content:"1"}mjx-c.mjx-c2C::before{padding:.121em .278em .194em 0;content:","}mjx-c.mjx-c32::before{padding:.666em .5em 0 0;content:"2"}mjx-c.mjx-c33::before{padding:.665em .5em .022em 0;content:"3"}mjx-c.mjx-c2E::before{padding:.12em .278em 0 0;content:"."}mjx-c.mjx-c1D439.TEX-I::before{padding:.68em .749em 0 0;content:"F"}mjx-c.mjx-c2F::before{padding:.75em .5em .25em 0;content:"/"}mjx-c.mjx-c1D44F.TEX-I::before{padding:.694em .429em .011em 0;content:"b"}mjx-c.mjx-c35::before{padding:.666em .5em .022em 0;content:"5"}mjx-c.mjx-c30::before{padding:.666em .5em .022em 0;content:"0"}mjx-c.mjx-c1D43E.TEX-I::before{padding:.683em .889em 0 0;content:"K"}mjx-c.mjx-c1D43B.TEX-I::before{padding:.683em .888em 0 0;content:"H"}</style><pre class="frontmatter language-yaml" tabindex="0" style="display: none;"><code class="language-yaml is-loaded"><span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> OS</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="6.5 Inter-Process Communications"><p dir="auto">6.5 Inter-Process Communications</p></h1><div class="el-h2 heading-wrapper"><h2 data-heading="第一课 IPC" dir="auto" class="heading" id="第一课_IPC"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第一课 IPC</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-h3 heading-wrapper"><h3 data-heading="1.1 IPC Motivation" dir="auto" class="heading" id="1.1_IPC_Motivation"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.1 IPC Motivation</h3><div class="heading-children"><div class="el-p"><p dir="auto">人类需要沟通和交流，交流与合作共同建造了我们这个美好的世界。在原始村落时代，人类只能通过面对面交流进行协作，沟通范围局限在同村居民之间。电话的发明打破了物理距离的壁垒，使跨地域的实时沟通成为可能，极大地扩展了协作的边界。</p></div><div class="el-p"><p dir="auto">对于进程也一样，在没有网络的时代，进程间通信只局限在一台主机上。随着网络基础设施的建设，我们已经进入了光纤入户(FTTH)的时代。进程间通信不再具有局限性，远距离的通信成为了可能。通过网络，分布在不同地理位置的进程可以互相通信，协同工作，共同完成复杂的任务。</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="1.3 IPC Types" dir="auto" class="heading" id="1.3_IPC_Types"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3 IPC Types</h3><div class="heading-children"><div class="el-p"><p dir="auto">我们有两类进程间通信，一类是同一台主机上的进程间通信，还有一类是不同主机之间的进程间通信。这两类进程间通信的主体思想都很简单，即发送方进程发送信息，接收方进程接收信息。</p></div><div class="el-p"><p dir="auto">不管是哪种进程间通信，你都需要考虑收发过程的同步和互斥问题、同步性和异步性，我们本节不做介绍，相关内容将在后续的同步互斥篇章进行介绍。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.3.1 IPC on the Same Machine" dir="auto" class="heading" id="1.3.1_IPC_on_the_Same_Machine"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.1 IPC on the Same Machine</h4><div class="heading-children"><div class="el-p"><p dir="auto">对于同一台主机上的进程间通信，其核心思想是<strong>在内核或用户空间创建共享存储区域</strong>，其中一个进程W往里面写，另外一个进程R往外读。这种模型本质上就是生产者-消费者问题的实现，需要同步机制来保证<strong>缓冲区空</strong>、<strong>缓冲区满</strong>和竟态条件的问题。共享存储器可以用<strong>内核缓冲区(pipe)</strong> 或 <strong>用户内存空间(Shared memory, shm)</strong> 的方式来实现。</p></div><div class="el-p"><p dir="auto">还有将数据放到磁盘中的IPC机制叫<strong>内存映射文件(Memory&nbsp;Mapped&nbsp;Files)</strong>。这种方法允许多个进程通过映射文件到共享内存的方式进行通信，并将数据持久化到磁盘上。</p></div><div class="el-p"><p dir="auto">此外，<strong>信号</strong>也是一种进程间通信方式。与上面不同的是，信号本身并不携带信息(messages)，因而也被称为轻量级的进程间通信机制。信号主要用于通知进程发送某些事件，比如终止、中断和自定义事件等。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.3.2 IPC on Different Machines" dir="auto" class="heading" id="1.3.2_IPC_on_Different_Machines"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.2 IPC on Different Machines</h4><div class="heading-children"><div class="el-p"><p dir="auto">如果两个进程不在同一台主机上，我们就需要借助网络的力量，使用操作系统提供的Socket&nbsp;API向特定的主机发送消息报文。对于上层应用者来说，完全可以将Socket看作是邮递数据的“邮政公司”。我们将数据交给“邮政公司”（Socket&nbsp;API），它们会妥善处理一切。</p></div><div class="el-p"><p dir="auto">通过Sockets，分布在不同主机上的进程可以建立连接，进行数据交换。这种方式广泛应用于网络应用、分布式系统和客户端-服务器模型中。</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="1.3 Send-Receive Protocol" dir="auto" class="heading" id="1.3_Send-Receive_Protocol"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3 Send-Receive Protocol</h3><div class="heading-children"><div class="el-h4 heading-wrapper"><h4 data-heading="1.3.1 Formats" dir="auto" class="heading" id="1.3.1_Formats"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.1 Formats</h4><div class="heading-children"><div class="el-p"><p dir="auto">进程间通信总是伴随着不同的格式进行的，正如人类交流一样。讲话方（发送方）使用不同的语言不同（不同的格式），如果聆听方听不懂那种语言（没有对应的parser函数），这种交流便是没有意义的。在进程间通信中，尽管信息都是以0和1在计算机世界中传输的，但只要规定了一定的格式，接收双方达成一定共识（使用同一种格式），交流就可以达成。</p></div><div class="el-p"><p dir="auto">常见的通信格式有JSON和XML，通过格式提供的约定，我们可以按照接收/发送之间的约定将信息进行包装(packet)和解码(parse)（也叫序列化和反序列化）。我们也可以使用官方所提供的库。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="1.3.2 Order" dir="auto" class="heading" id="1.3.2_Order"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.2 Order</h4><div class="heading-children"><div class="el-p"><p dir="auto">一旦涉及到信息的发送和接收，收发的顺序是需要有一定的约束的。</p></div><div class="el-h5 heading-wrapper"><h5 data-heading="1.3.2.1 Synchronous" dir="auto" class="heading" id="1.3.2.1_Synchronous"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.2.1 Synchronous</h5><div class="heading-children"><div class="el-p"><p dir="auto">同步通信要求发送方和接收方在某一特定时间点上进行协同。比方如，发送方必须等待接收方准备好接收数据后再发送。这种方式的优点是确保数据的可靠传输，但可能会导致等待时间的增加。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="1.3.2.2 Asynchronous" dir="auto" class="heading" id="1.3.2.2_Asynchronous"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>1.3.2.2 Asynchronous</h5><div class="heading-children"><div class="el-p"><p dir="auto">异步则允许发送方和接收方无需协同、独立工作。发送方在发送数据后可以继续处理其他任务，而接收方在准备好接收数据时再进行处理。这种方式提高了系统的并发性和效率，但需要额外的机制来确保数据的一致性和完整性。</p></div></div></div></div></div></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第二课 Sockets for Network Communication" dir="auto" class="heading" id="第二课_Sockets_for_Network_Communication"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第二课 Sockets for Network Communication</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-p"><p dir="auto">对于不同主机间的通信，虽然还有其他的方式，但我们主要借助 Socket API 来进行。尽管你可以用网络来交换进程之间的数据。但一般来说，socket 并不作为 IPC 的一部分。</p></div><div class="el-h3 heading-wrapper"><h3 data-heading="2.1 Sockets" dir="auto" class="heading" id="2.1_Sockets"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.1 Sockets</h3><div class="heading-children"><div class="el-p"><p dir="auto">Socket API的命名灵感来源于电源插座🔌(power socket)。当设备与电源插座连接时，插座允许设备连接并交换电流，当设备断开与电源插座的连接，电流的交换也随之结束。同样的道理，Socket API也允许不同的进程之间进行数据的交流。Socket API为上层应用封装屏蔽了下层传输层的细节。</p></div><div class="el-p"><p dir="auto">我们知道，传输层提供两种通信范式：<strong>数据报(datagram)</strong> 和 <strong>连接流(connection stream)</strong>。TCP是面向连接的传输层协议，为上层的应用提供可靠传输(reliable transfer)服务。TCP保证数据完整有序的送达。常见的使用TCP作为传输层协议的应用层协议有FTP、SMTP和HTTP。</p></div><div class="el-p"><p dir="auto">UDP是面向非连接的协议，它为上层应用提供不可靠的传输服务。由于UDP不需要建立连接，因此UDP不保证数据的完整性和顺序，但它的开销较小，传输速度较快。所以UDP比TCP更加简单高效。UDP常见于语音/视频通话和游戏中。</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="2.2 Sockets as Files" dir="auto" class="heading" id="2.2_Sockets_as_Files"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2 Sockets as Files</h3><div class="heading-children"><div class="el-p"><p dir="auto">在Linux等类Unix的系统中，socket也被视为一种文件。所以你能复用部分标准的文件处理（read、write）来操作socket。但是socket提供了一些其他的语义抽象。这种抽象简化了编程接口，你可以用socket系统调用来创建一个socket。</p></div><div class="el-p"><p dir="auto"><code>socket()</code>的函数原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. Domain: address format; 
		- AF_INET: IPv4
		- AF_INET6: IPv6
		- AF_UNIX or AF_LOCAL: Unix domain sockets
		- AF_PACKET: Low-level packet interface
	    - AF_NETLINK: Kernel/user-space communication
	    - et cetera...
	2. Type: what kind of data;
		- SOCK_DGRAM: Datagram socket (UDP)
	    - SOCK_STREAM: Stream socket (TCP)
	    - SOCK_RAW: Original socket (IPPROTO_RAW)
	    - SOCK_SEQPACKET
	3. Protocol: how data is transported; 0 for type inference
		- IPPROTO_TCP: Used with SOCK_STREAM for TCP
	    - IPPROTO_UDP: Used with SOCK_DGRAM for UDP
	    - IPPROTO_ICMP: Used with SOCK_RAW for sending/recving ICMP packets
		- IPPROTO_SCTP
Return value: 
	- Return a socketfd on success.
	- -1 on failure.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.2.1 socket() Attr." dir="auto" class="heading" id="2.2.1_socket()_Attr."><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.1 socket() Attr.</h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>socket()</code>系统调用有三个参数，分别是<code>domain</code>, <code>type</code> 和 <code>protocol</code>。</p></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.1.1 `domain`" dir="auto" class="heading" id="2.2.1.1_`domain`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.1.1 <code>domain</code></h5><div class="heading-children"><div class="el-p"><p dir="auto">这个参数定义了地址格式和通信范围，决定了socket的底层协议族。常见的有<code>AF_INET</code>, <code>AF_INET6</code> 和 <code>AF_UNIX/AF_LOCAL</code>。这里的<code>AF_</code>指的是Address Family。<code>AF_INET</code> 和 <code>AF_INET6</code>用于网络通信，其中一个用于IPv4，一个用于IPv6。它们的地址结构也是不一样的，分别是：<code>struct sockaddr_in</code>和<code>struct sockaddr_in6</code>。</p></div><div class="el-p"><p dir="auto"><code>AF_UNIX</code>或者<code>AF_LOCAL</code>，则用于本地的进程间通信。因为它并不涉及网络通信，所以没有网络协议栈封包拆包所造成的开销。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.1.2 `type`" dir="auto" class="heading" id="2.2.1.2_`type`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.1.2 <code>type</code></h5><div class="heading-children"><div class="el-p"><p dir="auto">这个参数定义了socket的类型，用于选择数据的传输方式和服务类型。我们关注<code>SOCK_STREAM</code>跟<code>SOCK_DGRAM</code>。前者，<code>SOCK_STREAM</code>定义socket的类型为可靠、有序和双向的面向连接的字节流（TCP），和<code>SOCK_DGRAM</code>，也就是将socket的类型定义为不可靠的无连接的数据报文。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.1.3 `protocol`" dir="auto" class="heading" id="2.2.1.3_`protocol`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.1.3 <code>protocol</code></h5><div class="heading-children"><div class="el-p"><p dir="auto">这个参数明确地指定传输层使用何种网络协议。我们关注<code>IPPROTO_TCP</code>和<code>IPPROTO_UDP</code>。当你设置为<code>0</code>时，内核会根据前两个参数自动推导。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.1.4 Illegal Combination" dir="auto" class="heading" id="2.2.1.4_Illegal_Combination"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.1.4 Illegal Combination</h5><div class="heading-children"><div class="el-p"><p dir="auto">当组合非法或不兼容，就会返回<code>-1</code>并设置<code>errno = EINVAL</code>。</p></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.2.2 Creating an Socket" dir="auto" class="heading" id="2.2.2_Creating_an_Socket"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.2 Creating an Socket</h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>socket()</code>函数中有许多参数，选择不同的参数，我们可以创建不同类型的socket。下面，我们将用IPv4创建一个TCP和一个UDP的传输协议的网络连接。</p></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.2.1 TCP Sockets in IPv4" dir="auto" class="heading" id="2.2.2.1_TCP_Sockets_in_IPv4"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.2.1 TCP Sockets in IPv4</h5><div class="heading-children"><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"TCP socket creation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.2.2 UDP Sockets in IPv4" dir="auto" class="heading" id="2.2.2.2_UDP_Sockets_in_IPv4"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.2.2 UDP Sockets in IPv4</h5><div class="heading-children"><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"UDP socket creation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.2.3. `setsockopt()`" dir="auto" class="heading" id="2.2.3._`setsockopt()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.3. <code>setsockopt()</code></h4><div class="heading-children"><div class="el-p"><p dir="auto">socket创建好之后，我们就可以使用<code>setsockopt</code>&nbsp;函数通过各种选项来配置和调整套接字。这个函数允许你控制和修改套接字的行为，比如超时时间、缓冲区大小、重用地址、启用或禁用特定协议特性等。在后面的学习中，检测另一方是否还在发送报文就少不了<code>setsockopt()</code>。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">int</span> optname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>optval<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> optlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. sockfd: The file descriptor of the socket on which to set the option.
	2. level: The level at which the option is defined (e.g., SOL_SOCKET for socket-level options, IPPROTO_TCP for TCP options).
	3. optname: The option name to set.
	   - Under SOL_SOCKET level:
	     1. SO_RCVTIMEO: set receive timeout time.
	     2. SO_SNDTIMEO: set send timeout time.
	     3. SO_REUSEADDR: allow local address reuse.
	     4. SO_KEEPALIVE: keep connections alive by enabling periodic transmissions.
	     5. SO_RCVBUF: set the receive buffer size.
	     6. SO_SNDBUF: set the send buffer size.
	     7. SO_LINGER: linger on close if data is present.
	     8. SO_BROADCAST: permit sending of broadcast messages.
	     9. SO_ERROR: retrieve and clear the socket error status.
	     10. SO_OOBINLINE: leave received out-of-band data in the input stream.
	   - Under IPPROTO_TCP level:
	     1. TCP_NODELAY: disable Nagle's algorithm.
	     2. TCP_KEEPIDLE: set the idle time before keep-alive probes are sent.
	     3. TCP_KEEPINTVL: set the interval between keep-alive probes.
	     4. TCP_KEEPCNT: set the number of keep-alive probes to be sent.
	   - Under IPPROTO_IP level:
	     1. IP_TTL: set the IP time-to-live value.
	     2. IP_MULTICAST_TTL: set the multicast time-to-live value.
	     3. IP_MULTICAST_LOOP: control the loopback of multicast packets.
	     4. IP_ADD_MEMBERSHIP: join a multicast group.
	     5. IP_DROP_MEMBERSHIP: leave a multicast group.
	   - Under IPPROTO_IPV6 level:
	     1. IPV6_V6ONLY: restrict the socket to IPv6 communications only.
	     2. IPV6_MULTICAST_HOPS: set the multicast hop limit.
	     3. IPV6_MULTICAST_LOOP: control the loopback of multicast packets.
	     4. IPV6_JOIN_GROUP: join an IPv6 multicast group.
	     5. IPV6_LEAVE_GROUP: leave an IPv6 multicast group.
	4. optval: A pointer to the buffer containing the value for the option. This buffer contains the value to be set for the specified option.
	5. optlen: The size, in bytes, of the buffer pointed to by optval.

Return value:
	- On success: Returns 0.
	- On failure: Returns -1, and errno is set to indicate the error. You can use the perror function or strerror to print the error message.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.2.4 Endianness and Network Byte Order" dir="auto" class="heading" id="2.2.4_Endianness_and_Network_Byte_Order"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.4 Endianness and Network Byte Order</h4><div class="heading-children"><div class="el-p"><p dir="auto">我们在<a data-href="Endianness" href="some-notes/endianness.html" class="internal-link" target="_self" rel="noopener nofollow">Endianness</a>中对大小端字节序进行了介绍。在网络传输中，为了避免两台计算机因为大小端问题产生的一系列问题，我们规定将大端序作为网络字节序（历史原因）。这样做不但统一了计算机网络的交流方式，也使得工程师抓包后方便阅读各种信息。</p></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.4.1 Host&nbsp;and&nbsp;Network&nbsp;Byte&nbsp;Order&nbsp;Conversion" dir="auto" class="heading" id="2.2.4.1_Host&nbsp;and&nbsp;Network&nbsp;Byte&nbsp;Order&nbsp;Conversion"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.4.1 Host&nbsp;and&nbsp;Network&nbsp;Byte&nbsp;Order&nbsp;Conversion</h5><div class="heading-children"><div class="el-p"><p dir="auto">在<code>arpa/inet.h</code>头文件中，提供了一些转换字节序的库函数。如果你不清楚你所用系统的字节序，建议加上这些转换函数来确保数据在网络上传输时的正确性：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token comment">// Host TO Network Long/Short</span>
<span class="token class-name">uint32_t</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> hostlong<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">uint16_t</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> hostshort<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// Network TO Host Long/Short</span>
<span class="token class-name">uint32_t</span> <span class="token function">ntohl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> netlong<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">uint16_t</span> <span class="token function">ntohs</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> netshort<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.4.2 Decimal Presentation and&nbsp;Network Byte Order Address Conversion" dir="auto" class="heading" id="2.2.4.2_Decimal_Presentation_and&nbsp;Network_Byte_Order_Address_Conversion"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.4.2 Decimal Presentation and&nbsp;Network Byte Order Address Conversion</h5><div class="heading-children"><div class="el-p"><p dir="auto">除此之外，<code>arpa/inet.h</code>头文件中还有将点分十进制（十六进制）与网络字节序数值进行转换的库函数。这些转换在设置或接收网络地址时非常有用。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token operator">*</span>inp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. cp: IP address in decimal form (as a string, e.g., "192.168.1.1")
	2. inp: Pointer to a struct in_addr where the function will store the network address

Return value: Returns 1 on success, 0 if the input is not a valid IP address.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token comment">// Internet Presentation TO Network</span>
<span class="token keyword">int</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span><span class="token keyword">int</span> af<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. af: Address family (AF_INET for IPv4, AF_INET6 for IPv6)
	2. src: IP address in decimal form (as a string, e.g., "192.168.1.1")
	3. dst: Pointer to a buffer where the function will store the network address (usually a struct in_addr or struct in6_addr) 

Return value: Returns 1 on success, 0 if inputs is not a valid IP address, and -1 on error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token comment">// Internet Network TO Presentation</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span><span class="token keyword">int</span> af<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. af: Address family (AF_INET for IPv4, AF_INET6 for IPv6)
	2. src: Pointer to the network address structure (e.g., struct in_addr or struct in6_addr)
	3. dst: Pointer to a buffer where the function will store the IP address in decimal form (as a string)
	4. size: Size of the destination buffer 

Return value: 
	- Returns a pointer to the destination buffer `dst` on success. 
	- NULL on failure.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.2.5 Socket Addresses" dir="auto" class="heading" id="2.2.5_Socket_Addresses"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.5 Socket Addresses</h4><div class="heading-children"><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.5.1 IPv4 Address" dir="auto" class="heading" id="2.2.5.1_IPv4_Address"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.5.1 IPv4 Address</h5><div class="heading-children"><div class="el-p"><p dir="auto">和发快递时你需要知道对方的地址信息一样，当我们在网络上传输报文时，你需要用一种约定好的格式来创建一个address structure。我们用&nbsp;<code>sockaddr_in</code>&nbsp;结构体来表示IPv4地址：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span> sin_family<span class="token punctuation">;</span> <span class="token comment">// Address Family</span>
    <span class="token class-name">in_port_t</span> sin_port<span class="token punctuation">;</span>     <span class="token comment">// Port number</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span> <span class="token comment">// IP address</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> s_addr<span class="token punctuation">;</span> <span class="token comment">// 32-bit IPv4 address</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.5.2 IPv6 Address" dir="auto" class="heading" id="2.2.5.2_IPv6_Address"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.5.2 IPv6 Address</h5><div class="heading-children"><div class="el-p"><p dir="auto">我们用<code>addrinfo</code>来表示IPv6的套接字的地址信息。这个结构体是一个通用的结构体，能够表示各种不同类型的地址。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span>              ai_flags<span class="token punctuation">;</span>
    <span class="token keyword">int</span>              ai_family<span class="token punctuation">;</span>
    <span class="token keyword">int</span>              ai_socktype<span class="token punctuation">;</span>
    <span class="token keyword">int</span>              ai_protocol<span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span>        ai_addrlen<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>ai_addr<span class="token punctuation">;</span>
    <span class="token keyword">char</span>            <span class="token operator">*</span>ai_canonname<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>ai_next<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.5.3 Local Domain Address" dir="auto" class="heading" id="2.2.5.3_Local_Domain_Address"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.5.3 Local Domain Address</h5><div class="heading-children"><div class="el-p"><p dir="auto">此外，我们还有<code>sockaddr_un</code>结构体用于表示Unix domain sockets:</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/un.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span> <span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span> sun_family<span class="token punctuation">;</span> <span class="token comment">// Address Family (AF_UNIX)</span>
    <span class="token keyword">char</span> sun_path<span class="token punctuation">[</span><span class="token number">108</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">// Path name</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.5.4 Port Number: Just Like the House Number" dir="auto" class="heading" id="2.2.5.4_Port_Number:_Just_Like_the_House_Number"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.5.4 Port Number: Just Like the House Number</h5><div class="heading-children"><div class="el-p"><p dir="auto">每当主机上有运行一个程序，那个程序就会注册一个端口号以便标识程序的入口。计算机上有多个端口（一般为 65536 个），通过这些端口，数据可以准确的发送道正确的进程处。向邮递员用门牌号来发件送件一样，网络通信也需要这些端口号来接收数据。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.5.5 String <---> IP Address" dir="auto" class="heading" id="2.2.5.5_String_<--->_IP_Address"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.5.5 String &lt;---&gt; IP Address</h5><div class="heading-children"><div class="el-p"><p dir="auto">在定义并初始化IPv4/IPv6的套接字结构体时，我们需要把人类可读的字符串转换成机器可读的IP地址格式以便路由器和其他网络设备能够进行正常的处理和数据包路由。</p></div><div class="el-p"><p dir="auto">我们前面在<a data-tooltip-position="top" aria-label="6.5 Inter-Process Communications > 2.2.4.2 Decimal Presentation and Network Byte Order Address Conversion" data-href="6.5 Inter-Process Communications#2.2.4.2 Decimal Presentation and Network Byte Order Address Conversion" href="congzhi's-os-series/6.5-inter-process-communications.html#2.2.4.2_Decimal_Presentation_and_Network_Byte_Order_Address_Conversion" class="internal-link" target="_self" rel="noopener nofollow">这里</a>讨论了一点IP地址和Sting互相转换的库函数。其中<code>inet_aton</code>用于将IPv4地址从点分十进制字符转换成二进制格式。而后者<code>inet_pton</code>是更通用的函数，支持IPv4和IPv6的地址转换。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.2.5.6 Initial the Network Address (IPv4)" dir="auto" class="heading" id="2.2.5.6_Initial_the_Network_Address_(IPv4)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.5.6 Initial the Network Address (IPv4)</h5><div class="heading-children"><div class="el-p"><p dir="auto">网络地址定义好之后，我们需要按照特定的顺序来初始化&nbsp;<code>sockaddr_in</code>&nbsp;结构体的各个字段。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span> <span class="token comment">// for memset</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Clear the addr structure</span>
    addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span> <span class="token comment">// Use IPv4.</span>
    addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Indicate the port number.</span>
    addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"192.168.1.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// inet_addr(INADDR_ANY); </span>
    <span class="token comment">// or inet_pton(AF_INET, "192.128.1.1", &amp;addr.sin_addr); // Recommended</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Address: %s, Port: %d\n"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.2.6 Get the Address" dir="auto" class="heading" id="2.2.6_Get_the_Address"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.2.6 Get the Address</h4><div class="heading-children"><div class="el-p"><p dir="auto">这个函数的主要作用是将主机名（如"example.com"）或服务名（如&nbsp;"http"）转换为可以用于创建套接字的地址信息。通常是客户端用来获取服务器端的网络地址信息来创建想要的套接字。得到服务器的地址，客户端就可以与服务器建立连接。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>node<span class="token punctuation">,</span>    <span class="token comment">// e.g. "www,example.com" or IP</span>
				<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">,</span> <span class="token comment">// e.g. "http" or port number</span>
				<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>hints<span class="token punctuation">,</span>
				<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 
Parameters:
	1. node: hostname or IP address
	2. service: protocol or port number
	3. hints: used to restrict the kind of connection you want
	4. res: pointer to be updated with the result

Return value: 
	- Returns 0 on success, and update the pointer res points to. 
	- Else on error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">当我们使用<code>getaddrinfo</code>时，会返回结构体<code>addrinfo</code>，通过其中的<code>ai_addr</code>字段，我们可以得到指向的<code>sockaddr_in</code>结构体。如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">"example.com"</span><span class="token punctuation">,</span> <span class="token string">"http"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span>ipv4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span><span class="token punctuation">)</span>res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="2.3 Client Workflow: Connect (TCP)" dir="auto" class="heading" id="2.3_Client_Workflow:_Connect_(TCP)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3 Client Workflow: Connect (TCP)</h3><div class="heading-children"><div class="el-p"><p dir="auto">我们将主机上的不同的进程用端口号进行标识，在网络的进程间通信中，我们只要知道主机的地址（即IP地址）和端口号，我们就能和那个“远方的”进程进行通信。在网络通信中，客户端要做到实际上远不及服务器端做的多。客户端要做的，就是打招呼（<code>connect()</code>）并说话（socket通信）。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.3.1 `connect()`" dir="auto" class="heading" id="2.3.1_`connect()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.1 <code>connect()</code></h4><div class="heading-children"><div class="el-p"><p dir="auto">下面，我们看看客户端是如何通过<code>connect()</code>来与服务器打招呼的，以下是其函数原型：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Blocking the thread by default.
Parameters:
	1. sockfd: The file descriptor for the socket to be connected. This is the integer value returned by the socket() function.
	2. addr: A pointer to a struct sockaddr, which contains the address of the target host. This can be cast to a pointer of specific address types, like sockaddr_in for IPv4 or sockaddr_in6 for IPv6.
	3. len: The size, in bytes, of the address structure pointed to by addr. Typically, this will be sizeof(struct sockaddr_in) or sizeof(struct sockaddr_in6).

Return value:
	- On success: Returns 0.
	- On failure: Returns -1, and errno is set to indicate the error. You can use the perror function or strerror to print the error message.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.3.2 Say Hello to Server" dir="auto" class="heading" id="2.3.2_Say_Hello_to_Server"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.3.2 Say Hello to Server</h4><div class="heading-children"><div class="el-p"><p dir="auto">在之前，我们学过了<code>getaddrinfo</code>函数，通过这个函数，我们就可以得到服务器的网络地址。在客户端眼中，我们就知道了服务器叫什么名字了。知道了网络地址，我们就可以通过<code>connect</code>函数来与服务器建立连接，为之后的交流做好铺垫。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>hints<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>

<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">"www.example.com"</span><span class="token punctuation">,</span> <span class="token string">"80"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">在这个例子中，如果返回值<code>status</code>为 0 就表示服务器收到了我们的连接请求并成功建立连接。</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="2.4 Server Workflow: Bind, Listen and Accept (TCP)" dir="auto" class="heading" id="2.4_Server_Workflow:_Bind,_Listen_and_Accept_(TCP)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.4 Server Workflow: Bind, Listen and Accept (TCP)</h3><div class="heading-children"><div class="el-p"><p dir="auto">在网络通信中，服务器的职责可比客户端大得多。要和服务器打招呼，客户端可不需要知道自己的名字是什么，操作系统会自动为客户端分配一个临时的端口号。而服务器可不一样，因为要时时刻刻监听来自客户端的连接请求。服务器必须显式调用<code>bind()</code>将套接字<strong>绑定</strong>到特定的端口号上。（毕竟要是你的名字要是随机的，客户端对建立连接将毫无头绪）</p></div><div class="el-p"><p dir="auto">绑定完成之后，服务器开始运行并需要持续<strong>监听</strong>来自外界的连接请求，以便对客户端进行服务。当服务器监听到来自客户端的连接请求之后，客户端会接受并建立一个专门的套接字来于这个特定的客户端进行通讯。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.4.1 `bind()`" dir="auto" class="heading" id="2.4.1_`bind()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.4.1 <code>bind()</code></h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>bind()</code>函数用来让进程与一个特定的端口号进行绑定的函数。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. sockfd: The file descriptor of the socket to be bound. This is the integer value returned by the socket() function.
	2. addr: A pointer to a struct sockaddr, which contains the address to bind to the socket. This can be cast to a pointer of specific address types, like sockaddr_in for IPv4 or sockaddr_in6 for IPv6.
	3. addrlen: The size, in bytes, of the address structure pointed to by addr. Typically, this will be sizeof(struct sockaddr_in) or sizeof(struct sockaddr_in6).

Return value:
	- On success: Returns 0.
	- On failure: Returns -1, and errno is set to indicate the error. You can use the perror function or strerror to print the error message.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><strong>例子1</strong>：</p></div><div class="el-pre"><pre class="language-cpp" tabindex="0"><code data-line="0" class="language-cpp is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span>

    sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Other code...</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">客户端进程的<code>bind()</code>并不是必要的，为什么？</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.4.2 `listen()`" dir="auto" class="heading" id="2.4.2_`listen()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.4.2 <code>listen()</code></h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>listen()</code>&nbsp;函数用于将套接字设置为被动模式，以便接受传入的连接请求。<code>listen()</code>系统调用会创建一个容量为<code>backlog</code>的队列保存未处理的客户端请求。我们会人为地设置一个<code>backlog</code>。当客户端与服务器的连接数等于这个数字时，客户端的连接将被服务器拒绝。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. sockfd: The file descriptor of the socket that will be put into a listening state. This is the integer value returned by the socket() function.
	2. backlog: The maximum length to which the queue of pending connections may grow. Typically a small positive integer.

Return value:
	- On success: Returns 0.
	- On failure: Returns -1, and errno is set to indicate the error. You can use the perror function or strerror to print the error message.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><strong>例子2</strong>：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token comment">// Assume the bind() function has been called</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Other code...</span>
<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.4.3 `accept()`" dir="auto" class="heading" id="2.4.3_`accept()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.4.3 <code>accept()</code></h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>accept()</code>&nbsp;函数用于接受传入的连接请求，从监听套接字队列中提取第一个连接请求，并为新的连接创建一个新的套接字。<code>accept</code>是一个阻塞调用(blocking call)，当调用<code>accept</code>时，客户端对服务器的监听将会被阻塞。也就是说，每一次服务器只能接受一个客户端的连接。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. sockfd: The file descriptor of the listening socket. This is the integer value returned by the socket() function and used by the bind() and listen() functions.
	2. addr: A pointer to a struct sockaddr, which will be filled with the address of the connecting entity. Can be cast to a pointer of specific address types, like sockaddr_in for IPv4 or sockaddr_in6 for IPv6.
	3. addrlen: A pointer to a socklen_t, which on input contains the size of addr, and on output contains the size of the address returned.

Return value:
	- On success: Returns a new file descriptor for the accepted socket.
	- On failure: Returns -1, and errno is set to indicate the error. You can use the perror function or strerror to print the error message.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><strong>例子3</strong>：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded">    <span class="token comment">// Assume bind() and listen() functions have been called</span>

    sin_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    new_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sin_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>new_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Connection accepted"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>

    <span class="token comment">// Other code...</span>
    <span class="token function">close</span><span class="token punctuation">(</span>new_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">如果你不关心客户端是谁，你可以将<code>accept()</code>后面的字段设置成NULL。届时，服务器就不需要存储客户端的这些信息了，简化了代码。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> new_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">上面的例子中<code>accept</code>获得的新的文件描述符<code>new_fd</code>代表了与客户端的连接。你可以使用这个套接字进行接收和发送数据，而不需要手动维护客户端的地址信息。</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="2.5 Communication (TCP)" dir="auto" class="heading" id="2.5_Communication_(TCP)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.5 Communication (TCP)</h3><div class="heading-children"><div class="el-p"><p dir="auto">当连接建立、一切准备就绪之后，通信就可以开始了。在TCP的网络通信中，我们主要使用<code>send()</code>和<code>recv()</code>两个函数来发送和接收信息。</p></div><div class="el-p"><p dir="auto">因为套接字也可以看成是一种特殊的文件，所以你也可以使用最底层的<code>read()</code>和<code>write()</code>系统调用来接收和发送网络信息。在使用<code>read()</code>时，你需要通过循环一直接收数据，因为你不知道要接收多少数据。在<code>write()</code>时，你也需要使用循环来确保所有数据都能够发出去（缓存满）。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.5.1 `send()`" dir="auto" class="heading" id="2.5.1_`send()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.5.1 <code>send()</code></h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>send()</code>&nbsp;函数用于通过套接字发送数据。它将指定缓冲区中的数据发送到与套接字关联的另一端。<code>send()</code>操作是阻塞的，即如果套接字发送缓冲区已满，<code>send()</code>&nbsp;调用将阻塞，直到有足够的缓冲空间为止。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> msg<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters
	1. sockfd: Socket to send the data to
	2. msg: Bytes of data to be sent
	3. length: Size of the message
	4. flags: Options, giving in 0 will suffice, common flags are:
	    - MSG_CONFIRM: Tell the link layer that the packet was received.
	    - MSG_DONTWAIT: Enable non-blocking operation.
	    - MSG_OOB: Send out-of-band data.
	    - MSG_PEEK: Peek at the incoming message.
	    - MSG_WAITALL: Wait for the full request or error.
	    - MSG_NOSIGNAL: Do not generate SIGPIPE.
	    - MSG_MORE: Sender will send more data.

Return value: number of bytes sent, returns -1 if something went wrong
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.5.2 `recv()`" dir="auto" class="heading" id="2.5.2_`recv()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.5.2 <code>recv()</code></h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>recv()</code>&nbsp;函数用于通过套接字接收数据。它会从指定的套接字接收数据并将其存储在缓冲区中。与&nbsp;<code>send()</code>&nbsp;类似，<code>recv()</code>也是阻塞的，即如果没有可用数据，<code>recv()</code>&nbsp;将阻塞程序，直到数据到达。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">recv</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters
	1. sockfd: Where to receive data from
	2. buffer: Where the data goes
	3. length: The maximum size of the buffer
	4. flags: Flags can also be 0 here, common flags are:
	    - MSG_CONFIRM: Tell the link layer that the packet was received.
	    - MSG_DONTWAIT: Enable non-blocking operation.
	    - MSG_OOB: Receive out-of-band data.
	    - MSG_PEEK: Peek at the incoming message.
	    - MSG_WAITALL: Wait for the full request or error.
	    - MSG_NOSIGNAL: Do not generate SIGPIPE.

Return value: 
	- Returns the number of bytes actually read into the buffer on success.
	- Returns 0 if the connection has been closed.
	- Returns -1 on error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.5.3 Are You Still There?" dir="auto" class="heading" id="2.5.3_Are_You_Still_There?"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.5.3 Are You Still There?</h4><div class="heading-children"><div class="el-p"><p dir="auto">知道另一方是否还在发送报文并不容易。但是我们有一些机制来检测对方是否仍然在传输数据。我们的想法是，当一端发送了报文，一段时间后仍未接受到向本端发来的响应报文就断开连接。用这种方法防止程序一直阻塞下去。</p></div><div class="el-p"><p dir="auto">这里，我们主要通过通过<code>setsockopt</code>设置超时时间、启用Keep-Alive等各种套接字属性。</p></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.5.3.1 TCP Keep-Alive" dir="auto" class="heading" id="2.5.3.1_TCP_Keep-Alive"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.5.3.1 TCP Keep-Alive</h5><div class="heading-children"><div class="el-p"><p dir="auto">TCP协议本身支持&nbsp;Keep-Alive&nbsp;机制，用于检测空闲连接是否仍然活跃。通过在协议层面发送探测报文并等待响应，可以判断连接的状态。可以使用<code>setsockopt</code>函数在应用程序中启用这项功能。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">enable_tcp_keepalive</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Enable keep-alive.</span>
    <span class="token keyword">int</span> optval <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_KEEPALIVE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>optval<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>optval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> keepidle <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span> <span class="token comment">// 空闲时间（秒）</span>
    <span class="token keyword">int</span> keepinterval <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// 探测报文发送间隔（秒）</span>
    <span class="token keyword">int</span> keepcount <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 最大重试次数</span>

    <span class="token function">setsockopt</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">,</span> TCP_KEEPIDLE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>keepidle<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>keepidle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">,</span> TCP_KEEPINTVL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>keepinterval<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>keepinterval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">,</span> TCP_KEEPCNT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>keepcount<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>keepcount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">上面的例子中，我们启用了TCP所提供的Keep-alive机制。之后，我们还设置了其余几项参数：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto"><strong>keepidle</strong>：表示如果连接在keepidel秒内没有任何活动，开始发送Keep-Alive探测报文。</li>
<li data-line="1" dir="auto"><strong>keepinterval</strong>：表示每隔多少秒发送一次探测报文，直到收到对方的响应或达到最大重试次数。</li>
<li data-line="2" dir="auto"><strong>keepcount</strong>：表示在未收到对方响应时，最多发送keepcount次探测报文。如果在尝试这么多次后仍未收到响应，就认为连接已断开。</li>
</ol></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.5.3.2 Timeouts" dir="auto" class="heading" id="2.5.3.2_Timeouts"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.5.3.2 Timeouts</h5><div class="heading-children"><div class="el-p"><p dir="auto">通过设置接收超时时间，可以在指定时间内没有接收到数据时断开连接。这种方法对突发性传输较为有效，但可能会误判传输较慢的情形。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">set_recv_timeout</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> seconds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> timeout<span class="token punctuation">;</span>
    timeout<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> seconds<span class="token punctuation">;</span>
    timeout<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_RCVTIMEO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>timeout<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setsockopt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.5.3.3 Heartbeat Messages" dir="auto" class="heading" id="2.5.3.3_Heartbeat_Messages"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.5.3.3 Heartbeat Messages</h5><div class="heading-children"><div class="el-p"><p dir="auto">通过定期发送心跳包（短的空数据包）来确认连接是否保持。对方收到心跳包时，需要回复一个确认包。如果没有收到确认包，可以认为连接已经断开。心跳检测需要客户端和服务器两端共同配合。在客户端，同样需要处理心跳消息，并回复服务器发送的心跳包。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token comment">// server-side code</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>heartbeat <span class="token operator">=</span> <span class="token string">"HEARTBEAT"</span><span class="token punctuation">;</span>
    <span class="token function">send</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> heartbeat<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>heartbeat<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> bytes_received <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_received <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EWOULDBLOCK <span class="token operator">||</span> errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Receive timeout, no data received\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Received heartbeat response: %.*s\n"</span><span class="token punctuation">,</span> bytes_received<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// client side code</span>
<span class="token comment">// ...</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">这个例子仍需完善，因为没有结合超时机制，如果另一方一直不发送响应报文就会使得<code>recv()</code>调用无限期阻塞下去。</p></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.5.4 Use Format to Serialization" dir="auto" class="heading" id="2.5.4_Use_Format_to_Serialization"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.5.4 Use Format to Serialization</h4><div class="heading-children"><div class="el-p"><p dir="auto">Sending and Receiving Struct Type. XML and JSON are popular format for information transfer.</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="2.6 Datagrams" dir="auto" class="heading" id="2.6_Datagrams"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.6 Datagrams</h3><div class="heading-children"><div class="el-p"><p dir="auto">不同于TCP，UDP是粗鲁的、没有教养的，因为UDP忽略了打招呼的过程。同时，UDP不保证数据包到达的完整性，因而UDP被称为无连接的、轻量级的通信协议。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.6.1 sendto()" dir="auto" class="heading" id="2.6.1_sendto()"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.6.1 sendto()</h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>sendto</code>&nbsp;函数用于在无连接（如UDP）套接字上发送数据报（datagram）。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">sendto</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>dest_addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. sockfd: The socket file descriptor.
	2. msg: A pointer to the buffer containing the message to be sent.
	3. len: The length of the message in bytes.
	4. flags: Options to modify the behavior of the function.
	5. dest_addr: A pointer to the struct sockaddr containing the destination address.
	6. addrlen: The size of the destination address structure.

Return value:
	- On success: Returns the number of bytes sent.
	- On failure: Returns -1, and errno is set to indicate the error. You can use the perror function or strerror to print the error message.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.6.2 recvfrom()" dir="auto" class="heading" id="2.6.2_recvfrom()"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.6.2 recvfrom()</h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>recvfrom</code>&nbsp;函数用于在无连接（如UDP）套接字上接收数据报（datagram）。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>src_addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. sockfd: The socket file descriptor.
	2. buf: A pointer to the buffer where the received message will be stored.
	3. len: The length of the buffer.
	4. flags: Options to modify the behavior of the function.
	5. src_addr: A pointer to the struct sockaddr where the source address will be stored. Can be NULL.
	6. addrlen: A pointer to a socklen_t object which will contain the size of the source address structure.

Return value:
	- On success: Returns the number of bytes received.
	- On failure: Returns -1, and errno is set to indicate the error. You can use the perror function or strerror to print the error message.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="2.7 cURL (libcurl)" dir="auto" class="heading" id="2.7_cURL_(libcurl)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.7 cURL (libcurl)</h3><div class="heading-children"><div class="el-p"><p dir="auto">This part will be discussed in the <a data-href="14. Asynchronous IO" href="congzhi's-os-series/14.-asynchronous-io.html" class="internal-link" target="_self" rel="noopener nofollow">14. Asynchronous IO</a>.</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.7.1 Webservices" dir="auto" class="heading" id="2.7.1_Webservices"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.7.1 Webservices</h4><div class="heading-children"><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;curl/curl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    CURL <span class="token operator">*</span>curl<span class="token punctuation">;</span>
    CURLcode res<span class="token punctuation">;</span>

    <span class="token function">curl_global_init</span><span class="token punctuation">(</span>CURL_GLOBAL_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    curl <span class="token operator">=</span> <span class="token function">curl_easy_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>curl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">curl_easy_setopt</span><span class="token punctuation">(</span>curl<span class="token punctuation">,</span> CURLOPT_URL<span class="token punctuation">,</span> <span class="token string">"http://example.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_easy_setopt</span><span class="token punctuation">(</span>curl<span class="token punctuation">,</span> CURLOPT_FOLLOWLOCATION<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res <span class="token operator">=</span> <span class="token function">curl_easy_perform</span><span class="token punctuation">(</span>curl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">!=</span> CURLE_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"curl_easy_perform() failed: %s\n"</span><span class="token punctuation">,</span> <span class="token function">curl_easy_strerror</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">curl_easy_cleanup</span><span class="token punctuation">(</span>curl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">curl_global_cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="2.7.2 Callbacks Setting Up" dir="auto" class="heading" id="2.7.2_Callbacks_Setting_Up"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.7.2 Callbacks Setting Up</h4><div class="heading-children"><div class="el-h5 heading-wrapper"><h5 data-heading="2.7.2.1 Read Callback" dir="auto" class="heading" id="2.7.2.1_Read_Callback"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.7.2.1 Read Callback</h5><div class="heading-children"><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token class-name">size_t</span> <span class="token function">read_callback</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nitems<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>inputdata<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// size_t: represents a size and can be treated like an integer</span>
<span class="token comment">// buffer: the area where you are going to put the data to send</span>
<span class="token comment">// nitems: the number of items</span>
<span class="token comment">// return value: the number of bytes successfully put there, 0 signals EOF</span>

</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.7.2.2 Write Callback" dir="auto" class="heading" id="2.7.2.2_Write_Callback"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.7.2.2 Write Callback</h5><div class="heading-children"><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token class-name">size_t</span> <span class="token function">write_callback</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nmemb<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>userdata<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// size_t: represents a size and can be treated like an integer</span>
<span class="token comment">// ptr: points to whatever data we have received</span>
<span class="token comment">// nmemb: the size of the data</span>
<span class="token comment">// size: always 1</span>
<span class="token comment">// userdata: arbitrary structure we get to pass directly to this punction</span>
<span class="token comment">// return value: number of bytes processed</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="2.7.2.3 Registration of Callback" dir="auto" class="heading" id="2.7.2.3_Registration_of_Callback"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>2.7.2.3 Registration of Callback</h5><div class="heading-children"><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded">CURLcode <span class="token function">curl_easy_setopt</span><span class="token punctuation">(</span>CURL <span class="token operator">*</span>handle<span class="token punctuation">,</span> CURLOPT_READFUNCTION<span class="token punctuation">,</span> read_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
CURLcode <span class="token function">curl_easy_setopt</span><span class="token punctuation">(</span>CURL <span class="token operator">*</span>handle<span class="token punctuation">,</span> CURLOPT_READDATA<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>

CURLcode <span class="token function">curl_easy_setopt</span><span class="token punctuation">(</span>CURL <span class="token operator">*</span>handle<span class="token punctuation">,</span> CURLOPT_WRITEFUNCTION<span class="token punctuation">,</span> write_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
CURLcode <span class="token function">curl_easy_setopt</span><span class="token punctuation">(</span>CURL <span class="token operator">*</span>handle<span class="token punctuation">,</span> CURLOPT_WRITEDATA<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第三课 Pipes and Shared Memory" dir="auto" class="heading" id="第三课_Pipes_and_Shared_Memory"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第三课 Pipes and Shared Memory</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-h3 heading-wrapper"><h3 data-heading="3.1 UNIX Pipes" dir="auto" class="heading" id="3.1_UNIX_Pipes"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1 UNIX Pipes</h3><div class="heading-children"><div class="el-p"><p dir="auto">当我们用<strong>管道</strong>机制进行进程间通信时，操作系统会在内核空间中划分额外的内核空间用于数据共享。Pipe是单向传输的（像水管一样），一个管道的数据<strong>只能向一个方向流动（写端到读端）</strong>，所用如果你想实现<strong>全双工则需要两个管道</strong>。管道有两种实现机制：<code>pipe()</code>和<code>mkfifo()</code>。</p></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20241130023253.jpg" src="Pasted image 20241130023253.jpg" class="internal-embed media-embed image-embed is-loaded"><img alt="Pasted image 20241130023253.jpg" src="congzhi's-os-series/pics/pasted-image-20241130023253.jpg"></span></p></div><div class="el-p"><p dir="auto">Pipe一般上是<strong>循环队列</strong>，管道缓冲区的大小（Linux上）通常是4KB-64KB之间。<strong>管道以字节流的方式通信</strong>，发送方每一次发送都会将消息分为很多个小块（一字节）之后将字节块放入队列中，然后接收方会一个字节一个字节的接收数据。<strong><code>pipe</code>的系统调用提供同步机制（阻塞锁）</strong>，如果缓冲区已满/为空时，写操作/读操作就会被阻塞，直到数据被读出/写入。命名和匿名管道而言都是如此。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="3.1.1 Ordinary Pipes(Anonymous Pipes)" dir="auto" class="heading" id="3.1.1_Ordinary_Pipes(Anonymous_Pipes)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.1 Ordinary Pipes(Anonymous Pipes)</h4><div class="heading-children"><div class="el-p"><p dir="auto">在类Unix的系统中，你可以用<code>pipe()</code>系统调用函数来创建用于进程间通信的匿名管道。<strong>匿名管道只能在有血缘关系的进程之间使用</strong>。匿名管道的创建函数如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token function">pipe</span><span class="token punctuation">(</span><span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// pipefd[0] is the read-end</span>
<span class="token comment">// pipefd[1] is the write-end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h5 heading-wrapper"><h5 data-heading="3.1.1.1 Creating an Anonymous Pipe" dir="auto" class="heading" id="3.1.1.1_Creating_an_Anonymous_Pipe"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.1.1 Creating an Anonymous Pipe</h5><div class="heading-children"><div class="el-p"><p dir="auto">下面，我们举个创建匿名管道的例子：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str <span class="token operator">=</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> rdBuf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe create fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this is child process\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">memset</span><span class="token punctuation">(</span>readBuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rdBuf<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I have read the character string: %s\n"</span><span class="token punctuation">,</span>rd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this is parent process\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">参数<code>pipefd</code>是一个包含两个整型元素的数组，用来存放管道的读写文件描述符。</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><code>pipefd[0]</code>是管道的读端，<code>read(pipefd[0], buffer, sizeof(buffer))</code>从管道中读出并写到<code>buffer</code>中。</li>
<li data-line="1" dir="auto"><code>pipefd[1]</code>是管道的写端，<code>write(pipefd[1]), message, strlen(message) + 1)</code> 将message中的数据写到管道里面。<br>
当<code>pipe</code>系统调用成功，返回0，失败返回-1并设置<code>errno</code>。</li>
</ul></div><div class="el-p"><p dir="auto">只要任一端的文件描述符没有被关闭，pipe就会接着存在，也就是说只有我们<code>close()</code>pipe的两端之后，pipe才会被清理掉。</p></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="3.1.2 FIFO (Named Pipe)" dir="auto" class="heading" id="3.1.2_FIFO_(Named_Pipe)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.2 FIFO (Named Pipe)</h4><div class="heading-children"><div class="el-p"><p dir="auto">管道是一个特殊的文件类型，本质还是文件。我们用<code>open</code>函数打开磁盘文件的操作会将文件描述符(file descriptor, fd)存放在进程的虚拟空间中。在匿名管道的学习中，我们对这种管道“文件”并不敏感，因为匿名管道的文件描述符虽然产生了，但却是一直存放在进程的虚存中对内核空间的内存进行操作，本质上不进行对磁盘IO的操作，所以我们也就看不到相关的文件。</p></div><div class="el-p"><p dir="auto">而fifo命名管道就有所不同了，创建命名管道的同时在也会在文件系统上创建一个fifo文件。这个文件是有名称的，任何进程只要知道这个名称，就可以通过该名称打开fifo文件从而与另一端进行通信。所以命名管道允许在多个不同进程之间传输数据。（fifo文件充当管道入口的作用）</p></div><div class="el-p"><p dir="auto">命名管道在创建后会一直存在（持久性），直至显示删除，那怕没有进程使用。命名进程创建好后，对该管道的操作就和操作文件一样，使用<code>open</code>、<code>read</code>、<code>write</code>等系统调用来使用管道进行通信。由于命名管道不支持文件定位操作，且遵守先进先出的原则，所以命名管道也被称为 FIFO special file。</p></div><div class="el-h5 heading-wrapper"><h5 data-heading="3.1.2.1 Creating a Named Pipe" dir="auto" class="heading" id="3.1.2.1_Creating_a_Named_Pipe"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.2.1 Creating a Named Pipe</h5><div class="heading-children"><div class="el-pre"><pre class="language-cpp" tabindex="0"><code data-line="0" class="language-cpp is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>

<span class="token comment">//写端</span>

<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> pipe_name <span class="token operator">=</span> <span class="token string">"tmp"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str <span class="token operator">=</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> readBuf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span>readBuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkfifo</span><span class="token punctuation">(</span>pipe_name<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkfifo func error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> fifo_Writefd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>pipe_name<span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>fifo_Writefd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open fifofd error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>fifo_Writefd<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write func error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">)</span>
<span class="token function">close</span><span class="token punctuation">(</span>fifo_Writefd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//读端</span>

<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> pipe_name <span class="token operator">=</span> <span class="token string">"tmp"</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> fifo_Readfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>pipe_name<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>fifo_Readfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open fifofd error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fifo_Readfd<span class="token punctuation">,</span> readBuf<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write func error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">)</span>
std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> readBuf <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token function">close</span><span class="token punctuation">(</span>fifo_Readfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">unlink</span><span class="token punctuation">(</span>pipe_name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"unlink func error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="3.1.3 Pipe and Disk I/O" dir="auto" class="heading" id="3.1.3_Pipe_and_Disk_I/O"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.3 Pipe and Disk I/O</h4><div class="heading-children"><div class="el-h5 heading-wrapper"><h5 data-heading="3.1.3.1 Anonymous Pipes Have Nothing To Do with Disk" dir="auto" class="heading" id="3.1.3.1_Anonymous_Pipes_Have_Nothing_To_Do_with_Disk"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.3.1 Anonymous Pipes Have Nothing To Do with Disk</h5><div class="heading-children"><div class="el-p"><p dir="auto">在上面的命名管道小节中，我们其实提到了，在适用系统调用<code>pipe()</code>创建管道的文件描述符时，我们实际上并不用到磁盘。虽然我们进行了文件操作，但是这些操作都是在内存的内核区中进行的，并不会涉及实际的“对文件操作”。</p></div><div class="el-p"><p dir="auto">所以，匿名管道(pipe)是用于有亲缘关系进程之间通信的一种方式。匿名管道是临时存在于内存中的，当所有相关进程终止或关闭管道文件描述符（读端和写端）后，匿名管道自动销毁。在对匿名管道操作时，我们并不需要调用<code>unlink</code>系统调用函数删除文件。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="3.1.3.2 Named Pipes Use Disk I/O" dir="auto" class="heading" id="3.1.3.2_Named_Pipes_Use_Disk_I/O"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.1.3.2 Named Pipes Use Disk I/O</h5><div class="heading-children"><div class="el-p"><p dir="auto">在非亲缘关系进程之间通信时，我们使用<code>mkfifo</code>命令创建命名管道(fifo)，fifo是一个有名字的特殊文件。当A进程创建了这个fifo，由于它具有文件名属性，因此B进程可以通过文件路径、文件名等属性对这个文件进行访问，通过访问fifo文件，B进程可以知道内核缓冲区的哪一部分作为管道使用。这就是fifo实现非亲缘关系进程通信的基本原理。</p></div><div class="el-p"><p dir="auto">如果进程A使用<code>mkfifo</code>命令首次创建FIFO文件时，会在文件系统中创建一个相应的inode记录（首次访问文件系统）。之后用<code>open()</code>系统调用打开管道时，会读取inode表项以获取文件相关元数据，（第二次访问文件系统）。由于此前系统已经缓存了文件的inode，这时进程B通过系统上的inode记录打开FIFO文件并创建合适的fd就不再需要访问文件系统了。</p></div><div class="el-p"><p dir="auto">请<strong>注意</strong>，这里说的使用I/O并不是说管道传输的数据会先放到磁盘上，这样太慢了。我们说使用I/O是指使用命名管道时会在文件系统（磁盘）上创建一个FIFO文件。这个文件的创建是使用I/O的。</p></div></div></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="3.2 Shared Memory" dir="auto" class="heading" id="3.2_Shared_Memory"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2 Shared Memory</h3><div class="heading-children"><div class="el-p"><p dir="auto"><strong>共享内存</strong>的进程间通信机制划分出了一段内存用于共享，与管道不同的是，通常而言共享内存的方式能够划分的内存更大（通常管道分配4KB-64KB），而且共享内存段(shm)位于用户空间。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="3.2.1&nbsp;shm&nbsp;in&nbsp;POSIX" dir="auto" class="heading" id="3.2.1&nbsp;shm&nbsp;in&nbsp;POSIX"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.1&nbsp;shm&nbsp;in&nbsp;POSIX</h4><div class="heading-children"><div class="el-p"><p dir="auto">POSIX&nbsp;标准强调统一性和可移植性，所以POSIX的标准利用文件系统接口（文件描述符）来操作shm，也简化了系统的实现和使用。通常与<code>mmap()</code>结合使用，常用到的系统调用有：</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><code>shm_open</code>：通过<code>shm_open</code>函数创建或打开一个共享内存对象，并返回一个文件描述符<code>shm_fd</code>。这个文件描述符将用于后续的共享内存操作，就像操作一个普通文件一样。</li>
<li data-line="1" dir="auto"><code>ftruncate</code>：使用<code>ftruncate</code>函数设置共享内存对象的大小。这一步确保共享内存对象有足够的空间来存储数据。</li>
<li data-line="2" dir="auto"><code>mmap</code>：通过<code>mmap</code>函数将共享内存对象映射到进程的地址空间，并返回这段内存的起始地址（<code>*ptr</code>）。这个过程使得你可以像操作普通内存一样操作共享内存。</li>
<li data-line="3" dir="auto">使用<code>memcpy</code>或<code>strcpy</code>：一旦共享内存被映射到地址空间，你可以使用标准的内存操作函数（如<code>memcpy</code>或<code>strcpy</code>）来操作这段内存。这个过程与操作普通内存没有区别。</li>
<li data-line="4" dir="auto"><code>close(shm_fd)</code>：在使用完共享内存后，通过<code>close</code>函数关闭共享内存对象的文件描述符。这个步骤类似于关闭文件，表示不再需要访问该共享内存对象。</li>
<li data-line="5" dir="auto"><code>shm_unlink</code>：最后，使用<code>shm_unlink</code>函数删除共享内存对象。这一步类似于删除文件，释放掉不再需要的共享内存对象。</li>
</ul></div><div class="el-h5 heading-wrapper"><h5 data-heading="3.2.1.1 `shm_open()`" dir="auto" class="heading" id="3.2.1.1_`shm_open()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.1.1 <code>shm_open()</code></h5><div class="heading-children"><div class="el-p"><p dir="auto"><code>shm_open</code>&nbsp;用于创建或打开一个共享内存对象，并返回一个文件描述符用于后续的内存操作。创建时会在文件系统（通常是<code>/dev/shm</code>）中显示一个对应的文件条目。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">shm_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">int</span> oflag<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. name: The name of the shared memory object.
	2. oflag: The open flags (e.g., O_CREAT, O_RDWR).
	3. mode: The permission mode of the shared memory object (e.g., 0666).

Return value: Returns a file descriptor on success, -1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="3.2.1.2 `ftruncate()`" dir="auto" class="heading" id="3.2.1.2_`ftruncate()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.1.2 <code>ftruncate()</code></h5><div class="heading-children"><div class="el-p"><p dir="auto"><code>ftruncate</code>&nbsp;用于设置共享内存段的大小，确保其有足够的空间来存储数据。由于在内存中页框的大小通常是4KB，所以在我们设置共享内存段大小时通常设置为4096的倍数。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">ftruncate</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. fd: The file descriptor of the shared memory object.
	2. length: The size to set for the shared memory object in bytes.

Return value: Returns 0 on success, -1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="3.2.1.3 `close()`" dir="auto" class="heading" id="3.2.1.3_`close()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.1.3 <code>close()</code></h5><div class="heading-children"><div class="el-p"><p dir="auto"><code>close</code>&nbsp;用于关闭共享内存对象的文件描述符，类似于关闭文件。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. fd: The file descriptor to close.

Return value: Returns 0 on success, -1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="3.2.1.4 `shm_unlink()`" dir="auto" class="heading" id="3.2.1.4_`shm_unlink()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.1.4 <code>shm_unlink()</code></h5><div class="heading-children"><div class="el-p"><p dir="auto"><code>shm_unlink</code>&nbsp;用于删除共享内存对象，类似于删除文件，释放不再需要的共享内存。对于POSIX共享内存，如果未调用<code>shm_unlink</code>函数来删除共享内存对象，那么它会继续驻留在系统内存中，直到系统重启或显式删除。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">shm_unlink</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. name: The name of the shared memory object.

Return value: Returns 0 on success, -1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">如果在<code>shm_unlink</code>之前没有close共享内存对象，该函数会标记这段共享内存，当所有进程都关闭描述符后，系统会清理资源（届时删除共享内存段）。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="3.2.1.5 Manipulate a shm Object" dir="auto" class="heading" id="3.2.1.5_Manipulate_a_shm_Object"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.1.5 Manipulate a shm Object</h5><div class="heading-children"><div class="el-p"><p dir="auto">我们下面用代码简单演示一下POSIX中shm的创建（打开）、设置大小、关闭、删除shmfd的一系列操作。这里请注意，设置shm大小我们交给写进程来设置：</p></div><div class="el-pre"><pre class="language-cpp" tabindex="0"><code data-line="0" class="language-cpp is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token comment">//Write process</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> shm_name <span class="token operator">=</span> <span class="token string">"my_shm"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str <span class="token operator">=</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> shm_fd <span class="token operator">=</span> <span class="token function">shm_open</span><span class="token punctuation">(</span>shm_name<span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>shm_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shm_open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ftruncate</span><span class="token punctuation">(</span>shm_fd<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ftruncate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>shm_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> shm_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token function">close</span><span class="token punctuation">(</span>shm_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token function">memcpy</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>shm_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Character string's been sent"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//Read process</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> shm_name <span class="token operator">=</span> <span class="token string">"my_shm"</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> rdBuf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> rdshm_fd <span class="token operator">=</span> <span class="token function">shm_open</span><span class="token punctuation">(</span>shm_name<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">mm</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> rdshm_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token function">close</span><span class="token punctuation">(</span>rdshm_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Read from shared memory: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>ptr <span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

	<span class="token function">close</span><span class="token punctuation">(</span>rdshm_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">shm_unlink</span><span class="token punctuation">(</span>shm_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="3.2.1.6 Shared Memory Implementation Mechanism | POSIX" dir="auto" class="heading" id="3.2.1.6_Shared_Memory_Implementation_Mechanism_|_POSIX"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.1.6 Shared Memory Implementation Mechanism | POSIX</h5><div class="heading-children"><div class="el-p"><p dir="auto">既然在POSIX下万物皆文件，而且我们用<code>shm_open</code>系统调用会返回一个文件句柄，那么我们应该能在磁盘中找到相关的共享内存文件吧？没错，确实会如此。当我们执行下面一行代码<code>int shm_fd = shm_open(shm_name, O_CREAT | O_RDWR, 0666);</code>后，我们查看<code>/dev/shm</code>，应当可以看到相关的文件。运行后查看目录：</p></div><div class="el-pre"><pre><code data-line="0">du@du-virtual-machine:~/Desktop/OS$ ls /dev/shm
my_shm
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">实际上，共享内存在传递信息之前通过打开文件对象<code>my_shm</code>返回一个文件的描述符<code>shm_fd</code>。有了这个文件描述符，进程就可以对特定的共享内存段中进行读写操作（也就相当于fd实际上是共享内存段的索引）。写端进程在修改这部分内存时，数据会在内存中被更新，实现了数据在不同进程间的交换。结合信号量可以实现同步分次读写。</p></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="3.2.2&nbsp;shm&nbsp;in&nbsp;System&nbsp;V" dir="auto" class="heading" id="3.2.2&nbsp;shm&nbsp;in&nbsp;System&nbsp;V"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.2&nbsp;shm&nbsp;in&nbsp;System&nbsp;V</h4><div class="heading-children"><div class="el-p"><p dir="auto">System V使用不同于POSIX标准的IPC机制，&nbsp;<strong>System&nbsp;V下的shm并不依赖文件系统持久存储（不同于POSIX中使用文件描述符和路径名管理共享内存段），而是通过特定的标识符（shmid）来管理</strong>。System&nbsp;V共享内存并不会持久化存储在文件系统中，而是存储在内存中，用于进程间的快速通信。相比于万物皆文件的POSIX而言效率和性能更好。</p></div><div class="el-p"><p dir="auto">在System V的shm方式中，我们主要用到四个系统调用<code>shmget</code>、<code>shmat</code>、<code>shmdt</code>和<code>shmctl</code>。这四个系统调用的含义分别是：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto"><code>shmget</code>获取(get)一个新的共享内存段(shm)，并返回唯一的标识符(shmid)用于后续的操作。</li>
<li data-line="1" dir="auto"><code>shmat</code>将创建的shm附加(attach)到进程的地址空间。</li>
<li data-line="2" dir="auto"><code>shmdt</code>从进程的地址空间中将shm分离(detach)出来。</li>
<li data-line="3" dir="auto"><code>shmctl</code>用于控制和操作shm，通常用来删除内存段。</li>
</ol></div><div class="el-h5 heading-wrapper"><h5 data-heading="3.2.2.1 shm Get" dir="auto" class="heading" id="3.2.2.1_shm_Get"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.2.1 shm Get</h5><div class="heading-children"><div class="el-p"><p dir="auto">System&nbsp;V的共享内存通过标识符（shmid）来管理，这些标识符通过<code>shmget</code>和<code>ftok</code>等函数生成。要创建新的或获取存在的共享内存段的引用，我们需要使用<code>shmget</code>系统调用，它的函数原型是：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token class-name">key_t</span> key<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. key: A unique identifier for the shared memory segment. This can either be the result of an ftok() call or the constant IPC_PRIVATE.
	2. size: Indicates the size of the shared memory segment in bytes.
	3. shmflg: Access permissions (UNIX standards, e.g., 0600). Optional flags include:
	   - IPC_CREAT: Create a new segment if it does not exist.
	   - IPC_EXCL: Fail if the segment already exists.

Return value: Returns the shared memory segment identifier (shmid), which is an integer.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">要获得对一段共享内存段的唯一标识（键值），我们需要用到<code>ftok</code>函数。其函数原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>

<span class="token class-name">key_t</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> proj_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. pathname: A pointer to the path of an existing and accessible file.
	2. proj_id: A project identifier. This is usually a single character.

Return value: Returns a key of type key_t, which can be used to identify a shared memory segment, message queue, or semaphore.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">如果没有相关文件，我们可以创建一个空文件来生成键值。（<code>open</code>系统调用）</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="3.2.2.2 shm Attachment" dir="auto" class="heading" id="3.2.2.2_shm_Attachment"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.2.2 shm Attachment</h5><div class="heading-children"><div class="el-p"><p dir="auto">当共享内存段存在之后，我们就可以将其附加到我们的进程空间中了。附加完成之后，进程就可以通过指针对这段空间进行操作，从而实现与其他进程之间的通信。其函数原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">shmat</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> shmaddr<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. shmid: ID of the shared memory segment.
	2. shmaddr: Address at which to attach the shared memory segment (always use NULL to allow the system to choose the address).
	3. shmflg: Flags for the operation (e.g., SHM_RDONLY to attach in read-only mode).

Return value: Standard C pointer with the address of the shared memory.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="3.2.2.3 shm Detachment" dir="auto" class="heading" id="3.2.2.3_shm_Detachment"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.2.3 shm Detachment</h5><div class="heading-children"><div class="el-p"><p dir="auto">使用完成共享内存段之后，我们需要用<code>detach</code>系统调用将其与进程内存空间进行分离。这个系统调用非常简单，只有一个参数：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">shmdt</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> shmaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. shmaddr: The address returned by the attach call.

Return value: 0 for success and -1 for error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">虽然很简单，但是请不要忽视其重要性。虽然进程终止后操作系统也会帮我们进行资源管理，但是有时我们需要进程一直运行，这时，如果不进行<code>shmdt</code>就会导致shm一直驻留到内存中。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="3.2.2.4 shm Control" dir="auto" class="heading" id="3.2.2.4_shm_Control"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.2.2.4 shm Control</h5><div class="heading-children"><div class="el-p"><p dir="auto">我们用<code>shmctl</code>来删除共享内存段，这个函数能做的不仅仅是删除，但这里我们仅仅关注其删除的功能。下面是这个函数的原型：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">shmctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. shmid: Shared memory segment ID.
	2. cmd: Command to perform on the shared memory segment. For deletion, use IPC_RMID(ReMove ID).
	3. buf: Pointer to a struct shmid_ds, used for control commands that require or return data, not needed for IPC_RMID(in this case, just set to NULL).

Return value: Returns 0 on success, -1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">System V的shm使用引用计数(reference count)来管理其生命周期。当进程通过<code>shmat</code>附加共享内存时，引用计数增加。当进程通过<code>shmdt</code>分离共享内存段时，引用计数减少。只要引用计数不为0，我们调用<code>shmctl</code>删除共享内存段时这个共享内存段并不会立刻被删除，内核会将其标记为”待删除“状态，直到引用计数归零。</p></div></div></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="3.3 Message Queue" dir="auto" class="heading" id="3.3_Message_Queue"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.3 Message Queue</h3><div class="heading-children"><div class="el-p"><p dir="auto">除了管道和共享内存，消息队列也是一种常见的IPC机制。消息队列和管道有些相似，它们都是一种内核对象、以先进先出的方式对消息进程处理（默认情况）。但它们处理的对象不同。管道传递的消息是以字节流的方式进行传输的，而<strong>消息队列中传递的消息具有消息类型信息</strong>（包含着消息类型和消息体）。</p></div><div class="el-p"><p dir="auto">而且在消息队列中，我们可以通过消息类型进行<strong>筛选和优先级处理</strong>，而管道不具备这种能力。消息队列允许你根据不同的消息类型有选择地读取消息，从而实现更细粒度的控制。而管道只能按照数据到达的顺序逐个读取，无法跳过或优先处理特定的数据。</p></div><div class="el-p"><p dir="auto">由于消息具有类型信息，而且消息队列可以作为进程间通信的中间人存储消息，从而解耦合进程之间的同步问题，即进程可以独立地执行任务，而不必频繁地等待或与其他进程直接同步。所以消息队列常用于生产者-消费者模型中，生产者进程将数据发送到消息队列后可以立即继续生成新的数据，不必等待消费者进程处理完毕。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="3.3.1 Message Queue in POSIX" dir="auto" class="heading" id="3.3.1_Message_Queue_in_POSIX"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.3.1 Message Queue in POSIX</h4><div class="heading-children"><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mqueue.h&gt;</span></span>

<span class="token class-name">mqd_t</span> <span class="token function">mq_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">int</span> oflag<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. name: Name of the message queue.
	2. oflag: Flags for the operation (e.g., O_CREAT to create the queue if it doesn't exist).
	3. ...: Optional mode and attributes (used when creating the queue).

Return value: Message queue descriptor (mqd_t) on success, (mqd_t)-1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">mq_send</span><span class="token punctuation">(</span><span class="token class-name">mqd_t</span> mqdes<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg_ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> msg_len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> msg_prio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. mqdes: Message queue descriptor.
	2. msg_ptr: Pointer to the message to be sent.
	3. msg_len: Size of the message in bytes.
	4. msg_prio: Priority of the message.

Return value: 0 on success, -1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token class-name">ssize_t</span> <span class="token function">mq_receive</span><span class="token punctuation">(</span><span class="token class-name">mqd_t</span> mqdes<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg_ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> msg_len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>msg_prio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. mqdes: Message queue descriptor.
	2. msg_ptr: Pointer to the buffer where the received message will be stored.
	3. msg_len: Size of the message buffer in bytes.
	4. msg_prio: Pointer to store the message priority (optional).

Return value: Number of bytes received on success, -1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">mq_close</span><span class="token punctuation">(</span><span class="token class-name">mqd_t</span> mqdes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. mqdes: Message queue descriptor.

Return value: 0 on success, -1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">mq_unlink</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. name: Name of the message queue.

Return value: 0 on success, -1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="3.3.2 Message Queue in System V" dir="auto" class="heading" id="3.3.2_Message_Queue_in_System_V"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.3.2 Message Queue in System V</h4><div class="heading-children"><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">msgget</span><span class="token punctuation">(</span><span class="token class-name">key_t</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> msgflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. key: Unique key to identify the message queue.
	2. msgflg: Flags for the operation (e.g., IPC_CREAT to create the queue if it doesn't exist).

Return value: Message queue identifier (msgid) on success, -1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">msgsnd</span><span class="token punctuation">(</span><span class="token keyword">int</span> msqid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>msgp<span class="token punctuation">,</span> <span class="token class-name">size_t</span> msgsz<span class="token punctuation">,</span> <span class="token keyword">int</span> msgflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. msqid: Message queue identifier.
	2. msgp: Pointer to the message to be sent.
	3. msgsz: Size of the message in bytes.
	4. msgflg: Message flags to alter default behavior (e.g., IPC_NOWAIT).

Return value: 0 on success, -1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token class-name">ssize_t</span> <span class="token function">msgrcv</span><span class="token punctuation">(</span><span class="token keyword">int</span> msqid<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>msgp<span class="token punctuation">,</span> <span class="token class-name">size_t</span> msgsz<span class="token punctuation">,</span> <span class="token keyword">long</span> msgtyp<span class="token punctuation">,</span> <span class="token keyword">int</span> msgflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. msqid: Message queue identifier.
	2. msgp: Pointer to the buffer where the received message will be stored.
	3. msgsz: Size of the message buffer in bytes.
	4. msgtyp: Type of message to be received.
	5. msgflg: Message flags to alter default behavior (e.g., IPC_NOWAIT).

Return value: Number of bytes received on success, -1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">msgctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> msqid<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">msqid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. msqid: Message queue identifier.
	2. cmd: Command to perform on the message queue (e.g., IPC_RMID to remove the queue).
	3. buf: Pointer to a struct msqid_ds, used for control commands that require or return data.

Return value: 0 on success, -1 on failure and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="3.4 IPC Comparisons" dir="auto" class="heading" id="3.4_IPC_Comparisons"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.4 IPC Comparisons</h3><div class="heading-children"><div class="el-h4 heading-wrapper"><h4 data-heading="3.4.1 Shared Memory in Differnet Standards" dir="auto" class="heading" id="3.4.1_Shared_Memory_in_Differnet_Standards"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.4.1 Shared Memory in Differnet Standards</h4><div class="heading-children"><div class="el-p"><p dir="auto">对比POSIX和System&nbsp;V下的共享内存，POSIX的共享内存通过<code>shm_open</code>系统调用在文件系统中创建一个共享内存文件，之后通过这个文件描述符对共享内存段进行管理。相比之下，在SystemV中的共享内存机制使用标识符（shmid）管理，不依赖于文件系统进行索引。</p></div><div class="el-p"><p dir="auto">相同点在于，这两种标准都使用文件系统的信息作为共享内存段标识符的生成依据，尽管方式不同（POSIX是直接依赖，System&nbsp;V是间接依赖）。而且不论是POSIX还是System&nbsp;V，实际的数据都是存储在用户群的内存中。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="3.4.2 Shared Memory vs. Pipes" dir="auto" class="heading" id="3.4.2_Shared_Memory_vs._Pipes"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.4.2 Shared Memory vs. Pipes</h4><div class="heading-children"><div class="el-p"><p dir="auto">POSIX标准下的shm，管道的使用场景更加specific。管道具有先进先出的特性，而且有内核维护其缓冲区，所以管道不需要显式地同步机制，但是大小较为局限（通常为4KB-64KB）。相比之下，共享内存需要信号量或互斥锁等同步机制来防止数据竞争。</p></div><div class="el-p"><p dir="auto">还与共享内存不同的是，管道是一种流式传输信息的通信工具，因为这种字节流传递方式，所以从管道中传输的数据不能有复杂的类型（如结构体）。而共享内存则提供了更多的灵活性和更高的性能，共享内存可以存储和访问如结构体等复杂的数据结构。</p></div><div class="el-p"><p dir="auto">此外，内核态到用户态的切换开销也是我们需要考虑的。虽然内核保证了数据传输的安全性，但是频繁的切换使得管道的性能不及共享内存高。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="3.4.3 Pipes vs. Message Queue" dir="auto" class="heading" id="3.4.3_Pipes_vs._Message_Queue"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>3.4.3 Pipes vs. Message Queue</h4><div class="heading-children"><div class="el-p"><p dir="auto">管道和消息队列很相似，在数据传输的顺序上，它们都是以FIFO的顺序进行传输的。但是消息队列相比指向更加灵活，因为<strong>消息队列通过链表结构存放信息并传输数据</strong>。这就造就了消息队列一些管道不支持的特性，例如：<strong>消息带有类型标识符</strong>，能够标识消息的类型和优先级。这样，消息就可以根据特定的类型和优先级被消息接收方所接收。（链表结构的便利）</p></div><div class="el-p"><p dir="auto">管道的同步机制比较简单，生产者进程写入数据后，消费者进程读取数据，过程由内核自动管理，但缺乏显式的同步控制。而消息队列支持显式同步，通过<code>msgsnd</code>和<code>msgrcv</code>系统调用，提供进程间更灵活的同步与调度机制。</p></div></div></div></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第四课 Memory Mapped Files" dir="auto" class="heading" id="第四课_Memory_Mapped_Files"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第四课 Memory Mapped Files</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-p"><p dir="auto">一般我们可能并不会将内存映射文件 <code>mmap</code> 机制作为一种进程间通信的方式去使用。但它确实可以提供信息在不同进程间的通信的功能。我们下面就一起来看看它的功能。</p></div><div class="el-p"><p dir="auto">进程映射文件，你从名字上就能知道和文件脱不了干系。它的主要作用就是将文件映射到进程的虚拟地址空间，使得进程可以直接通过内存地址访问文件内容，而不需要 <code>read/write</code>。即访问内存就等价于访问文件（操作系统会自动处理缺页和回写）。我们先了解了解文件是如何打开的。</p></div><div class="el-h3 heading-wrapper"><h3 data-heading="4.1 How Files are Opened" dir="auto" class="heading" id="4.1_How_Files_are_Opened"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.1 How Files are Opened</h3><div class="heading-children"><div class="el-p"><p dir="auto">详细请参阅<a data-href="13. File Systems" href="congzhi's-os-series/13.-file-systems.html" class="internal-link" target="_self" rel="noopener nofollow">13. File Systems</a>，这里仅作概述。</p></div><div class="el-p"><p dir="auto">操作系统内维护了一张<strong>打开文件表&nbsp;(Open&nbsp;File&nbsp;Table,&nbsp;OFT)</strong>，其中包含许多表项，我们称之为&nbsp;<strong>OFD&nbsp;(Open&nbsp;File Description)</strong>。当你使用 <code>open("example.txt", O_RDONLY)</code> 打开某一文件时，实际上你只是将文件表项被加载进了内存。打开文件表项包含该文件的元数据和控制信息，通过这些信息，你就可以知道如何在磁盘中寻得文件内容了。</p></div><div class="el-p"><p dir="auto">当某个进程要打开文件时，系统会首先在打开文件表中查找相关表项，如果找到了相应的表项，就说明我们不需要从磁盘加载文件打开表项了。即使内容可能并没有被加载进内存，但这时我们也说该文件已经打开。（一般来说，只有需要用到内容的时候才会把文件内容从磁盘上加载进内存，即"lazy approach"）</p></div><div class="el-p"><p dir="auto">对于只读文件产生的条目，我们不用担心多程序并发带来的同步互斥问题。但当有进程写操作时，我们就需要留意同步互斥访问文件资源的问题。</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="4.2 Memory Mapping Files Implementation:`mmap()`" dir="auto" class="heading" id="4.2_Memory_Mapping_Files_Implementation:`mmap()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2 Memory Mapping Files Implementation:<code>mmap()</code></h3><div class="heading-children"><div class="el-p"><p dir="auto">当文件打开之后，我们就可以用 <code>mmap()</code> 系统调用建立从文件到进程虚拟内存空间之间的映射。由于访问 IO 很耗时间，所以这时候，文件内容仍然不会加载进内存，在第一次访问映射后的地址空间时才会（缺页中断-&gt;加载文件内容）。我用一张图来简单的形容一下：</p></div><div class="el-p"><p dir="auto">在进程通过 <code>open()</code> 系统调用知道文件的源信息后，我们就可以用 <code>mmap</code> 将文件的前 4KB 内容映射到进程的虚拟地址空间中。这时仅仅建立虚拟地址到文件的虚拟映射。当程序要读/写文件时，由于缺页，这时系统分配 4KB 物理内存并建立虚拟地址到物理内存地址的映射，并将文件内容从磁盘加载到内存中。（图应该是 0-4095 字节）<br>
<span alt="mmap.png" src="mmap.png" class="internal-embed media-embed image-embed is-loaded"><img alt="mmap.png" src="congzhi's-os-series/pics/mmap.png"></span></p></div><div class="el-h4 heading-wrapper"><h4 data-heading="4.2.1 `mmap()`" dir="auto" class="heading" id="4.2.1_`mmap()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.1 <code>mmap()</code></h4><div class="heading-children"><div class="el-p"><p dir="auto">现在，我们知道了内存映射是将一个文件映射到进程的地址空间。进而实现文件磁盘和进程虚拟空间中一段虚拟地址的一一对应关系。这种对应关系会保存在虚拟存储空间的<strong>文件映射与匿名映射区</strong>中，这段区域位于堆和栈之间。</p></div><div class="el-p"><p dir="auto"><code>mmap</code>函数的函数原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. addr: Starting address for the new mapping. Typically set to NULL to let the kernel choose the address.
	2. length: Length of the mapping in bytes. Must be a multiple of the system's page size.
	3. prot: Desired memory protection of the mapping. This can be a combination of the following:
	   - PROT_READ: Pages can be read.
	   - PROT_WRITE: Pages can be written.
	   - PROT_EXEC: Pages can be executed.
	   - PROT_NONE: Pages cannot be accessed.
	4. flags: Flags that determine the nature of the mapping. Common flags include:
       - MAP_SHARED: Write updates to the mapping are visible to other processes mapping the same region, and also reflected in the underlying file.
       - MAP_PRIVATE: Changes to the mapping are private to the process and not visible to other processes. Changes are not reflected in the underlying file (copy-on-write).
       - MAP_ANONYMOUS: Mapping is not backed by any file; the fd parameter is ignored (should be -1).
       - MAP_FIXED: Forces the mapping to use exactly the address specified in addr. Be cautious as it may overwrite existing mappings.
       - MAP_FIXED_NOREPLACE: Similar to MAP_FIXED, but will fail with EINVAL if the specified address is already occupied.
       - MAP_POPULATE: Populates page tables for the mapping immediately instead of waiting for lazy access.
       - MAP_NORESERVE: Prevents reserving swap space for the mapping. If physical memory runs out, the process may be terminated.
       - MAP_LOCKED: Locks the mapping in memory, preventing it from being swapped out.
       - MAP_HUGETLB: Uses huge pages for the mapping to reduce TLB (Translation Lookaside Buffer) overhead.
       - MAP_UNINITIALIZED: Allocates uninitialized memory. Unsafe and supported only on specific architectures.
	5. fd: File descriptor of the file to be mapped. Ignored if MAP_ANONYMOUS is set.
	6. offset: Offset in the file where the mapping starts. Typically set to 0.

Return value: Returns a pointer to the mapped area on success, or MAP_FAILED on failure. The errno variable is set to indicate the error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="4.2.2 Protection Access Modification: `mprotect()`" dir="auto" class="heading" id="4.2.2_Protection_Access_Modification:_`mprotect()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.2 Protection Access Modification: <code>mprotect()</code></h4><div class="heading-children"><div class="el-p"><p dir="auto">如果你想要修改映射区域的保护权限，我们可以使用 <code>mprotect</code> 系统调用，其函数原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">mprotect</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> address<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. address: Starting address of the memory region to be protected.
	2. length: Length of the memory region in bytes.
	3. prot: Desired protection of the memory region. It can be a combination of the following:
	   - PROT_READ: Pages can be read.
	   - PROT_WRITE: Pages can be written.
	   - PROT_EXEC: Pages can be executed.
	   - PROT_NONE: Pages cannot be accessed.
   
Return value: Returns 0 on success, -1 on failure and sets errno to indicate the error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="4.2.3 Mapping Consistency Guarantee : `msync()" dir="auto" class="heading" id="4.2.3_Mapping_Consistency_Guarantee_:_`msync()"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.3 Mapping Consistency Guarantee : `msync()</h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>msync</code>&nbsp;函数用于同步内存映射区域与其底层存储之间的内容。通过<code>msync</code>，我们可以确保内存中进行的修改能够被写回到映射的文件上，保持数据的一致性。通常而言，我们在对内存映射区域进行写操作之后使用<code>msync</code>确保数据的持久保存。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">msync</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> address<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. address: Starting address of the memory region to be synchronized.
	2. length: Length of the memory region to be synchronized.
	3. flags: Flags that determine the synchronization behavior. Common flags include:
	   - MS_SYNC: Perform synchronous writes(blocking).
	   - MS_ASYNC: Perform asynchronous writes.
	   - MS_INVALIDATE: Invalidate all cached data.

Return value: Returns 0 on success, -1 on failure and sets errno to indicate the error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="4.2.4 Memory Un-Mapping : `munmap()`" dir="auto" class="heading" id="4.2.4_Memory_Un-Mapping_:_`munmap()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.2.4 Memory Un-Mapping : <code>munmap()</code></h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>munmap</code> 系统调用用于解除一个映射关系，将之前通过 <code>mmap</code> 映射的内存区域释放回操作系统。它的函数原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">int</span> <span class="token function">munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. addr: Starting address of the memory region to be unmapped. This should be the address returned by a previous call to mmap.
	2. length: Length of the memory region to be unmapped. Must be the same length as that specified in the original mmap call.

Return value: Returns 0 on success, -1 on failure and sets errno to indicate the error.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="4.3 IPC with `mmap()`" dir="auto" class="heading" id="4.3_IPC_with_`mmap()`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.3 IPC with <code>mmap()</code></h3><div class="heading-children"><div class="el-p"><p dir="auto">了解了内存映射文件是什么。你应该能想得到如果两个进程都将同一个文件映射到自己的虚拟内存空间，实现基本的同步互斥。那么就可以实现进程间的通信。这当然没有问题，但是这也太扯了，非常无聊。我们不想和文件打交道。</p></div><div class="el-p"><p dir="auto">如果你细心，你可能会对 <code>mmap()</code> 系统调用的 flags 项感兴趣：<code>MAP_PRIVATE</code>、<code>MAP_SHARED</code> 和 <code>MAP_ANONYMOUS</code>。它们什么意思？我们一项一项解释。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="4.3.1 `MAP_PRIVATE` and `MAP_SHARED`" dir="auto" class="heading" id="4.3.1_`MAP_PRIVATE`_and_`MAP_SHARED`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.3.1 <code>MAP_PRIVATE</code> and <code>MAP_SHARED</code></h4><div class="heading-children"><div class="el-p"><p dir="auto"><code>MAP_PRIVATE</code> 提供一种只有进程内部私有这段虚拟内存的映射关系。</p></div><div class="el-p"><p dir="auto">而 <code>MAP_SHARED</code> 提供多线程共享同一物理资源。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="4.3.2 Anonymous Mapping" dir="auto" class="heading" id="4.3.2_Anonymous_Mapping"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.3.2 Anonymous Mapping</h4><div class="heading-children"><div class="el-p"><p dir="auto">当你使用 <code>MAP_ANONMYMOUS</code> 时，虚拟内存将不会和任何文件产生映射关系，而是在访问的时候系统会分配物理内存并建立虚拟内存到物理内存上的映射。</p></div><div class="el-p"><p dir="auto">你可能了解过，当库函数 <code>malloc</code> 申请堆内存时，申请内存小于 128KB 时（一般而言），底层会调用 <code>sbrk()</code> 系统调用。当申请的堆内存大于 128KB 时，底层会调用 <code>mmap()</code>。你可能会奇怪为什么堆内存的申请会和内存映射文件产生联系，即便没有任何文件参与。而到这里，你可能就明白是怎么回事了。</p></div><div class="el-p"><p dir="auto">实际上，进程启动的时候，就会用 <code>malloc</code> 申请内存段空间（数据段、代码段等）。这些在程序运行的整个生命周期都不会改变的内存就相当于：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_PRIVATE <span class="token operator">|</span> MAP_FIXED <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Size must be a multiple of the system's page size. (4n * KB)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">一般情况下，你使用 <code>malloc</code> 申请大块内存时，底层调用的 <code>mmap</code> 实际上相当于：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Size must be a multiple of the system's page size. (4n * KB)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">如果配合 <code>MAP_SHARED</code> 我们就可以实现类似 <code>shm</code> 共享内存的进程间通信了。但是这种进程间通信仅仅存在于父子进程或其他有亲缘关系的进程之间。但这里你需要知道 <code>mmap()</code> 映射的大小应为系统页大小的倍数。（页大小一般为 4KB ，也有 16KB 等的）</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="4.4 Easy Peasy Example" dir="auto" class="heading" id="4.4_Easy_Peasy_Example"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>4.4 Easy Peasy Example</h3><div class="heading-children"><div class="el-p"><p dir="auto">下面我们让父进程在”共享内存“中写 <code>Hello, kid</code>，然后让子进程读。我们不设置复杂的同步互斥机制，先让子进程阻塞一秒。这里请注意，<code>fork()</code>系统调用会将父进程所有的资源都复制一份，所以当我们关闭文件描述符的时候应当关闭两次，而不是一次。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MY_SHM_SIZE</span> <span class="token expression"><span class="token number">4096</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 1. create my shared memory</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>my_shm <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> MY_SHM_SIZE<span class="token punctuation">,</span>
                    PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>
                    MAP_ANONYMOUS <span class="token operator">|</span> MAP_SHARED<span class="token punctuation">,</span>
                    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>my_shm <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. write-in</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>my_shm<span class="token punctuation">,</span> <span class="token string">"Hello, kid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. fork</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Child received: %s\n"</span><span class="token punctuation">,</span> my_shm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4. unmapping</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">munmap</span><span class="token punctuation">(</span>my_shm<span class="token punctuation">,</span> MY_SHM_SIZE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"munmap failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="第五课 IPC for Process Control: Signals" dir="auto" class="heading" id="第五课_IPC_for_Process_Control:_Signals"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>第五课 IPC for Process Control: Signals</h2><div class="heading-children"><div class="el-hr"><hr></div><div class="el-p"><p dir="auto">在上个阶段的最后，我们看了看如何用信号处理僵尸进程的问题。我们通过注册<code>SIGCHILD</code>信号的处理程序来捕获子进程终止的信号，从而避免僵尸进程的产生。信号机制作为一种轻量级的进程间通信方式，我们本节课来详细探讨探讨相关的细节。</p></div><div class="el-h3 heading-wrapper"><h3 data-heading="5.1 Signaling vs. Exception" dir="auto" class="heading" id="5.1_Signaling_vs._Exception"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.1 Signaling vs. Exception</h3><div class="heading-children"><div class="el-p"><p dir="auto">在<a data-tooltip-position="top" aria-label="5. Interruption" data-href="5. Interruption" href="congzhi's-os-series/5.-interruption.html" class="internal-link" target="_self" rel="noopener nofollow">Interruption</a>的阶段中，我们了解了内核是如何处理异常的。当程序执行过程中发生异常时，内核会接管并执行相应的异常处理例程(exception handler)。因为异常的处理程序都在内核中，用户程序对异常的发生是毫不知情的。比方说缺页中断。</p></div><div class="el-p"><p dir="auto"><a data-tooltip-position="top" aria-label="https://www.man7.org/linux/man-pages/man7/signal.7.html" rel="noopener nofollow" class="external-link" href="https://www.man7.org/linux/man-pages/man7/signal.7.html" target="_blank">信号机制</a>在软件层面上模拟了硬件中断。信号提供了一种机制来通知用户进程发生了何种异常，以便用户程序能够根据自身情况做出响应。回想在用信号处理僵尸进程时，我们自己定义的handler实际上是放在用户区的，而中断通常会在内核空间中执行。此外，信号的触发和处理机制和中断并不相同。（信号的嵌套是被允许的。）</p></div><div class="el-p"><p dir="auto">Linux中共有64种信号，其中1-34属于非实时信号，而35-64属于实时信号，用于实时系统。</p></div><div class="el-pre"><pre class="language-sh" tabindex="0"><code data-line="0" class="language-sh is-loaded">$ <span class="token function">kill</span> <span class="token parameter variable">-l</span>
 <span class="token number">1</span><span class="token punctuation">)</span> SIGHUP	 <span class="token number">2</span><span class="token punctuation">)</span> SIGINT	 <span class="token number">3</span><span class="token punctuation">)</span> SIGQUIT	 <span class="token number">4</span><span class="token punctuation">)</span> SIGILL	 <span class="token number">5</span><span class="token punctuation">)</span> SIGTRAP
 <span class="token number">6</span><span class="token punctuation">)</span> SIGABRT	 <span class="token number">7</span><span class="token punctuation">)</span> SIGBUS	 <span class="token number">8</span><span class="token punctuation">)</span> SIGFPE	 <span class="token number">9</span><span class="token punctuation">)</span> SIGKILL	<span class="token number">10</span><span class="token punctuation">)</span> SIGUSR1
<span class="token number">11</span><span class="token punctuation">)</span> SIGSEGV	<span class="token number">12</span><span class="token punctuation">)</span> SIGUSR2	<span class="token number">13</span><span class="token punctuation">)</span> SIGPIPE	<span class="token number">14</span><span class="token punctuation">)</span> SIGALRM	<span class="token number">15</span><span class="token punctuation">)</span> SIGTERM
<span class="token number">16</span><span class="token punctuation">)</span> SIGSTKFLT	<span class="token number">17</span><span class="token punctuation">)</span> SIGCHLD	<span class="token number">18</span><span class="token punctuation">)</span> SIGCONT	<span class="token number">19</span><span class="token punctuation">)</span> SIGSTOP	<span class="token number">20</span><span class="token punctuation">)</span> SIGTSTP
<span class="token number">21</span><span class="token punctuation">)</span> SIGTTIN	<span class="token number">22</span><span class="token punctuation">)</span> SIGTTOU	<span class="token number">23</span><span class="token punctuation">)</span> SIGURG	<span class="token number">24</span><span class="token punctuation">)</span> SIGXCPU	<span class="token number">25</span><span class="token punctuation">)</span> SIGXFSZ
<span class="token number">26</span><span class="token punctuation">)</span> SIGVTALRM	<span class="token number">27</span><span class="token punctuation">)</span> SIGPROF	<span class="token number">28</span><span class="token punctuation">)</span> SIGWINCH	<span class="token number">29</span><span class="token punctuation">)</span> SIGIO	<span class="token number">30</span><span class="token punctuation">)</span> SIGPWR
<span class="token number">31</span><span class="token punctuation">)</span> SIGSYS	<span class="token number">34</span><span class="token punctuation">)</span> SIGRTMIN	<span class="token number">35</span><span class="token punctuation">)</span> SIGRTMIN+1	<span class="token number">36</span><span class="token punctuation">)</span> SIGRTMIN+2	<span class="token number">37</span><span class="token punctuation">)</span> SIGRTMIN+3
<span class="token number">38</span><span class="token punctuation">)</span> SIGRTMIN+4	<span class="token number">39</span><span class="token punctuation">)</span> SIGRTMIN+5	<span class="token number">40</span><span class="token punctuation">)</span> SIGRTMIN+6	<span class="token number">41</span><span class="token punctuation">)</span> SIGRTMIN+7	<span class="token number">42</span><span class="token punctuation">)</span> SIGRTMIN+8
<span class="token number">43</span><span class="token punctuation">)</span> SIGRTMIN+9	<span class="token number">44</span><span class="token punctuation">)</span> SIGRTMIN+10	<span class="token number">45</span><span class="token punctuation">)</span> SIGRTMIN+11	<span class="token number">46</span><span class="token punctuation">)</span> SIGRTMIN+12	<span class="token number">47</span><span class="token punctuation">)</span> SIGRTMIN+13
<span class="token number">48</span><span class="token punctuation">)</span> SIGRTMIN+14	<span class="token number">49</span><span class="token punctuation">)</span> SIGRTMIN+15	<span class="token number">50</span><span class="token punctuation">)</span> SIGRTMAX-14	<span class="token number">51</span><span class="token punctuation">)</span> SIGRTMAX-13	<span class="token number">52</span><span class="token punctuation">)</span> SIGRTMAX-12
<span class="token number">53</span><span class="token punctuation">)</span> SIGRTMAX-11	<span class="token number">54</span><span class="token punctuation">)</span> SIGRTMAX-10	<span class="token number">55</span><span class="token punctuation">)</span> SIGRTMAX-9	<span class="token number">56</span><span class="token punctuation">)</span> SIGRTMAX-8	<span class="token number">57</span><span class="token punctuation">)</span> SIGRTMAX-7
<span class="token number">58</span><span class="token punctuation">)</span> SIGRTMAX-6	<span class="token number">59</span><span class="token punctuation">)</span> SIGRTMAX-5	<span class="token number">60</span><span class="token punctuation">)</span> SIGRTMAX-4	<span class="token number">61</span><span class="token punctuation">)</span> SIGRTMAX-3	<span class="token number">62</span><span class="token punctuation">)</span> SIGRTMAX-2
<span class="token number">63</span><span class="token punctuation">)</span> SIGRTMAX-1	<span class="token number">64</span><span class="token punctuation">)</span> SIGRTMAX
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">在上个阶段的最后，我们还简单地了解了信号的 default action，然而对于大部分信号而言，进程可以对特定的信号进行忽略或设置自己的信号处理程序。</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="5.2 Signal Control" dir="auto" class="heading" id="5.2_Signal_Control"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.2 Signal Control</h3><div class="heading-children"><div class="el-h4 heading-wrapper"><h4 data-heading="5.2.1 Kernel Data Structure (`include/linux/sched/signal.h`)" dir="auto" class="heading" id="5.2.1_Kernel_Data_Structure_(`include/linux/sched/signal.h`)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.2.1 Kernel Data Structure (<code>include/linux/sched/signal.h</code>)</h4><div class="heading-children"><div class="el-p"><p dir="auto">学完进程，我们现在知道每个进程会对应一个 <code>task_struct</code> 结构体，其中，就有很多与信号相关的数据结构。对于信号的管理，我们有 <code>signal_struct</code> 结构体、<code>sighand_struct</code>、信号集 <code>sigset_t</code> 和用于记录当前挂起信号的 <code>sigpending</code> 结构体。</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">struct</span> <span class="token class-name">task_struct</span><span class="token punctuation">{</span>
<span class="token comment">// ...</span>
	<span class="token comment">// 指向一个signal_struct结构体的指针。用于管理与进程相关的信号信息。</span>
	<span class="token keyword">struct</span> <span class="token class-name">signal_struct</span> <span class="token operator">*</span>signal<span class="token punctuation">;</span> 
	<span class="token comment">// 指向一个sighand_struct结构体。用于管理信号服务例程。	</span>
	<span class="token keyword">struct</span> <span class="token class-name">sighand_struct</span> <span class="token operator">*</span>sighand<span class="token punctuation">;</span> 
	<span class="token comment">// 用于表示当前被阻塞的信号。其中sigset_t是一个64位的位掩码。</span>
	<span class="token class-name">sigset_t</span> blocked<span class="token punctuation">;</span>
	<span class="token comment">// sigpending用于表示当前挂起的信号。</span>
	<span class="token keyword">struct</span> <span class="token class-name">sigpending</span> pending<span class="token punctuation">;</span>
<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20250128190859.png" src="Pasted image 20250128190859.png" class="internal-embed media-embed image-embed is-loaded"><img alt="Pasted image 20250128190859.png" src="congzhi's-os-series/pics/pasted-image-20250128190859.png"></span></p></div><div class="el-h5 heading-wrapper"><h5 data-heading="5.2.1.1 `struct signal_struct`" dir="auto" class="heading" id="5.2.1.1_`struct_signal_struct`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.2.1.1 <code>struct signal_struct</code></h5><div class="heading-children"><div class="el-p"><p dir="auto">在 <code>task_struct</code> 中，我们看到每个进程私有的挂起信号 <code>sigpending</code>。而在 <code>signal_struct</code> 中，我们还有一个存放进程组共享挂起信号的数据结构 <code>shared_pending</code>。在学习<a data-tooltip-position="top" aria-label="6. Processing The Processes > 3.2.1 Process Group" data-href="6. Processing The Processes#3.2.1 Process Group" href="congzhi's-os-series/6.-processing-the-processes.html#3.2.1_Process_Group" class="internal-link" target="_self" rel="noopener nofollow">进程组</a>时提到，信号的处理可以以进程组为单位进行。当信号发出时，信号会被存放在 <code>shared_pending</code> 结构体中。</p></div><div class="el-p"><p dir="auto"><code>signal_struct</code>的结构体原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">struct</span> <span class="token class-name">signal_struct</span> <span class="token punctuation">{</span>
    <span class="token class-name">atomic_t</span> sigcnt<span class="token punctuation">;</span>
    <span class="token class-name">atomic_t</span> live<span class="token punctuation">;</span>
    <span class="token keyword">int</span> nr_threads<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> thread_head<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigpending</span> shared_pending<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigpending</span> group_exit_pending<span class="token punctuation">;</span>
    <span class="token keyword">int</span> group_exit_code<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rcu_head</span> rcu<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. sigcnt: Atomic counter for the number of signals.
	2. live: Atomic counter for the number of live processes in the signal group.
	3. nr_threads: Number of threads in the signal group.
	4. thread_head: List head for the threads in the signal group.
	5. shared_pending: Shared pending signals for the signal group.
	6. group_exit_pending: Pending signals for group exit.
	7. group_exit_code: Exit code for the group exit.
	8. flags: Flags for the signal group.
	9. rcu: RCU head for the signal group.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="5.2.1.2 `typedef unsigned long sigset_t`" dir="auto" class="heading" id="5.2.1.2_`typedef_unsigned_long_sigset_t`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.2.1.2 <code>typedef unsigned long sigset_t</code></h5><div class="heading-children"><div class="el-p"><p dir="auto"><code>sigset_t</code> 实际上是一个位掩码(bitmask)，用于表示一组信号。在许多操作系统中，<code>sigset_t</code> 是一个 64 位的 <code>unsigned long</code> 数据类型，每一位代表一个信号。由于我们有 64 种信号，因此每一位可以表示一个信号的状态。当我们发送某个信号时，就将 <code>sigset_t</code> 的那一位置为 1。</p></div><div class="el-p"><p dir="auto">信号的轻量型就体现在这种使用位操作来管理和操作信号集的方式。</p></div></div></div><div class="el-h5 heading-wrapper"><h5 data-heading="5.2.1.3 `sighand_struct`" dir="auto" class="heading" id="5.2.1.3_`sighand_struct`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.2.1.3 <code>sighand_struct</code></h5><div class="heading-children"><div class="el-p"><p dir="auto"><code>sighand_struct</code>是信号处理程序的结构体，其中包括三个参数。我们需要关注的是<code>struct k_sigaction action[64];</code>。从数组的大小就能看来，其对应Linux中支持的64种信号，根据数组编号的不同，记录着不同信号的处理方式（actions）。</p></div><div class="el-p"><p dir="auto">结构体<code>k_sigaction</code>的原型如下：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">struct</span> <span class="token class-name">k_sigaction</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sa_flags<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_restorer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __sigaction_handler_t sa_handler<span class="token punctuation">;</span>
    <span class="token class-name">sigset_t</span> sa_mask<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. sa: User-defined signal handler structure, containing the signal handling function and signal mask.
	2. sa_flags: Signal handling flags, used to control the behavior of signal handling.
	3. sa_restorer: Restorer function pointer, used to restore the execution environment after the signal handler returns.
	4. sa_handler: User-defined signal handler function pointer.
	5. sa_mask: Signal mask, used to block certain signals during the execution of the signal handler.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">其中的<code>struct sigaction</code>就是用于定义信号处理程序的结构体。其参数包含信号处理函数、信号掩码和控制标志等。下面是<code>struct sigaction</code>的结构体原型：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_sigaction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token class-name">siginfo_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">sigset_t</span> sa_mask<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sa_flags<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_restorer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. sa_handler: Signal handling function pointer, which is called when the signal is received.
	2. sa_sigaction: Alternative signal handling function pointer, used when the SA_SIGINFO flag is set.
	3. sa_mask: Signal mask, used to block certain signals during the execution of the signal handler.
	4. sa_flags: Signal handling flags, used to control the behavior of signal handling.
	5. sa_restorer: Restorer function pointer, used to restore the execution environment after the signal handler returns.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">这里面，<code>sa_handler</code>是指向信号处理函数的函数指针，当收到信号时调用。这里我们可以使用预定义的常量<code>SIG_DFL</code>（默认信号处理）或者<code>SIG_IGN</code>（忽略信号）来设置这个字段。</p></div></div></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="5.1.3 Signal Blocking and Signal Pending" dir="auto" class="heading" id="5.1.3_Signal_Blocking_and_Signal_Pending"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.1.3 Signal Blocking and Signal Pending</h4><div class="heading-children"><div class="el-p"><p dir="auto">信号可以被阻塞屏蔽(blocked)，被屏蔽信号不会立即被传递给进程的信号处理程序。这些信号会被保留，直到它被解除屏蔽后才会被处理。屏蔽进程用于阻止某些信号的干扰，以确保进程在关键操作期间不会被信号中断。在屏蔽期间到来的信号并不会被处理，我们称之为信号的挂起(pending)。每个线程都会有自己的挂起信号集(pending signal set)，集合中的信号表示不是0就是1（表示被挂起，需要被处理）,一个信号无论有被挂起多少次，最终只会被处理一次。进程的信号挂起集合是有线程屏蔽集合合并生成的。<code>fork(2)</code>创建好的子进程会初始化自己的集合。</p></div><div class="el-p"><p dir="auto">进程可以使用<code>sigprocmask(2)</code>来操作信号的屏蔽，作用于下辖所有的线程。在多线程的环境中，使用 <code>pthread_sigmask(2)</code> 可以确保信号屏蔽设置仅影响当前线程。fork但子进程会继承父进程对信号的屏蔽，在<code>execve(2)</code>后仍然会保留。</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="5.3 Signal Handling" dir="auto" class="heading" id="5.3_Signal_Handling"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.3 Signal Handling</h3><div class="heading-children"><div class="el-p"><p dir="auto">如果我们什么都不做，不同的信号会表现出不同的默认操作。根据信号的不同，不同的信号有以下五种不同的 default action：</p></div><div class="el-table" dir="ltr" style="overflow-x: auto;"><table>
<thead>
<tr>
<th dir="ltr">Default Action</th>
<th dir="ltr">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td dir="ltr">Term</td>
<td dir="ltr">to terminate the process</td>
</tr>
<tr>
<td dir="ltr">Ign</td>
<td dir="ltr">to ignore the signal</td>
</tr>
<tr>
<td dir="ltr">Core</td>
<td dir="ltr">to terminate the process and core dump</td>
</tr>
<tr>
<td dir="ltr">Stop</td>
<td dir="ltr">to stop the process</td>
</tr>
<tr>
<td dir="ltr">Cont</td>
<td dir="ltr">to continue the process if it is currently stopped.</td>
</tr>
</tbody>
</table></div><div class="el-p"><p dir="auto">一个进程可以使用<code>signal(2)</code>或<code>sigaction(2)</code>来改变信号的默认处理方式。当一个信号被传送给进程时，对于大多数信号，进程可以自行决定是按照默认方式处理呢、还是忽视掉这个信号、亦或是使用一个自定义的函数来处理信号。进程的处理方式是一个per-process的事情，这就意味着同一进程中的不同线程对于相同信号的处理方法是一样的。<code>fork()</code>后，子进程的信号处理和父进程相同，在<code>execve(2)</code>后改变。</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="5.4 Signal Sending and Receiving" dir="auto" class="heading" id="5.4_Signal_Sending_and_Receiving"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.4 Signal Sending and Receiving</h3><div class="heading-children"><div class="el-p"><p dir="auto">信号有很多不同的类型，分别代表着不同事件的发生。信号可以由内核、其他进程或自身进程发送，用于通知进程发生了某些事件。当一个进程向另一个进程发送信号时，会经由内核将信号传递给目标进程，内核起到中介的作用。</p></div><div class="el-h4 heading-wrapper"><h4 data-heading="5.4.1 Sending a Signal" dir="auto" class="heading" id="5.4.1_Sending_a_Signal"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.4.1 Sending a Signal</h4><div class="heading-children"><div class="el-p"><p dir="auto">Send a signal, raise a flag，信号非常小，一般不携带数据信息，所以当我们说信号是轻量级的进程间通信。当进程发送一个信号时，内核会在目标进程的信号队列（signal pending set）中添加该信号，并在适当的时候将其传递给目标进程。信号可能被阻塞，这就意味着信号暂时不会被处理。若未阻塞信号，目标进程接收到信号后，会在适当的实际用预先设定的信号处理程序来处理该信号。</p></div><div class="el-p"><p dir="auto">根据不同的系统调用接口，信号会被发送给进程组（<code>killpg()</code>）、进程（<code>kill()</code>, <code>sigqueue()</code>, <code>pid_send_signal()</code>）或是线程（<code>raise()</code>, <code>pthread_kill()</code>, <code>tgkill()</code>）。当信号发送给线程时，特定的线程会在未阻塞相关信号时对其进行处理。当发送给进程时，本着阻塞不绝对就是绝对不阻塞的原则，内核会任意挑选一个未对特点信号进行阻塞的线程来处理相关的信号服务例程。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="5.4.2 Waiting for a Signal to be Caught" dir="auto" class="heading" id="5.4.2_Waiting_for_a_Signal_to_be_Caught"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.4.2 Waiting for a Signal to be Caught</h4><div class="heading-children"><div class="el-p"><p dir="auto">我们有两个系统调用 <code>pause()</code> 和 <code>sigsuspend()</code> 来挂起线程的执行，直到有信号被捕获。</p></div><div class="el-p"><p dir="auto"><code>pause()</code> 系统调用会挂起执行，捕获任何信号都会让线程接着执行。</p></div><div class="el-p"><p dir="auto"><code>sigsuspend()</code> 也会挂起线程，但不同的是，<code>sigsuspend()</code> 会临时改变信号屏蔽字，并且只会在未被屏蔽的信号被捕获时才恢复线程的执行。这使得 <code>sigsuspend()</code> 更灵活，因为你能控制在等待时哪些信号是屏蔽的，哪些信号是可处理的。</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="5.4.3 Receiving a Signal" dir="auto" class="heading" id="5.4.3_Receiving_a_Signal"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.4.3 Receiving a Signal</h4><div class="heading-children"></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="5.1.4 Execution of Signal Handler" dir="auto" class="heading" id="5.1.4_Execution_of_Signal_Handler"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.1.4 Execution of Signal Handler</h4><div class="heading-children"><div class="el-p"><p dir="auto">当发生从内核态到用户态的转变（系统调用返回、发生线程的调度）时，内核会检查是否有未阻塞的挂起信号。如果进程自己注册了相关的信号服务例程，那么一旦发生从内核态到用户态的转变，就会发生：</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">挂起信号集合中的相关位清零（信号从集合中移除）。</li>
<li data-line="1" dir="auto">如果信号处理函数是使用<code>sigaction</code>系统调用注册的，并且指定了<code>SA_ONSTACK</code>标志。内核会为信号处理函数加载一个单独的信号栈（默认信号的服务例程在进程的栈空间中建立栈帧）。</li>
<li data-line="2" dir="auto">和中断类似的，执行handler前，我们还要将一些上下文信息保存到一个栈帧里，便于信号处理完毕后恢复继续执行。</li>
<li data-line="3" dir="auto">之后，内核会为信号处理程序构建一个栈帧，设置PC为指向信号处理程序函数的第一条指令。</li>
<li data-line="4" dir="auto">内核将控制权交给用户空间，信号处理程序开始处理。完成后将控制权交给signal trampoline。</li>
<li data-line="5" dir="auto">signal trampoline调用<code>sigreturn(2)</code>，这个系统调用和恢复上下文，继续执行有关。</li>
</ol></div><div class="el-p"><p dir="auto">从内核的角度来看，信号处理程序代码的执行与任何其他用户空间代码的执行完全相同。也就是说，内核不会记录任何特殊的状态信息来指示线程当前正在执行信号处理程序。所有必要的状态信息都保存在用户空间的寄存器和用户空间栈中。嵌套信号处理程序的调用深度仅受用户空间栈的限制（以及合理的软件设计）。</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="5.2 Signal Handling in Practice" dir="auto" class="heading" id="5.2_Signal_Handling_in_Practice"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>5.2 Signal Handling in Practice</h3><div class="heading-children"><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
Parameters:
	1. sig: The signal number to be handled. Common signals include SIGINT, SIGTERM, SIGKILL, etc.
	2. handler: A pointer to the signal handling function. This function takes a single argument of type int (the signal number) and returns void.
		- SIG_IGN: Ignore the signal.
		- SIG_DFL: Treat signal as its default manner.
		- Your own handler.

Return value:
	- On success: Returns the previous signal handler.
	- On failure: Returns SIG_ERR and sets errno appropriately.
*/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="The Null Signal" dir="auto" class="heading" id="The_Null_Signal"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>The Null Signal</h3><div class="heading-children"><div class="el-p"><p dir="auto">null 信号（信号值为 0）是 Unix-like 系统中的一个特殊信号。在前面，我们看到记录信号的结构 <code>sigset_t</code> 只有 64 位。所以 null 信号实际上不存在，他没有任何 default action，它唯一的作用就是测试。用于检测进程是否存在或测试用户权限。</p></div><div class="el-pre"><pre class="language-cpp" tabindex="0"><code data-line="0" class="language-cpp is-loaded"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// the process exists and we have promission to send a signal</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// the process is non-existing, or we don't have much promission</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="mod-footer mod-ui"></div></div></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#6.5 Inter-Process Communications"><div class="tree-item-contents heading-link" heading-name="6.5 Inter-Process Communications"><span class="tree-item-title">6.5 Inter-Process Communications</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#第一课_IPC"><div class="tree-item-contents heading-link" heading-name="第一课 IPC"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第一课 IPC</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#1.1_IPC_Motivation"><div class="tree-item-contents heading-link" heading-name="1.1 IPC Motivation"><span class="tree-item-title">1.1 IPC Motivation</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#1.3_IPC_Types"><div class="tree-item-contents heading-link" heading-name="1.3 IPC Types"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.3 IPC Types</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#1.3.1_IPC_on_the_Same_Machine"><div class="tree-item-contents heading-link" heading-name="1.3.1 IPC on the Same Machine"><span class="tree-item-title">1.3.1 IPC on the Same Machine</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#1.3.2_IPC_on_Different_Machines"><div class="tree-item-contents heading-link" heading-name="1.3.2 IPC on Different Machines"><span class="tree-item-title">1.3.2 IPC on Different Machines</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#1.3_Send-Receive_Protocol"><div class="tree-item-contents heading-link" heading-name="1.3 Send-Receive Protocol"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.3 Send-Receive Protocol</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#1.3.1_Formats"><div class="tree-item-contents heading-link" heading-name="1.3.1 Formats"><span class="tree-item-title">1.3.1 Formats</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#1.3.2_Order"><div class="tree-item-contents heading-link" heading-name="1.3.2 Order"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">1.3.2 Order</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#1.3.2.1_Synchronous"><div class="tree-item-contents heading-link" heading-name="1.3.2.1 Synchronous"><span class="tree-item-title">1.3.2.1 Synchronous</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#1.3.2.2_Asynchronous"><div class="tree-item-contents heading-link" heading-name="1.3.2.2 Asynchronous"><span class="tree-item-title">1.3.2.2 Asynchronous</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#第二课_Sockets_for_Network_Communication"><div class="tree-item-contents heading-link" heading-name="第二课 Sockets for Network Communication"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第二课 Sockets for Network Communication</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.1_Sockets"><div class="tree-item-contents heading-link" heading-name="2.1 Sockets"><span class="tree-item-title">2.1 Sockets</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2_Sockets_as_Files"><div class="tree-item-contents heading-link" heading-name="2.2 Sockets as Files"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.2 Sockets as Files</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.1_socket()_Attr."><div class="tree-item-contents heading-link" heading-name="2.2.1 socket() Attr."><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.2.1 socket() Attr.</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.1.1_`domain`"><div class="tree-item-contents heading-link" heading-name="2.2.1.1 `domain`"><span class="tree-item-title">2.2.1.1 <code>domain</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.1.2_`type`"><div class="tree-item-contents heading-link" heading-name="2.2.1.2 `type`"><span class="tree-item-title">2.2.1.2 <code>type</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.1.3_`protocol`"><div class="tree-item-contents heading-link" heading-name="2.2.1.3 `protocol`"><span class="tree-item-title">2.2.1.3 <code>protocol</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.1.4_Illegal_Combination"><div class="tree-item-contents heading-link" heading-name="2.2.1.4 Illegal Combination"><span class="tree-item-title">2.2.1.4 Illegal Combination</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.2_Creating_an_Socket"><div class="tree-item-contents heading-link" heading-name="2.2.2 Creating an Socket"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.2.2 Creating an Socket</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.2.1_TCP_Sockets_in_IPv4"><div class="tree-item-contents heading-link" heading-name="2.2.2.1 TCP Sockets in IPv4"><span class="tree-item-title">2.2.2.1 TCP Sockets in IPv4</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.2.2_UDP_Sockets_in_IPv4"><div class="tree-item-contents heading-link" heading-name="2.2.2.2 UDP Sockets in IPv4"><span class="tree-item-title">2.2.2.2 UDP Sockets in IPv4</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.3._`setsockopt()`"><div class="tree-item-contents heading-link" heading-name="2.2.3. `setsockopt()`"><span class="tree-item-title">2.2.3. <code>setsockopt()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.4_Endianness_and_Network_Byte_Order"><div class="tree-item-contents heading-link" heading-name="2.2.4 Endianness and Network Byte Order"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.2.4 Endianness and Network Byte Order</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.4.1_Host&nbsp;and&nbsp;Network&nbsp;Byte&nbsp;Order&nbsp;Conversion"><div class="tree-item-contents heading-link" heading-name="2.2.4.1 Host&nbsp;and&nbsp;Network&nbsp;Byte&nbsp;Order&nbsp;Conversion"><span class="tree-item-title">2.2.4.1 Host&nbsp;and&nbsp;Network&nbsp;Byte&nbsp;Order&nbsp;Conversion</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.4.2_Decimal_Presentation_and&nbsp;Network_Byte_Order_Address_Conversion"><div class="tree-item-contents heading-link" heading-name="2.2.4.2 Decimal Presentation and&nbsp;Network Byte Order Address Conversion"><span class="tree-item-title">2.2.4.2 Decimal Presentation and&nbsp;Network Byte Order Address Conversion</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.5_Socket_Addresses"><div class="tree-item-contents heading-link" heading-name="2.2.5 Socket Addresses"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.2.5 Socket Addresses</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.5.1_IPv4_Address"><div class="tree-item-contents heading-link" heading-name="2.2.5.1 IPv4 Address"><span class="tree-item-title">2.2.5.1 IPv4 Address</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.5.2_IPv6_Address"><div class="tree-item-contents heading-link" heading-name="2.2.5.2 IPv6 Address"><span class="tree-item-title">2.2.5.2 IPv6 Address</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.5.3_Local_Domain_Address"><div class="tree-item-contents heading-link" heading-name="2.2.5.3 Local Domain Address"><span class="tree-item-title">2.2.5.3 Local Domain Address</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.5.4_Port_Number:_Just_Like_the_House_Number"><div class="tree-item-contents heading-link" heading-name="2.2.5.4 Port Number: Just Like the House Number"><span class="tree-item-title">2.2.5.4 Port Number: Just Like the House Number</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.5.5_String_<--->_IP_Address"><div class="tree-item-contents heading-link" heading-name="2.2.5.5 String <---> IP Address"><span class="tree-item-title">2.2.5.5 String &lt;---&gt; IP Address</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.5.6_Initial_the_Network_Address_(IPv4)"><div class="tree-item-contents heading-link" heading-name="2.2.5.6 Initial the Network Address (IPv4)"><span class="tree-item-title">2.2.5.6 Initial the Network Address (IPv4)</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.2.6_Get_the_Address"><div class="tree-item-contents heading-link" heading-name="2.2.6 Get the Address"><span class="tree-item-title">2.2.6 Get the Address</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.3_Client_Workflow:_Connect_(TCP)"><div class="tree-item-contents heading-link" heading-name="2.3 Client Workflow: Connect (TCP)"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.3 Client Workflow: Connect (TCP)</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.3.1_`connect()`"><div class="tree-item-contents heading-link" heading-name="2.3.1 `connect()`"><span class="tree-item-title">2.3.1 <code>connect()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.3.2_Say_Hello_to_Server"><div class="tree-item-contents heading-link" heading-name="2.3.2 Say Hello to Server"><span class="tree-item-title">2.3.2 Say Hello to Server</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.4_Server_Workflow:_Bind,_Listen_and_Accept_(TCP)"><div class="tree-item-contents heading-link" heading-name="2.4 Server Workflow: Bind, Listen and Accept (TCP)"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.4 Server Workflow: Bind, Listen and Accept (TCP)</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.4.1_`bind()`"><div class="tree-item-contents heading-link" heading-name="2.4.1 `bind()`"><span class="tree-item-title">2.4.1 <code>bind()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.4.2_`listen()`"><div class="tree-item-contents heading-link" heading-name="2.4.2 `listen()`"><span class="tree-item-title">2.4.2 <code>listen()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.4.3_`accept()`"><div class="tree-item-contents heading-link" heading-name="2.4.3 `accept()`"><span class="tree-item-title">2.4.3 <code>accept()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.5_Communication_(TCP)"><div class="tree-item-contents heading-link" heading-name="2.5 Communication (TCP)"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.5 Communication (TCP)</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.5.1_`send()`"><div class="tree-item-contents heading-link" heading-name="2.5.1 `send()`"><span class="tree-item-title">2.5.1 <code>send()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.5.2_`recv()`"><div class="tree-item-contents heading-link" heading-name="2.5.2 `recv()`"><span class="tree-item-title">2.5.2 <code>recv()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.5.3_Are_You_Still_There?"><div class="tree-item-contents heading-link" heading-name="2.5.3 Are You Still There?"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.5.3 Are You Still There?</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.5.3.1_TCP_Keep-Alive"><div class="tree-item-contents heading-link" heading-name="2.5.3.1 TCP Keep-Alive"><span class="tree-item-title">2.5.3.1 TCP Keep-Alive</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.5.3.2_Timeouts"><div class="tree-item-contents heading-link" heading-name="2.5.3.2 Timeouts"><span class="tree-item-title">2.5.3.2 Timeouts</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.5.3.3_Heartbeat_Messages"><div class="tree-item-contents heading-link" heading-name="2.5.3.3 Heartbeat Messages"><span class="tree-item-title">2.5.3.3 Heartbeat Messages</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.5.4_Use_Format_to_Serialization"><div class="tree-item-contents heading-link" heading-name="2.5.4 Use Format to Serialization"><span class="tree-item-title">2.5.4 Use Format to Serialization</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.6_Datagrams"><div class="tree-item-contents heading-link" heading-name="2.6 Datagrams"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.6 Datagrams</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.6.1_sendto()"><div class="tree-item-contents heading-link" heading-name="2.6.1 sendto()"><span class="tree-item-title">2.6.1 sendto()</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.6.2_recvfrom()"><div class="tree-item-contents heading-link" heading-name="2.6.2 recvfrom()"><span class="tree-item-title">2.6.2 recvfrom()</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.7_cURL_(libcurl)"><div class="tree-item-contents heading-link" heading-name="2.7 cURL (libcurl)"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.7 cURL (libcurl)</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.7.1_Webservices"><div class="tree-item-contents heading-link" heading-name="2.7.1 Webservices"><span class="tree-item-title">2.7.1 Webservices</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.7.2_Callbacks_Setting_Up"><div class="tree-item-contents heading-link" heading-name="2.7.2 Callbacks Setting Up"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">2.7.2 Callbacks Setting Up</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.7.2.1_Read_Callback"><div class="tree-item-contents heading-link" heading-name="2.7.2.1 Read Callback"><span class="tree-item-title">2.7.2.1 Read Callback</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.7.2.2_Write_Callback"><div class="tree-item-contents heading-link" heading-name="2.7.2.2 Write Callback"><span class="tree-item-title">2.7.2.2 Write Callback</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#2.7.2.3_Registration_of_Callback"><div class="tree-item-contents heading-link" heading-name="2.7.2.3 Registration of Callback"><span class="tree-item-title">2.7.2.3 Registration of Callback</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#第三课_Pipes_and_Shared_Memory"><div class="tree-item-contents heading-link" heading-name="第三课 Pipes and Shared Memory"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第三课 Pipes and Shared Memory</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.1_UNIX_Pipes"><div class="tree-item-contents heading-link" heading-name="3.1 UNIX Pipes"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">3.1 UNIX Pipes</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.1.1_Ordinary_Pipes(Anonymous_Pipes)"><div class="tree-item-contents heading-link" heading-name="3.1.1 Ordinary Pipes(Anonymous Pipes)"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">3.1.1 Ordinary Pipes(Anonymous Pipes)</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.1.1.1_Creating_an_Anonymous_Pipe"><div class="tree-item-contents heading-link" heading-name="3.1.1.1 Creating an Anonymous Pipe"><span class="tree-item-title">3.1.1.1 Creating an Anonymous Pipe</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.1.2_FIFO_(Named_Pipe)"><div class="tree-item-contents heading-link" heading-name="3.1.2 FIFO (Named Pipe)"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">3.1.2 FIFO (Named Pipe)</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.1.2.1_Creating_a_Named_Pipe"><div class="tree-item-contents heading-link" heading-name="3.1.2.1 Creating a Named Pipe"><span class="tree-item-title">3.1.2.1 Creating a Named Pipe</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.1.3_Pipe_and_Disk_I/O"><div class="tree-item-contents heading-link" heading-name="3.1.3 Pipe and Disk I/O"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">3.1.3 Pipe and Disk I/O</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.1.3.1_Anonymous_Pipes_Have_Nothing_To_Do_with_Disk"><div class="tree-item-contents heading-link" heading-name="3.1.3.1 Anonymous Pipes Have Nothing To Do with Disk"><span class="tree-item-title">3.1.3.1 Anonymous Pipes Have Nothing To Do with Disk</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.1.3.2_Named_Pipes_Use_Disk_I/O"><div class="tree-item-contents heading-link" heading-name="3.1.3.2 Named Pipes Use Disk I/O"><span class="tree-item-title">3.1.3.2 Named Pipes Use Disk I/O</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.2_Shared_Memory"><div class="tree-item-contents heading-link" heading-name="3.2 Shared Memory"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">3.2 Shared Memory</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.2.1&nbsp;shm&nbsp;in&nbsp;POSIX"><div class="tree-item-contents heading-link" heading-name="3.2.1&nbsp;shm&nbsp;in&nbsp;POSIX"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">3.2.1&nbsp;shm&nbsp;in&nbsp;POSIX</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.2.1.1_`shm_open()`"><div class="tree-item-contents heading-link" heading-name="3.2.1.1 `shm_open()`"><span class="tree-item-title">3.2.1.1 <code>shm_open()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.2.1.2_`ftruncate()`"><div class="tree-item-contents heading-link" heading-name="3.2.1.2 `ftruncate()`"><span class="tree-item-title">3.2.1.2 <code>ftruncate()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.2.1.3_`close()`"><div class="tree-item-contents heading-link" heading-name="3.2.1.3 `close()`"><span class="tree-item-title">3.2.1.3 <code>close()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.2.1.4_`shm_unlink()`"><div class="tree-item-contents heading-link" heading-name="3.2.1.4 `shm_unlink()`"><span class="tree-item-title">3.2.1.4 <code>shm_unlink()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.2.1.5_Manipulate_a_shm_Object"><div class="tree-item-contents heading-link" heading-name="3.2.1.5 Manipulate a shm Object"><span class="tree-item-title">3.2.1.5 Manipulate a shm Object</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.2.1.6_Shared_Memory_Implementation_Mechanism_|_POSIX"><div class="tree-item-contents heading-link" heading-name="3.2.1.6 Shared Memory Implementation Mechanism | POSIX"><span class="tree-item-title">3.2.1.6 Shared Memory Implementation Mechanism | POSIX</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.2.2&nbsp;shm&nbsp;in&nbsp;System&nbsp;V"><div class="tree-item-contents heading-link" heading-name="3.2.2&nbsp;shm&nbsp;in&nbsp;System&nbsp;V"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">3.2.2&nbsp;shm&nbsp;in&nbsp;System&nbsp;V</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.2.2.1_shm_Get"><div class="tree-item-contents heading-link" heading-name="3.2.2.1 shm Get"><span class="tree-item-title">3.2.2.1 shm Get</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.2.2.2_shm_Attachment"><div class="tree-item-contents heading-link" heading-name="3.2.2.2 shm Attachment"><span class="tree-item-title">3.2.2.2 shm Attachment</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.2.2.3_shm_Detachment"><div class="tree-item-contents heading-link" heading-name="3.2.2.3 shm Detachment"><span class="tree-item-title">3.2.2.3 shm Detachment</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.2.2.4_shm_Control"><div class="tree-item-contents heading-link" heading-name="3.2.2.4 shm Control"><span class="tree-item-title">3.2.2.4 shm Control</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.3_Message_Queue"><div class="tree-item-contents heading-link" heading-name="3.3 Message Queue"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">3.3 Message Queue</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.3.1_Message_Queue_in_POSIX"><div class="tree-item-contents heading-link" heading-name="3.3.1 Message Queue in POSIX"><span class="tree-item-title">3.3.1 Message Queue in POSIX</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.3.2_Message_Queue_in_System_V"><div class="tree-item-contents heading-link" heading-name="3.3.2 Message Queue in System V"><span class="tree-item-title">3.3.2 Message Queue in System V</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.4_IPC_Comparisons"><div class="tree-item-contents heading-link" heading-name="3.4 IPC Comparisons"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">3.4 IPC Comparisons</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.4.1_Shared_Memory_in_Differnet_Standards"><div class="tree-item-contents heading-link" heading-name="3.4.1 Shared Memory in Differnet Standards"><span class="tree-item-title">3.4.1 Shared Memory in Differnet Standards</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.4.2_Shared_Memory_vs._Pipes"><div class="tree-item-contents heading-link" heading-name="3.4.2 Shared Memory vs. Pipes"><span class="tree-item-title">3.4.2 Shared Memory vs. Pipes</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#3.4.3_Pipes_vs._Message_Queue"><div class="tree-item-contents heading-link" heading-name="3.4.3 Pipes vs. Message Queue"><span class="tree-item-title">3.4.3 Pipes vs. Message Queue</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#第四课_Memory_Mapped_Files"><div class="tree-item-contents heading-link" heading-name="第四课 Memory Mapped Files"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第四课 Memory Mapped Files</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#4.1_How_Files_are_Opened"><div class="tree-item-contents heading-link" heading-name="4.1 How Files are Opened"><span class="tree-item-title">4.1 How Files are Opened</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#4.2_Memory_Mapping_Files_Implementation:`mmap()`"><div class="tree-item-contents heading-link" heading-name="4.2 Memory Mapping Files Implementation:`mmap()`"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">4.2 Memory Mapping Files Implementation:<code>mmap()</code></span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#4.2.1_`mmap()`"><div class="tree-item-contents heading-link" heading-name="4.2.1 `mmap()`"><span class="tree-item-title">4.2.1 <code>mmap()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#4.2.2_Protection_Access_Modification:_`mprotect()`"><div class="tree-item-contents heading-link" heading-name="4.2.2 Protection Access Modification: `mprotect()`"><span class="tree-item-title">4.2.2 Protection Access Modification: <code>mprotect()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#4.2.3_Mapping_Consistency_Guarantee_:_`msync()"><div class="tree-item-contents heading-link" heading-name="4.2.3 Mapping Consistency Guarantee : `msync()"><span class="tree-item-title">4.2.3 Mapping Consistency Guarantee : `msync()</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#4.2.4_Memory_Un-Mapping_:_`munmap()`"><div class="tree-item-contents heading-link" heading-name="4.2.4 Memory Un-Mapping : `munmap()`"><span class="tree-item-title">4.2.4 Memory Un-Mapping : <code>munmap()</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#4.3_IPC_with_`mmap()`"><div class="tree-item-contents heading-link" heading-name="4.3 IPC with `mmap()`"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">4.3 IPC with <code>mmap()</code></span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#4.3.1_`MAP_PRIVATE`_and_`MAP_SHARED`"><div class="tree-item-contents heading-link" heading-name="4.3.1 `MAP_PRIVATE` and `MAP_SHARED`"><span class="tree-item-title">4.3.1 <code>MAP_PRIVATE</code> and <code>MAP_SHARED</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#4.3.2_Anonymous_Mapping"><div class="tree-item-contents heading-link" heading-name="4.3.2 Anonymous Mapping"><span class="tree-item-title">4.3.2 Anonymous Mapping</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#4.4_Easy_Peasy_Example"><div class="tree-item-contents heading-link" heading-name="4.4 Easy Peasy Example"><span class="tree-item-title">4.4 Easy Peasy Example</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#第五课_IPC_for_Process_Control:_Signals"><div class="tree-item-contents heading-link" heading-name="第五课 IPC for Process Control: Signals"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">第五课 IPC for Process Control: Signals</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.1_Signaling_vs._Exception"><div class="tree-item-contents heading-link" heading-name="5.1 Signaling vs. Exception"><span class="tree-item-title">5.1 Signaling vs. Exception</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.2_Signal_Control"><div class="tree-item-contents heading-link" heading-name="5.2 Signal Control"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">5.2 Signal Control</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.2.1_Kernel_Data_Structure_(`include/linux/sched/signal.h`)"><div class="tree-item-contents heading-link" heading-name="5.2.1 Kernel Data Structure (`include/linux/sched/signal.h`)"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">5.2.1 Kernel Data Structure (<code>include/linux/sched/signal.h</code>)</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.2.1.1_`struct_signal_struct`"><div class="tree-item-contents heading-link" heading-name="5.2.1.1 `struct signal_struct`"><span class="tree-item-title">5.2.1.1 <code>struct signal_struct</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.2.1.2_`typedef_unsigned_long_sigset_t`"><div class="tree-item-contents heading-link" heading-name="5.2.1.2 `typedef unsigned long sigset_t`"><span class="tree-item-title">5.2.1.2 <code>typedef unsigned long sigset_t</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="5"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.2.1.3_`sighand_struct`"><div class="tree-item-contents heading-link" heading-name="5.2.1.3 `sighand_struct`"><span class="tree-item-title">5.2.1.3 <code>sighand_struct</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.1.3_Signal_Blocking_and_Signal_Pending"><div class="tree-item-contents heading-link" heading-name="5.1.3 Signal Blocking and Signal Pending"><span class="tree-item-title">5.1.3 Signal Blocking and Signal Pending</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.3_Signal_Handling"><div class="tree-item-contents heading-link" heading-name="5.3 Signal Handling"><span class="tree-item-title">5.3 Signal Handling</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.4_Signal_Sending_and_Receiving"><div class="tree-item-contents heading-link" heading-name="5.4 Signal Sending and Receiving"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">5.4 Signal Sending and Receiving</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.4.1_Sending_a_Signal"><div class="tree-item-contents heading-link" heading-name="5.4.1 Sending a Signal"><span class="tree-item-title">5.4.1 Sending a Signal</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.4.2_Waiting_for_a_Signal_to_be_Caught"><div class="tree-item-contents heading-link" heading-name="5.4.2 Waiting for a Signal to be Caught"><span class="tree-item-title">5.4.2 Waiting for a Signal to be Caught</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.4.3_Receiving_a_Signal"><div class="tree-item-contents heading-link" heading-name="5.4.3 Receiving a Signal"><span class="tree-item-title">5.4.3 Receiving a Signal</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.1.4_Execution_of_Signal_Handler"><div class="tree-item-contents heading-link" heading-name="5.1.4 Execution of Signal Handler"><span class="tree-item-title">5.1.4 Execution of Signal Handler</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#5.2_Signal_Handling_in_Practice"><div class="tree-item-contents heading-link" heading-name="5.2 Signal Handling in Practice"><span class="tree-item-title">5.2 Signal Handling in Practice</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="congzhi's-os-series\6.5-inter-process-communications.html#The_Null_Signal"><div class="tree-item-contents heading-link" heading-name="The Null Signal"><span class="tree-item-title">The Null Signal</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>